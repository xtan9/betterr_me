---
phase: 17-fix-archive-restore-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/validations/project.ts
  - tests/lib/validations/project.test.ts
  - tests/app/api/projects/[id]/route.test.ts
autonomous: true
requirements:
  - PROJ-03

must_haves:
  truths:
    - "PATCH /api/projects/[id] with {status: 'archived'} succeeds (200) and returns the updated project"
    - "PATCH /api/projects/[id] with {status: 'active'} succeeds (200) and returns the restored project"
    - "PATCH /api/projects/[id] with {status: 'deleted'} is rejected (400) by Zod validation"
    - "Existing project update validations (name, color, section) continue to work unchanged"
    - "Empty body {} is still rejected by the non-empty refine guard"
  artifacts:
    - path: "lib/validations/project.ts"
      provides: "projectStatusSchema and extended projectUpdateSchema with status field"
      contains: "projectStatusSchema"
    - path: "tests/lib/validations/project.test.ts"
      provides: "Validation test coverage for project schemas"
      min_lines: 30
    - path: "tests/app/api/projects/[id]/route.test.ts"
      provides: "Archive and restore API route test cases"
      contains: "archive"
  key_links:
    - from: "lib/validations/project.ts"
      to: "app/api/projects/[id]/route.ts"
      via: "projectUpdateSchema import used in PATCH handler validateRequestBody call"
      pattern: "projectUpdateSchema"
---

<objective>
Fix the projectUpdateSchema to accept the `status` field, enabling project archive and restore flows.

Purpose: The `projectUpdateSchema` in `lib/validations/project.ts` is missing the `status` field, causing PATCH requests with `{status: "archived"}` or `{status: "active"}` to be rejected with HTTP 400. All other layers (DB, types, UI, SQL) already support the operation -- only the Zod validation gateway is blocking the flow.

Output: Fixed validation schema, new project validation test file, and archive/restore test cases in the existing API route test file.
</objective>

<execution_context>
@/home/xingdi/.claude/get-shit-done/workflows/execute-plan.md
@/home/xingdi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-fix-archive-restore-validation/17-RESEARCH.md

# Source files
@lib/validations/project.ts
@lib/validations/task.ts (precedent for .extend() pattern)
@app/api/projects/[id]/route.ts (PATCH handler consuming the schema)

# Existing test files (patterns to follow)
@tests/lib/validations/task.test.ts (validation test pattern)
@tests/app/api/projects/[id]/route.test.ts (API route test to extend)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend projectUpdateSchema with status field and create validation tests</name>
  <files>
    lib/validations/project.ts
    tests/lib/validations/project.test.ts
  </files>
  <action>
**1. Fix `lib/validations/project.ts`:**

Add `projectStatusSchema` export and extend `projectUpdateSchema` with the status field. The chain order MUST be `.partial()` -> `.extend()` -> `.refine()` (cannot call `.extend()` after `.refine()` because `.refine()` returns `ZodEffects`, not `ZodObject`).

```typescript
export const projectStatusSchema = z.enum(['active', 'archived']);

export const projectUpdateSchema = projectFormSchema
  .partial()
  .extend({ status: projectStatusSchema.optional() })
  .refine((data) => Object.keys(data).length > 0, {
    message: "At least one field must be provided",
  });
```

Also add a `ProjectUpdateValues` type export (already exists, verify it still works with the extended schema).

**2. Create `tests/lib/validations/project.test.ts`:**

Follow the pattern from `tests/lib/validations/task.test.ts`. Test both `projectFormSchema` and `projectUpdateSchema`:

For `projectFormSchema`:
- Accepts valid project data (name, section, color)
- Rejects missing name
- Rejects name exceeding 50 chars
- Rejects missing section
- Rejects invalid section value
- Rejects missing color

For `projectUpdateSchema`:
- Accepts `{status: 'archived'}` (the archive use case)
- Accepts `{status: 'active'}` (the restore use case)
- Accepts name-only update
- Accepts color-only update
- Accepts section-only update
- Accepts mixed fields (name + status)
- Rejects `{status: 'deleted'}` (invalid status value)
- Rejects `{status: 'pending'}` (invalid status value)
- Rejects empty body `{}` (non-empty refine guard)
- Rejects name exceeding 50 chars

For `projectStatusSchema`:
- Accepts 'active'
- Accepts 'archived'
- Rejects other strings
  </action>
  <verify>
Run `pnpm vitest run tests/lib/validations/project.test.ts` -- all tests pass.
Run `pnpm lint` -- no lint errors in modified files.
  </verify>
  <done>
projectUpdateSchema accepts status:'archived' and status:'active', rejects invalid status values, and all existing validation behaviors (name/color/section partial updates, empty body rejection) remain intact. Test file proves all cases.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add archive/restore test cases to the PATCH API route tests</name>
  <files>
    tests/app/api/projects/[id]/route.test.ts
  </files>
  <action>
Add archive and restore test cases to the existing `describe('PATCH /api/projects/[id]')` block in `tests/app/api/projects/[id]/route.test.ts`. Follow the existing test patterns in the file (mock setup, request construction, response assertions).

Add these test cases:

1. **"should archive a project"** -- Send `{status: 'archived'}` to PATCH, mock `updateProject` to return project with `status: 'archived'`. Assert 200 response, `data.project.status === 'archived'`, and `updateProject` called with `{status: 'archived'}`.

2. **"should restore an archived project"** -- Send `{status: 'active'}` to PATCH, mock `updateProject` to return project with `status: 'active'`. Assert 200 response, `data.project.status === 'active'`, and `updateProject` called with `{status: 'active'}`.

3. **"should reject invalid status value"** -- Send `{status: 'deleted'}` to PATCH. Assert 400 response (Zod validation rejects it). No `updateProject` call made.

Use the existing `mockProjectsDB.updateProject` mock and follow the same `NextRequest` construction pattern as the existing PATCH tests.
  </action>
  <verify>
Run `pnpm vitest run tests/app/api/projects/\\[id\\]/route.test.ts` -- all tests pass including new archive/restore cases.
Run `pnpm test:run` -- full test suite passes.
Run `pnpm build` -- production build succeeds.
  </verify>
  <done>
API route test file contains archive, restore, and invalid status test cases. The full test suite and production build pass, confirming the schema fix works end-to-end through the validation gateway.
  </done>
</task>

</tasks>

<verification>
1. `pnpm vitest run tests/lib/validations/project.test.ts` -- all validation tests pass
2. `pnpm vitest run tests/app/api/projects/\\[id\\]/route.test.ts` -- all API route tests pass (including new archive/restore)
3. `pnpm test:run` -- full Vitest suite passes (no regressions)
4. `pnpm build` -- production build succeeds
5. `pnpm lint` -- no lint errors
</verification>

<success_criteria>
- projectUpdateSchema.safeParse({status: 'archived'}) returns success:true
- projectUpdateSchema.safeParse({status: 'active'}) returns success:true
- projectUpdateSchema.safeParse({status: 'deleted'}) returns success:false
- projectUpdateSchema.safeParse({}) returns success:false (existing guard intact)
- All existing PATCH tests still pass (name, color, section updates)
- New archive/restore API route tests pass
- Full test suite green, build passes, lint clean
</success_criteria>

<output>
After completion, create `.planning/phases/17-fix-archive-restore-validation/17-01-SUMMARY.md`
</output>
