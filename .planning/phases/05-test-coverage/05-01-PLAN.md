---
phase: 05-test-coverage
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/app/api/habits/[id]/logs/route.test.ts
  - tests/app/api/habits/route.test.ts
autonomous: true

must_haves:
  truths:
    - "GET /api/habits/[id]/logs returns 401 for unauthenticated requests"
    - "GET /api/habits/[id]/logs returns 400 for invalid days param (0, -1, 366, NaN, non-numeric)"
    - "GET /api/habits/[id]/logs returns 400 for invalid date format ('not-a-date')"
    - "GET /api/habits/[id]/logs returns logs with correct response shape when params are valid"
    - "GET /api/habits/[id]/logs returns 500 when DB throws"
    - "Habit count limit test asserts 400 + error presence without locking the error message text"
  artifacts:
    - path: "tests/app/api/habits/[id]/logs/route.test.ts"
      provides: "Complete test coverage for GET /api/habits/[id]/logs route"
      min_lines: 150
    - path: "tests/app/api/habits/route.test.ts"
      provides: "Updated habit count limit test (unlocked message)"
  key_links:
    - from: "tests/app/api/habits/[id]/logs/route.test.ts"
      to: "app/api/habits/[id]/logs/route.ts"
      via: "imports GET handler"
      pattern: "import.*GET.*from.*logs/route"
---

<objective>
Create comprehensive unit tests for the GET /api/habits/[id]/logs API route and fix the existing habit count limit test to not lock the error message text.

Purpose: TEST-01 (logs route coverage) and TEST-03 (habit count limit assertion correction) are the API-route-level test requirements for Phase 5.
Output: New logs route test file, updated habits route test file.
</objective>

<execution_context>
@/home/xingdi/.claude/get-shit-done/workflows/execute-plan.md
@/home/xingdi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@app/api/habits/[id]/logs/route.ts
@tests/app/api/habits/route.test.ts
@tests/app/api/habits/[id]/route.test.ts
@lib/validations/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GET /api/habits/[id]/logs route tests</name>
  <files>tests/app/api/habits/[id]/logs/route.test.ts</files>
  <action>
Create a new test file following the established vi.hoisted + vi.mock pattern (see tests/app/api/habits/[id]/route.test.ts for reference).

Mock setup:
- vi.hoisted: `mockGetLogsByDateRange` (vi.fn())
- vi.mock('@/lib/supabase/server'): createClient returning auth.getUser with user { id: 'user-123' }
- vi.mock('@/lib/db'): HabitLogsDB class with getLogsByDateRange = mockGetLogsByDateRange
- vi.mock('@/lib/utils'): getLocalDateString returning '2026-02-16' (fixed date for predictable defaults)
- vi.mock('@/lib/logger'): log object with error/warn/info as vi.fn() (suppress output)
- Import createClient AFTER mocks for vi.mocked
- Use Promise.resolve({ id: 'habit-1' }) for params (Next.js 16 async params)

Top-level describe: `'GET /api/habits/[id]/logs'`

Nested describes and tests:

**describe('authentication')**:
- `it('should return 401 when user is not authenticated')` -- mock createClient with user: null. Assert status 401 and body `{ error: 'Unauthorized' }`. Add comment: "// Covers both no-session and expired-session (both result in user: null from getUser())"

**describe('days parameter validation')**:
- `it('should return 400 for days=0')` -- URL: `?days=0`, assert 400, error message 'Days must be between 1 and 365'
- `it('should return 400 for days=-1')` -- URL: `?days=-1`, assert 400
- `it('should return 400 for days=366')` -- URL: `?days=366`, assert 400
- `it('should return 400 for non-numeric days')` -- URL: `?days=abc`, assert 400
- `it('should accept days=1 (lower boundary)')` -- mock DB returns [], URL: `?days=1`, assert 200
- `it('should accept days=365 (upper boundary)')` -- mock DB returns [], URL: `?days=365`, assert 200

**describe('date format validation')**:
- `it('should return 400 for invalid start_date format')` -- URL: `?start_date=not-a-date`, assert 400, error contains 'Invalid date format'
- `it('should return 400 for invalid end_date format')` -- URL: `?start_date=2026-01-01&end_date=not-a-date`, assert 400
- `it('should accept semantically invalid but regex-valid date (2026-13-45)')` -- URL: `?start_date=2026-13-45`, mock DB returns []. Assert 200 (the route regex /^\d{4}-\d{2}-\d{2}$/ accepts this). Add comment: "// Route only validates format via regex, not semantic validity"

**describe('successful responses')**:
- `it('should return logs with correct response shape')` -- mock getLogsByDateRange returning 2 log objects, URL: `?start_date=2026-01-01&end_date=2026-01-31`. Assert 200, body has { logs: [...], startDate: '2026-01-01', endDate: '2026-01-31', count: 2 }
- `it('should use default 30 days when no params provided')` -- mock DB returns []. No query params. Assert 200, verify getLogsByDateRange was called (don't assert exact dates since getLocalDateString is mocked)
- `it('should use days param to compute start date')` -- URL: `?days=7`, mock DB returns []. Assert 200, verify getLogsByDateRange was called with habitId and userId
- `it('should use start_date and end_date when both provided')` -- URL: `?start_date=2026-01-01&end_date=2026-01-15`, mock DB returns []. Assert getLogsByDateRange called with ('habit-1', 'user-123', '2026-01-01', '2026-01-15')

**describe('error handling')**:
- `it('should return 500 when database throws')` -- mock getLogsByDateRange.mockRejectedValue(new Error('DB error')). URL: `?start_date=2026-01-01`. Assert 500, body `{ error: 'Failed to fetch logs' }`

Edge case tests within appropriate describes:
- `it('should return empty logs array when no logs exist')` -- mock DB returns []. Assert body.logs = [], body.count = 0
  </action>
  <verify>Run `pnpm vitest run tests/app/api/habits/[id]/logs/route.test.ts` -- all tests pass</verify>
  <done>New test file with 14+ tests covering authentication, days param validation (boundaries), date format validation (including semantically invalid dates), success paths, default behavior, and error handling. All tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Fix habit count limit test assertion</name>
  <files>tests/app/api/habits/route.test.ts</files>
  <action>
In `tests/app/api/habits/route.test.ts`, find the test at approximately line 388-404: "should return 400 when habit limit reached".

Current assertion (locks message text):
```typescript
expect(data.error).toContain('You have 20/20 habits');
```

Change to (per locked decision -- assert 400 + error presence, do NOT lock message text):
```typescript
expect(data.error).toBeDefined();
```

This honors the user decision: "Habit count limit test: assert 400 status + presence of error, but do not lock the specific error message text."

Do NOT change any other tests in this file. Do NOT add new tests.
  </action>
  <verify>Run `pnpm vitest run tests/app/api/habits/route.test.ts` -- all tests pass including the modified habit limit test</verify>
  <done>The habit count limit test asserts 400 status + error presence without locking the specific error message string.</done>
</task>

</tasks>

<verification>
```bash
# Run both test files
pnpm vitest run tests/app/api/habits/[id]/logs/route.test.ts tests/app/api/habits/route.test.ts

# Verify full test suite still passes
pnpm test:run

# Verify lint passes
pnpm lint
```
</verification>

<success_criteria>
- GET /api/habits/[id]/logs has comprehensive test coverage: auth, days param boundaries, date format validation, success paths, error handling
- Habit count limit test does not lock the error message text
- All tests in the project pass
- Lint passes
</success_criteria>

<output>
After completion, create `.planning/phases/05-test-coverage/05-01-SUMMARY.md`
</output>
