---
phase: 14-projects-sections
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260219000001_create_projects_table.sql
  - supabase/migrations/20260219000002_add_project_id_to_tasks.sql
  - lib/db/types.ts
  - lib/db/projects.ts
  - lib/db/index.ts
  - lib/projects/colors.ts
  - lib/validations/project.ts
  - lib/validations/task.ts
  - app/api/projects/route.ts
  - app/api/projects/[id]/route.ts
  - tests/lib/db/projects.test.ts
  - tests/app/api/projects/route.test.ts
  - tests/app/api/projects/[id]/route.test.ts
autonomous: true
requirements:
  - PROJ-01
  - PROJ-02
  - PROJ-03
  - PROJ-04

must_haves:
  truths:
    - "Project CRUD API endpoints accept and return project data with name, section, and color"
    - "Project validation rejects empty names and invalid section/color values"
    - "When a project is deleted, its tasks remain in the same section as standalone tasks"
    - "Archived projects are hidden from the default tasks view but accessible at /projects/archived"
  artifacts:
    - path: "supabase/migrations/20260219000001_create_projects_table.sql"
      provides: "Projects table with RLS policies"
      contains: "CREATE TABLE projects"
    - path: "supabase/migrations/20260219000002_add_project_id_to_tasks.sql"
      provides: "project_id FK on tasks table"
      contains: "ADD COLUMN project_id"
    - path: "lib/db/projects.ts"
      provides: "ProjectsDB class with CRUD methods"
      exports: ["ProjectsDB"]
    - path: "lib/projects/colors.ts"
      provides: "Preset color constants"
      exports: ["PROJECT_COLORS", "getProjectColor"]
    - path: "lib/validations/project.ts"
      provides: "Zod schemas for project forms"
      exports: ["projectFormSchema", "projectUpdateSchema"]
    - path: "app/api/projects/route.ts"
      provides: "GET (list) and POST (create) endpoints"
      exports: ["GET", "POST"]
    - path: "app/api/projects/[id]/route.ts"
      provides: "GET, PATCH, DELETE endpoints for single project"
      exports: ["GET", "PATCH", "DELETE"]
  key_links:
    - from: "app/api/projects/route.ts"
      to: "lib/db/projects.ts"
      via: "ProjectsDB instantiation"
      pattern: "new ProjectsDB\\(supabase\\)"
    - from: "lib/db/projects.ts"
      to: "lib/db/types.ts"
      via: "Project type import"
      pattern: "import.*Project.*from.*types"
    - from: "app/api/projects/route.ts"
      to: "lib/validations/project.ts"
      via: "Request body validation"
      pattern: "projectFormSchema"
---

<objective>
Create the data foundation for projects: SQL migrations, TypeScript types, ProjectsDB class, validation schemas, preset color constants, and RESTful API routes with tests.

Purpose: Establish the complete backend for project CRUD that UI plans (14-02, 14-03) will consume. This follows the existing codebase pattern of DB class + API routes + Zod validation.

Output: Two SQL migrations, ProjectsDB class, project validation schemas, color constants, GET/POST/PATCH/DELETE API routes, and comprehensive test coverage.
</objective>

<execution_context>
@/home/xingdi/.claude/get-shit-done/workflows/execute-plan.md
@/home/xingdi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-projects-sections/14-RESEARCH.md
@.planning/phases/13-data-foundation-migration/13-01-SUMMARY.md
@.planning/phases/13-data-foundation-migration/13-02-SUMMARY.md
@lib/db/types.ts
@lib/db/tasks.ts
@lib/db/index.ts
@lib/validations/task.ts
@app/api/tasks/route.ts
@app/api/tasks/[id]/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SQL migrations, types, color constants, and validation schemas</name>
  <files>
    supabase/migrations/20260219000001_create_projects_table.sql
    supabase/migrations/20260219000002_add_project_id_to_tasks.sql
    lib/db/types.ts
    lib/projects/colors.ts
    lib/validations/project.ts
    lib/validations/task.ts
  </files>
  <action>
    **Migration 1 — Create projects table** (`supabase/migrations/20260219000001_create_projects_table.sql`):
    Create the `projects` table exactly as specified in research:
    - Columns: `id` UUID PK (gen_random_uuid), `user_id` UUID FK → profiles(id) ON DELETE CASCADE NOT NULL, `name` TEXT NOT NULL, `section` TEXT NOT NULL DEFAULT 'personal' CHECK (section IN ('personal', 'work')), `color` TEXT NOT NULL DEFAULT 'blue', `status` TEXT NOT NULL DEFAULT 'active' CHECK (status IN ('active', 'archived')), `sort_order` DOUBLE PRECISION NOT NULL DEFAULT 0, `created_at` TIMESTAMPTZ DEFAULT NOW(), `updated_at` TIMESTAMPTZ DEFAULT NOW()
    - Indexes: `idx_projects_user_section` on (user_id, section) WHERE status = 'active'; `idx_projects_user_status` on (user_id, status)
    - RLS: Enable + 4 policies (SELECT, INSERT, UPDATE, DELETE) using `auth.uid() = user_id`
    - Updated_at trigger: Reuse existing `update_updated_at_column()` function

    **Migration 2 — Add project_id to tasks** (`supabase/migrations/20260219000002_add_project_id_to_tasks.sql`):
    - `ALTER TABLE tasks ADD COLUMN project_id UUID REFERENCES projects(id) ON DELETE SET NULL;`
    - Index: `idx_tasks_project_id` on tasks(project_id) WHERE project_id IS NOT NULL
    - Section CHECK constraint: `ALTER TABLE tasks ADD CONSTRAINT tasks_section_check CHECK (section IN ('personal', 'work'));`

    **Types** (`lib/db/types.ts`):
    Add to the file (after Task types section, before RECURRING TASKS section):
    - `ProjectSection = 'personal' | 'work'` type
    - `ProjectStatus = 'active' | 'archived'` type
    - `Project` interface: id, user_id, name, section (ProjectSection), color, status (ProjectStatus), sort_order, created_at, updated_at
    - `ProjectInsert` type: Omit id, created_at, updated_at; make sort_order optional
    - `ProjectUpdate` type: Partial of name, section, color, status, sort_order
    - Add `project_id: string | null` to existing `Task` interface
    - Add `project_id?: string | null` to existing `TaskInsert` type
    - Add `project_id?: string | null` to existing `TaskFilters` interface
    - Change `TaskSection` from `string` to `'personal' | 'work'` (Phase 14 now defines the exact values)

    **Color constants** (`lib/projects/colors.ts`):
    Create new file with 12 preset colors exactly as in research:
    - `ProjectColor` interface: key, label, hsl, hslDark
    - `PROJECT_COLORS` array: blue, red, green, orange, purple, pink, teal, yellow, indigo, cyan, slate, emerald — each with light and dark HSL values
    - `getProjectColor(key: string): ProjectColor` helper (returns first color as fallback)

    **Project validation** (`lib/validations/project.ts`):
    Create new file:
    - `projectSectionSchema = z.enum(['personal', 'work'])`
    - `projectFormSchema = z.object({ name: z.string().trim().min(1).max(50), section: projectSectionSchema, color: z.string().min(1) })`
    - `ProjectFormValues` type inferred from schema
    - `projectUpdateSchema = projectFormSchema.partial().refine(data => Object.keys(data).length > 0, { message: 'At least one field must be provided' })`

    **Task validation extension** (`lib/validations/task.ts`):
    - Add `section: z.enum(['personal', 'work']).optional()` to `taskFormSchema`
    - Add `project_id: z.string().uuid().nullable().optional()` to `taskFormSchema`
    - In `taskUpdateSchema.extend({...})`, change the existing `section: z.string().optional()` to `section: z.enum(['personal', 'work']).optional()` so it matches the narrowed enum type from `taskFormSchema`. The `.extend()` override currently uses `z.string()` which would allow any string, creating a type mismatch with the enum.
    - Add `project_id: z.string().uuid().nullable().optional()` to `taskUpdateSchema.extend({...})` if not already present
  </action>
  <verify>
    - `pnpm lint` passes with no new errors
    - `pnpm test:run` passes (types are backward-compatible)
    - Both migration SQL files exist and have valid SQL syntax
    - `lib/projects/colors.ts` exports PROJECT_COLORS with 12 entries
    - `lib/validations/project.ts` exports projectFormSchema and projectUpdateSchema
  </verify>
  <done>
    SQL migrations ready to apply, Project/ProjectInsert/ProjectUpdate types defined in types.ts, Task type includes project_id, 12 preset colors with light/dark HSL values defined, validation schemas enforce name 1-50 chars and valid section/color values, all existing tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ProjectsDB class and API routes with tests</name>
  <files>
    lib/db/projects.ts
    lib/db/index.ts
    app/api/projects/route.ts
    app/api/projects/[id]/route.ts
    tests/lib/db/projects.test.ts
    tests/app/api/projects/route.test.ts
    tests/app/api/projects/[id]/route.test.ts
  </files>
  <action>
    **ProjectsDB class** (`lib/db/projects.ts`):
    Follow exact pattern from `lib/db/tasks.ts`:
    - Constructor takes `SupabaseClient`
    - `getUserProjects(userId, filters?: { section?: string; status?: string })`: Query projects table, default status='active', order by sort_order asc. Return `Project[]`.
    - `getProject(projectId, userId)`: Single project by ID + user_id. Return `Project | null`. Handle PGRST116 error code for not-found (return null).
    - `createProject(project: ProjectInsert)`: Insert and return created `Project`. Use `.select().single()` to return the created row.
    - `updateProject(projectId, userId, updates: ProjectUpdate)`: Update matching project. Return updated `Project`. Throw if not found.
    - `archiveProject(projectId, userId)`: Shorthand for `updateProject(id, userId, { status: 'archived' })`.
    - `deleteProject(projectId, userId)`: Delete matching project. Tasks with this project_id get ON DELETE SET NULL automatically from FK.

    **Barrel export** (`lib/db/index.ts`):
    Add `export * from "./projects";` after the tasks export line.

    **API route: GET/POST** (`app/api/projects/route.ts`):
    Follow exact pattern from `app/api/tasks/route.ts`:
    - GET: Auth check → instantiate ProjectsDB → read `section` and `status` query params → call getUserProjects → return `{ projects }`.
    - POST: Auth check → parse body → validate with projectFormSchema → ensureProfile → instantiate ProjectsDB → createProject with user_id, trimmed name, section, color → return `{ project }` with status 201.
    - Wrap both in try/catch → console.error → 500 response.

    **API route: GET/PATCH/DELETE** (`app/api/projects/[id]/route.ts`):
    Follow exact pattern from `app/api/tasks/[id]/route.ts`:
    - GET: Auth check → ProjectsDB.getProject → 404 if null → return `{ project }`.
    - PATCH: Auth check → parse body → validate with projectUpdateSchema → ProjectsDB.updateProject → return `{ project }`.
    - DELETE: Auth check → ProjectsDB.deleteProject → return `{ success: true }`.
    - All wrapped in try/catch with appropriate error logging.
    - Route params: `{ params }: { params: Promise<{ id: string }> }` (Next.js 16 async params pattern — use `const { id } = await params;`).

    **Tests — ProjectsDB** (`tests/lib/db/projects.test.ts`):
    Follow pattern from `tests/lib/db/tasks.test.ts`:
    - Use mockSupabaseClient from tests/setup.ts
    - Test getUserProjects: returns projects, filters by section, defaults to active status
    - Test getProject: returns project, returns null for not-found
    - Test createProject: calls insert with correct data
    - Test updateProject: calls update with correct filters
    - Test deleteProject: calls delete with correct filters
    - Test archiveProject: delegates to updateProject with status='archived'

    **Tests — API routes** (`tests/app/api/projects/route.test.ts`, `tests/app/api/projects/[id]/route.test.ts`):
    Follow pattern from `tests/app/api/tasks/route.test.ts`:
    - Use vi.hoisted + vi.mock pattern for ProjectsDB
    - Test GET: returns projects, filters by query params, 401 for unauthenticated
    - Test POST: creates project, validates body, 400 for invalid data, 401 for unauthenticated
    - Test GET [id]: returns project, 404 for not-found, 401 for unauthenticated
    - Test PATCH [id]: updates project, validates body, 401 for unauthenticated
    - Test DELETE [id]: deletes project, 401 for unauthenticated
  </action>
  <verify>
    - `pnpm test:run -- tests/lib/db/projects.test.ts` passes
    - `pnpm test:run -- tests/app/api/projects/route.test.ts` passes
    - `pnpm test:run -- "tests/app/api/projects/\\[id\\]/route.test.ts"` passes
    - `pnpm test:run` full suite passes with no regressions
    - `pnpm lint` passes with no new errors
  </verify>
  <done>
    ProjectsDB class with 6 methods (getUserProjects, getProject, createProject, updateProject, archiveProject, deleteProject) exported from lib/db/index.ts. GET/POST /api/projects and GET/PATCH/DELETE /api/projects/[id] endpoints working with validation, auth checks, and error handling. All new tests pass and no regressions in existing test suite.
  </done>
</task>

</tasks>

<verification>
- `pnpm test:run` — all tests pass (existing + new project tests)
- `pnpm lint` — zero new lint errors
- SQL migration files have correct syntax and correct ordering (projects table before project_id FK)
- ProjectsDB follows same constructor/method pattern as TasksDB
- API routes follow same auth/validation/error-handling pattern as task routes
- Types are backward-compatible (project_id is optional/nullable on Task)
</verification>

<success_criteria>
- Two SQL migration files exist with correct table/column definitions and RLS policies
- Project type system (Project, ProjectInsert, ProjectUpdate, ProjectSection, ProjectStatus) fully defined
- 12 preset colors defined with light/dark HSL values
- ProjectsDB class with full CRUD + archive
- API routes for project list, create, read, update, delete
- Validation schemas reject invalid input
- All tests (new + existing) pass
</success_criteria>

<output>
After completion, create `.planning/phases/14-projects-sections/14-01-SUMMARY.md`
</output>
