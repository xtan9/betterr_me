---
phase: 07-sidebar-enrichment
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - components/layouts/sidebar-user-footer.tsx
  - components/layouts/app-sidebar.tsx
  - tests/components/layouts/sidebar-user-footer.test.tsx
  - i18n/messages/en.json
  - i18n/messages/zh.json
  - i18n/messages/zh-TW.json
autonomous: true
requirements: [SIDE-05, VISL-09]

must_haves:
  truths:
    - "User avatar, name, and email appear in the sidebar footer"
    - "Clicking the footer opens a dropdown with Settings link, theme options, language options, and Log out"
    - "In icon (collapsed) mode, only the avatar is visible and clicking it opens the dropdown"
    - "Theme change takes effect immediately without page reload"
    - "Language change sets cookie and reloads page"
    - "Log out signs user out and redirects to /auth/login"
  artifacts:
    - path: "components/layouts/sidebar-user-footer.tsx"
      provides: "User profile footer with account dropdown containing theme/language switchers and logout"
      min_lines: 80
    - path: "tests/components/layouts/sidebar-user-footer.test.tsx"
      provides: "Tests for sidebar user footer component"
      min_lines: 40
  key_links:
    - from: "components/layouts/sidebar-user-footer.tsx"
      to: "/api/profile"
      via: "SWR fetch for profile data"
      pattern: "useSWR.*api/profile"
    - from: "components/layouts/sidebar-user-footer.tsx"
      to: "next-themes"
      via: "useTheme hook for theme switching"
      pattern: "useTheme"
    - from: "components/layouts/sidebar-user-footer.tsx"
      to: "supabase auth"
      via: "signOut for logout action"
      pattern: "signOut"
    - from: "components/layouts/app-sidebar.tsx"
      to: "components/layouts/sidebar-user-footer.tsx"
      via: "import and render in SidebarFooter"
      pattern: "SidebarUserFooter"
---

<objective>
Create the SidebarUserFooter component with user avatar, name, and an account dropdown containing Settings link, theme/language switchers, and logout action. Integrate it into the AppSidebar footer.

Purpose: Provides user identity and account controls in the sidebar per SIDE-05 and VISL-09, making theme and language switchers accessible in the authenticated app for the first time.
Output: New SidebarUserFooter component, integrated into AppSidebar, with tests and i18n strings.
</objective>

<execution_context>
@/home/xingdi/.claude/get-shit-done/workflows/execute-plan.md
@/home/xingdi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-sidebar-enrichment/07-RESEARCH.md
@.planning/phases/07-sidebar-enrichment/07-01-SUMMARY.md
@components/layouts/app-sidebar.tsx
@components/theme-switcher.tsx
@components/language-switcher.tsx
@components/logout-button.tsx
@app/api/profile/route.ts
@i18n/messages/en.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SidebarUserFooter component with account dropdown</name>
  <files>
    components/layouts/sidebar-user-footer.tsx
    components/layouts/app-sidebar.tsx
    i18n/messages/en.json
    i18n/messages/zh.json
    i18n/messages/zh-TW.json
  </files>
  <action>
Create `components/layouts/sidebar-user-footer.tsx` as a `"use client"` component:

1. **Imports:** `useSWR` from `swr`, `useTheme` from `next-themes`, `useLocale` from `next-intl`, `useTranslations` from `next-intl`, `useRouter` from `next/navigation`, `createClient` from `@/lib/supabase/client`, `Avatar`/`AvatarImage`/`AvatarFallback` from `@/components/ui/avatar`, `DropdownMenu`/`DropdownMenuContent`/`DropdownMenuTrigger`/`DropdownMenuItem`/`DropdownMenuSeparator`/`DropdownMenuLabel`/`DropdownMenuRadioGroup`/`DropdownMenuRadioItem` from `@/components/ui/dropdown-menu`, `SidebarMenu`/`SidebarMenuItem`/`SidebarMenuButton` from `@/components/ui/sidebar`, `ChevronsUpDown`/`Settings`/`LogOut`/`Sun`/`Moon`/`Laptop`/`Languages` icons from `lucide-react`, `Link` from `next/link`. Also `useSidebar` from `@/components/ui/sidebar` for state detection. Import `useEffect`, `useState` from `react` for hydration guard on theme.

2. **Profile data fetcher:** Define `const fetcher = (url: string) => fetch(url).then(r => r.json())`. Use `useSWR<{ profile: { full_name: string | null; avatar_url: string | null; email: string } }>('/api/profile', fetcher)`.

3. **Theme integration:** Use `const { theme, setTheme } = useTheme()`. Add a `mounted` state with `useEffect` hydration guard (same pattern as existing `ThemeSwitcher`). Render theme options as `DropdownMenuRadioGroup` with value=`theme` and onValueChange=`setTheme`, with three `DropdownMenuRadioItem` entries for "light", "dark", "system" (each with Sun/Moon/Laptop icon + translated label).

4. **Language integration:** Use `const locale = useLocale()`. Define locales array: `[{ code: 'en', name: 'English' }, { code: 'zh', name: '简体中文' }, { code: 'zh-TW', name: '繁體中文' }]`. On language change, set cookie `locale={code}; path=/; max-age=31536000` then `window.location.reload()`.

5. **Logout:** `const router = useRouter()`. Logout handler: `const supabase = createClient(); await supabase.auth.signOut(); router.push("/auth/login");`.

6. **Avatar initials:** Derive from `full_name` -- take first letter of first and last name. Fallback to first letter of email if no name.

7. **Render structure** following the shadcn sidebar footer pattern:
   ```tsx
   <SidebarMenu>
     <SidebarMenuItem>
       <DropdownMenu>
         <DropdownMenuTrigger asChild>
           <SidebarMenuButton size="lg" className="data-[state=open]:bg-sidebar-accent data-[state=open]:text-sidebar-accent-foreground">
             <Avatar className="h-8 w-8 rounded-lg">
               <AvatarImage src={profile?.avatar_url ?? undefined} alt={profile?.full_name ?? ""} />
               <AvatarFallback className="rounded-lg">{initials}</AvatarFallback>
             </Avatar>
             <div className="grid flex-1 text-left text-sm leading-tight">
               <span className="truncate font-semibold">{profile?.full_name || profile?.email}</span>
               <span className="truncate text-xs text-muted-foreground">{profile?.email}</span>
             </div>
             <ChevronsUpDown className="ml-auto size-4" />
           </SidebarMenuButton>
         </DropdownMenuTrigger>
         <DropdownMenuContent
           className="w-[--radix-dropdown-menu-trigger-width] min-w-56 rounded-lg"
           side="top"
           align="end"
           sideOffset={4}
         >
           <DropdownMenuLabel className="p-0 font-normal">
             <div className="flex items-center gap-2 px-1 py-1.5 text-left text-sm">
               <Avatar className="h-8 w-8 rounded-lg">
                 <AvatarImage src={...} alt={...} />
                 <AvatarFallback className="rounded-lg">{initials}</AvatarFallback>
               </Avatar>
               <div className="grid flex-1 text-left text-sm leading-tight">
                 <span className="truncate font-semibold">{name}</span>
                 <span className="truncate text-xs text-muted-foreground">{email}</span>
               </div>
             </div>
           </DropdownMenuLabel>
           <DropdownMenuSeparator />
           <DropdownMenuItem asChild>
             <Link href="/dashboard/settings">
               <Settings className="mr-2 size-4" />
               {t("settings")}
             </Link>
           </DropdownMenuItem>
           <DropdownMenuSeparator />
           {/* Theme section */}
           <DropdownMenuLabel>{tSidebar("theme")}</DropdownMenuLabel>
           <DropdownMenuRadioGroup value={theme} onValueChange={setTheme}>
             <DropdownMenuRadioItem value="light">
               <Sun className="mr-2 size-4" /> {tSidebar("themeLight")}
             </DropdownMenuRadioItem>
             <DropdownMenuRadioItem value="dark">
               <Moon className="mr-2 size-4" /> {tSidebar("themeDark")}
             </DropdownMenuRadioItem>
             <DropdownMenuRadioItem value="system">
               <Laptop className="mr-2 size-4" /> {tSidebar("themeSystem")}
             </DropdownMenuRadioItem>
           </DropdownMenuRadioGroup>
           <DropdownMenuSeparator />
           {/* Language section */}
           <DropdownMenuLabel>{tSidebar("language")}</DropdownMenuLabel>
           {locales.map(item => (
             <DropdownMenuItem key={item.code} onClick={() => handleLocaleChange(item.code)} className={locale === item.code ? "font-semibold" : ""}>
               <Languages className="mr-2 size-4" /> {item.name}
             </DropdownMenuItem>
           ))}
           <DropdownMenuSeparator />
           <DropdownMenuItem onClick={handleSignOut}>
             <LogOut className="mr-2 size-4" />
             {tSidebar("logOut")}
           </DropdownMenuItem>
         </DropdownMenuContent>
       </DropdownMenu>
     </SidebarMenuItem>
   </SidebarMenu>
   ```

8. **Loading state:** While SWR is loading (`!data`), show a skeleton: Avatar with "?" fallback, "Loading..." text. Use the same structure but with placeholder content.

9. **Integrate into AppSidebar:** In `app-sidebar.tsx`, import `SidebarUserFooter` and replace the empty `<SidebarFooter />` with:
   ```tsx
   <SidebarFooter>
     <SidebarUserFooter />
   </SidebarFooter>
   ```

10. **i18n keys** -- add under `common.sidebar` in all three locale files:
    - en.json: `"myAccount": "My Account"`, `"logOut": "Log out"`, `"theme": "Theme"`, `"language": "Language"`, `"themeLight": "Light"`, `"themeDark": "Dark"`, `"themeSystem": "System"`
    - zh.json: `"myAccount": "我的账户"`, `"logOut": "退出登录"`, `"theme": "主题"`, `"language": "语言"`, `"themeLight": "浅色"`, `"themeDark": "深色"`, `"themeSystem": "跟随系统"`
    - zh-TW.json: `"myAccount": "我的帳戶"`, `"logOut": "登出"`, `"theme": "主題"`, `"language": "語言"`, `"themeLight": "淺色"`, `"themeDark": "深色"`, `"themeSystem": "跟隨系統"`

Note: The `t` for nav translations uses `useTranslations("common.nav")` which already has `"settings"`. The `tSidebar` uses `useTranslations("common.sidebar")` for the new keys.
  </action>
  <verify>
Run `pnpm build` to confirm no TypeScript/build errors. Run `pnpm lint` for lint compliance.
  </verify>
  <done>
SidebarUserFooter component renders avatar + name + email in sidebar footer. Dropdown opens with Settings link, theme radio group, language options, and logout. Theme changes apply immediately. Language changes set cookie and reload. AppSidebar footer renders SidebarUserFooter. All i18n keys present in 3 locales.
  </done>
</task>

<task type="auto">
  <name>Task 2: Write tests for SidebarUserFooter component</name>
  <files>
    tests/components/layouts/sidebar-user-footer.test.tsx
  </files>
  <action>
Create `tests/components/layouts/sidebar-user-footer.test.tsx`:

1. **Mocks setup:**
   - Mock `swr`: `vi.mock("swr", ...)` with a controllable `mockSWRReturn` that returns `{ data, error, isLoading }`. Default data: `{ profile: { full_name: "Jane Doe", avatar_url: null, email: "jane@example.com" } }`.
   - Mock `next-intl`: `vi.mock("next-intl", () => ({ useTranslations: () => (key: string) => key, useLocale: () => "en" }))`.
   - Mock `next-themes`: `vi.mock("next-themes", () => ({ useTheme: () => ({ theme: "system", setTheme: mockSetTheme }) }))` with `mockSetTheme = vi.fn()`.
   - Mock `next/navigation`: `vi.mock("next/navigation", () => ({ useRouter: () => ({ push: mockPush }) }))` with `mockPush = vi.fn()`.
   - Mock `@/lib/supabase/client`: `vi.mock("@/lib/supabase/client", () => ({ createClient: () => ({ auth: { signOut: mockSignOut } }) }))` with `mockSignOut = vi.fn().mockResolvedValue({})`.
   - Mock `@/components/ui/sidebar`: Same pattern as app-sidebar.test.tsx -- simplified HTML elements. `SidebarMenu` -> `ul`, `SidebarMenuItem` -> `li`, `SidebarMenuButton` -> `button` (ignoring `size`, `asChild`).
   - Mock `@/components/ui/avatar`: `Avatar` -> `div`, `AvatarImage` -> `img` (if src provided), `AvatarFallback` -> `span`.
   - Mock `@/components/ui/dropdown-menu`: Simplified elements -- `DropdownMenu` -> `div`, `DropdownMenuTrigger` -> passthrough (asChild), `DropdownMenuContent` -> `div`, `DropdownMenuItem` -> `button` (with onClick), `DropdownMenuLabel` -> `span`, `DropdownMenuSeparator` -> `hr`, `DropdownMenuRadioGroup` -> `div` (passing value/onValueChange to context or simplified), `DropdownMenuRadioItem` -> `button` (with onClick calling parent's onValueChange).

   NOTE: DropdownMenu mocking is tricky. The simplest approach: `DropdownMenuRadioGroup` renders children with a data attribute, and `DropdownMenuRadioItem` renders a button that on click calls the group's `onValueChange`. Since this is hard to wire in mocks, a simpler approach: mock `DropdownMenuRadioGroup` to store `onValueChange` in a ref/closure, and `DropdownMenuRadioItem` to call it with its `value` on click. Alternatively, just render all items as visible and test click handlers directly.

2. **Tests:**
   - "renders user name and email when profile loaded": Assert "Jane Doe" and "jane@example.com" visible.
   - "renders avatar fallback initials": Assert "JD" fallback text visible (from "Jane Doe").
   - "renders loading state when profile not loaded": Set SWR data to undefined/isLoading. Assert loading indicator visible.
   - "renders settings link in dropdown": Assert a link with href "/dashboard/settings" exists and has text "settings" (i18n key).
   - "calls signOut and redirects on logout click": Find the logout button (by text "logOut"), click it, assert `mockSignOut` called, assert `mockPush` called with "/auth/login".
   - "renders theme options": Assert "themeLight", "themeDark", "themeSystem" text visible.
   - "renders language options": Assert "English", "简体中文", "繁體中文" text visible.

Run `pnpm test:run -- tests/components/layouts/sidebar-user-footer.test.tsx` and `pnpm lint`.
  </action>
  <verify>
Run `pnpm test:run -- tests/components/layouts/sidebar-user-footer.test.tsx` -- all tests pass. Run `pnpm lint` -- no errors. Run `pnpm test:run -- tests/components/layouts/app-sidebar.test.tsx` -- existing tests still pass.
  </verify>
  <done>
SidebarUserFooter has a test suite covering: profile display (name, email, avatar initials), loading state, settings link, logout (signOut + redirect), theme options rendering, and language options rendering. All tests pass and existing AppSidebar tests unaffected.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` succeeds
2. `pnpm test:run -- tests/components/layouts/sidebar-user-footer.test.tsx` -- all pass
3. `pnpm test:run -- tests/components/layouts/app-sidebar.test.tsx` -- all pass
4. `pnpm lint` -- no errors
5. SidebarUserFooter shows avatar, name, email, and dropdown with Settings/theme/language/logout
</verification>

<success_criteria>
- User profile (avatar, name, email) visible in sidebar footer
- Dropdown menu contains Settings link, theme switcher (Light/Dark/System), language switcher (3 locales), and Log out
- Theme change immediate, language change reloads page
- Logout calls supabase.auth.signOut() and redirects to /auth/login
- Tests cover all key behaviors
- i18n strings in all 3 locales
</success_criteria>

<output>
After completion, create `.planning/phases/07-sidebar-enrichment/07-02-SUMMARY.md`
</output>
