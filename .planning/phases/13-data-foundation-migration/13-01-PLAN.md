---
phase: 13-data-foundation-migration
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - lib/db/types.ts
  - lib/validations/task.ts
  - lib/tasks/sync.ts
  - lib/tasks/sort-order.ts
  - tests/lib/tasks/sync.test.ts
  - tests/lib/tasks/sort-order.test.ts
  - supabase/migrations/20260218000001_add_task_status_section_sort_order.sql
autonomous: true
requirements:
  - DATA-01
  - DATA-02

must_haves:
  truths:
    - "TaskStatus type constrains status to exactly four values: backlog, todo, in_progress, done"
    - "syncTaskCreate returns consistent status + is_completed + completed_at for any input combination"
    - "syncTaskUpdate keeps status and is_completed in sync when either field changes"
    - "Reopened tasks (done -> incomplete) always reset to status=todo"
    - "getBottomSortOrder returns currentMax + 65536.0 for new tasks"
    - "Migration SQL adds status, section, and sort_order columns with correct defaults and constraints"
  artifacts:
    - path: "lib/tasks/sync.ts"
      provides: "Bidirectional status/is_completed sync functions"
      exports: ["syncTaskCreate", "syncTaskUpdate"]
    - path: "lib/tasks/sort-order.ts"
      provides: "Float-based sort order utilities"
      exports: ["getBottomSortOrder", "getSortOrderBetween", "SORT_ORDER_GAP"]
    - path: "lib/db/types.ts"
      provides: "TaskStatus type, updated Task/TaskInsert/TaskUpdate interfaces"
      contains: "TaskStatus"
    - path: "lib/validations/task.ts"
      provides: "Zod schema for task status validation"
      contains: "taskStatusSchema"
    - path: "supabase/migrations/20260218000001_add_task_status_section_sort_order.sql"
      provides: "Database migration for new columns"
      contains: "ALTER TABLE tasks ADD COLUMN status"
  key_links:
    - from: "lib/tasks/sync.ts"
      to: "lib/db/types.ts"
      via: "imports TaskStatus, TaskUpdate, TaskInsert types"
      pattern: "import.*from.*@/lib/db/types"
    - from: "lib/validations/task.ts"
      to: "lib/db/types.ts"
      via: "taskStatusSchema enum values match TaskStatus type"
      pattern: "z\\.enum.*backlog.*todo.*in_progress.*done"
---

<objective>
Create the type foundation, sync utility, sort-order utility, and migration SQL for the task status/section/sort_order data model.

Purpose: Establish the pure-function sync layer that keeps `is_completed` and `status` bidirectionally consistent, plus the sort-order utilities for float-based ordering. TDD approach for the sync functions ensures every combination of inputs produces correct output before wiring into the codebase.

Output: Type definitions, validated sync + sort-order utilities with full test coverage, and migration SQL ready to run.
</objective>

<execution_context>
@/home/xingdi/.claude/get-shit-done/workflows/execute-plan.md
@/home/xingdi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-data-foundation-migration/13-RESEARCH.md

@lib/db/types.ts
@lib/validations/task.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add type definitions and validation schemas for task status, section, and sort_order</name>
  <files>lib/db/types.ts, lib/validations/task.ts</files>
  <action>
In `lib/db/types.ts`:
1. Add `TaskStatus` type alias after the `TaskCategory` type:
   ```typescript
   export type TaskStatus = 'backlog' | 'todo' | 'in_progress' | 'done';
   export type TaskSection = string; // 'personal' for Phase 13, extensible in Phase 14
   ```
2. Add three fields to the `Task` interface (after `completed_at`):
   - `status: TaskStatus;`
   - `section: TaskSection;`
   - `sort_order: number;`
3. Update `TaskInsert` to include the new fields as optional:
   - Add `status?: TaskStatus;` to the intersection type's optional fields
   - Add `section?: TaskSection;`
   - Add `sort_order?: number;`
4. `TaskUpdate` is `Partial<Omit<Task, ...>>` so it automatically inherits the new fields. No change needed.
5. Optionally add `status?: TaskStatus;` to the `TaskFilters` interface for forward compatibility.

In `lib/validations/task.ts`:
1. Add `taskStatusSchema`:
   ```typescript
   export const taskStatusSchema = z.enum(['backlog', 'todo', 'in_progress', 'done']);
   ```
2. Add optional fields to `taskFormSchema`:
   - `status: taskStatusSchema.optional()` — forward compat, accept but don't require
3. Add optional fields to `taskUpdateSchema`'s `.extend()`:
   - `status: taskStatusSchema.optional()`
   - `section: z.string().optional()`
   - `sort_order: z.number().optional()`

Run `pnpm lint` to verify no type errors.
  </action>
  <verify>
Run `pnpm lint` — no errors. TypeScript compilation succeeds with the new types. Existing tests that reference Task type still compile (they'll get the new optional fields).
  </verify>
  <done>
TaskStatus type exists with exactly 4 values. Task interface has status, section, sort_order fields. TaskInsert allows optional new fields. Zod validation schemas accept status/section/sort_order. All existing code still compiles.
  </done>
</task>

<task type="auto">
  <name>Task 2: TDD — Create sync utility and sort-order utility with tests</name>
  <files>lib/tasks/sync.ts, lib/tasks/sort-order.ts, tests/lib/tasks/sync.test.ts, tests/lib/tasks/sort-order.test.ts</files>
  <action>
**RED phase — Write failing tests first:**

Create `tests/lib/tasks/sync.test.ts` with these test cases for `syncTaskCreate`:
1. No status provided → defaults to `status: 'todo'`, `is_completed: false`, `completed_at: null`
2. `status: 'done'` provided → `is_completed: true`, `completed_at` is a timestamp string
3. `status: 'backlog'` provided → `is_completed: false`, `completed_at: null`
4. `status: 'in_progress'` provided → `is_completed: false`, `completed_at: null`
5. No section provided → defaults to `section: 'personal'`
6. Section provided → uses provided section
7. All other input fields are preserved in output

Test cases for `syncTaskUpdate`:
1. Only `status: 'done'` → sets `is_completed: true`, `completed_at` timestamp
2. Only `status: 'todo'` → sets `is_completed: false`, `completed_at: null`
3. Only `status: 'backlog'` → sets `is_completed: false`, `completed_at: null`
4. Only `status: 'in_progress'` → sets `is_completed: false`, `completed_at: null`
5. Only `is_completed: true` → sets `status: 'done'`, `completed_at` timestamp
6. Only `is_completed: false` → sets `status: 'todo'`, `completed_at: null` (reopened = always todo, locked decision)
7. Both `status: 'done'` and `is_completed: false` → status wins: `is_completed: true`, `completed_at` timestamp
8. Both `status: 'todo'` and `is_completed: true` → status wins: `is_completed: false`, `completed_at: null`
9. Neither status nor is_completed → returns input unchanged
10. Only `title` changed (no status/is_completed) → returns input unchanged

Create `tests/lib/tasks/sort-order.test.ts` with these test cases:
1. `getBottomSortOrder(null)` → returns `65536.0`
2. `getBottomSortOrder(0)` → returns `65536.0`
3. `getBottomSortOrder(65536.0)` → returns `131072.0`
4. `getSortOrderBetween(0, 65536.0)` → returns `32768.0`
5. `getSortOrderBetween(65536.0, 131072.0)` → returns `98304.0`
6. `SORT_ORDER_GAP` equals `65536.0`

Run tests — they must ALL FAIL (modules don't exist yet).

**GREEN phase — Implement minimum code to pass:**

Create `lib/tasks/sync.ts` following the pattern from research (see 13-RESEARCH.md Pattern 1). Key implementation details:
- `syncTaskCreate(input: TaskInsert)` — returns `TaskInsert` with status, section, is_completed, completed_at all consistent. Default status=todo, default section=personal.
- `syncTaskUpdate(updates: TaskUpdate)` — returns `TaskUpdate` with status/is_completed/completed_at synced. Three cases: (1) only status changed, (2) only is_completed changed, (3) both changed (status wins). If neither changed, return unchanged.
- Use `new Date().toISOString()` for completed_at timestamps.

Create `lib/tasks/sort-order.ts` following research Pattern 2:
- `SORT_ORDER_GAP = 65536.0`
- `getBottomSortOrder(currentMax: number | null): number` — returns `(currentMax ?? 0) + SORT_ORDER_GAP`
- `getSortOrderBetween(above: number, below: number): number` — returns `(above + below) / 2`

Run tests — they must ALL PASS.

**REFACTOR phase:** Clean up if needed. Ensure exports are clean.
  </action>
  <verify>
Run `pnpm test:run -- tests/lib/tasks/sync.test.ts tests/lib/tasks/sort-order.test.ts` — all tests pass. Run `pnpm lint` — no errors.
  </verify>
  <done>
syncTaskCreate and syncTaskUpdate handle every combination of status/is_completed input correctly. Sort-order utilities compute correct float values. All sync tests pass covering: default creation, explicit status creation, status-only updates, is_completed-only updates, both-provided updates (status wins), reopened-task reset to todo, and no-change passthrough.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create migration SQL for status, section, and sort_order columns</name>
  <files>supabase/migrations/20260218000001_add_task_status_section_sort_order.sql</files>
  <action>
Create `supabase/migrations/20260218000001_add_task_status_section_sort_order.sql` with:

```sql
-- Phase 13: Data Foundation & Migration
-- Adds status, section, sort_order columns to tasks table
-- Migrates existing data: is_completed=true -> status=done, is_completed=false -> status=todo
-- Seeds sort_order by creation date (oldest = lowest = top of column)

-- Step 1: Add columns with defaults
-- PostgreSQL 11+ handles ADD COLUMN ... DEFAULT NOT NULL as metadata-only (no table rewrite)
ALTER TABLE tasks ADD COLUMN status TEXT NOT NULL DEFAULT 'todo'
  CHECK (status IN ('backlog', 'todo', 'in_progress', 'done'));
ALTER TABLE tasks ADD COLUMN section TEXT NOT NULL DEFAULT 'personal';
ALTER TABLE tasks ADD COLUMN sort_order DOUBLE PRECISION NOT NULL DEFAULT 0;

-- Step 2: Sync status from is_completed for existing completed tasks
-- Default 'todo' already handles is_completed=false tasks (Claude's discretion: 'todo' chosen
-- for UX consistency — existing incomplete tasks are active/actionable, matching kanban convention)
UPDATE tasks SET status = 'done' WHERE is_completed = true;

-- Step 3: Seed sort_order by creation date (oldest = lowest = top of column)
-- Uses ROW_NUMBER per user with GAP spacing (65536.0) for float-based reordering headroom
UPDATE tasks SET sort_order = sub.new_order
FROM (
  SELECT id, ROW_NUMBER() OVER (
    PARTITION BY user_id ORDER BY created_at ASC
  ) * 65536.0 AS new_order
  FROM tasks
) sub
WHERE tasks.id = sub.id;

-- Step 4: Indexes for common queries (Phase 14/15 will use these heavily)
CREATE INDEX idx_tasks_status ON tasks(user_id, status);
CREATE INDEX idx_tasks_section ON tasks(user_id, section);
CREATE INDEX idx_tasks_sort_order ON tasks(user_id, sort_order);

-- Step 5: Column documentation
COMMENT ON COLUMN tasks.status IS 'Task workflow status: backlog, todo, in_progress, done. Synced with is_completed at API layer.';
COMMENT ON COLUMN tasks.section IS 'Task section grouping (default: personal). Extended by projects in Phase 14.';
COMMENT ON COLUMN tasks.sort_order IS 'Float-based ordering within section for drag-and-drop reordering.';
```

This is a one-shot forward-only migration per locked decision. No down-migration script.
  </action>
  <verify>
File exists at the expected path. SQL is syntactically correct (visually verify — cannot run against DB in test). Migration follows the naming convention of existing files in `supabase/migrations/`.
  </verify>
  <done>
Migration SQL file exists with: (1) three new columns with defaults and constraints, (2) existing completed tasks synced to status=done, (3) sort_order seeded by creation date with 65536.0 gap spacing, (4) composite indexes for query performance, (5) column documentation comments.
  </done>
</task>

</tasks>

<verification>
1. `pnpm lint` passes with no errors
2. `pnpm test:run -- tests/lib/tasks/sync.test.ts tests/lib/tasks/sort-order.test.ts` — all tests pass
3. `pnpm test:run` — all existing tests still pass (type changes are backward compatible)
4. Migration SQL file exists at `supabase/migrations/20260218000001_add_task_status_section_sort_order.sql`
5. `TaskStatus` type exists in `lib/db/types.ts` with exactly 4 values
6. `taskStatusSchema` exists in `lib/validations/task.ts`
</verification>

<success_criteria>
- TaskStatus type constrains to exactly: backlog, todo, in_progress, done
- Sync utility handles all input combinations correctly (10+ test cases passing)
- Sort-order utility computes correct float values (6 test cases passing)
- Migration SQL is ready to run (adds columns, syncs data, seeds sort_order, creates indexes)
- All existing tests still pass — no regressions from type changes
</success_criteria>

<output>
After completion, create `.planning/phases/13-data-foundation-migration/13-01-SUMMARY.md`
</output>
