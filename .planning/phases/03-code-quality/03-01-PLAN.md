---
phase: 03-code-quality
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/logger.ts
  - components/theme-switcher.tsx
  - tests/components/theme-switcher.test.tsx
  - app/layout.tsx
  - lib/db/habits.ts
  - lib/db/habit-logs.ts
  - lib/db/tasks.ts
  - lib/db/profiles.ts
autonomous: true

must_haves:
  truths:
    - "Theme switching between light and dark mode works correctly without any manual DOM class manipulation in theme-switcher.tsx"
    - "Instantiating HabitLogsDB (or HabitsDB, TasksDB, ProfilesDB) without a Supabase client argument produces a TypeScript compilation error"
    - "A thin logger module exists that wraps console methods and can be swapped to Sentry later with one file change"
  artifacts:
    - path: "lib/logger.ts"
      provides: "Logger wrapper module with log.error, log.warn, log.info"
      exports: ["log"]
    - path: "components/theme-switcher.tsx"
      provides: "Theme switcher without manual DOM class manipulation"
      contains: "useTheme"
    - path: "lib/db/habits.ts"
      provides: "HabitsDB with required supabase constructor param"
      contains: "constructor(private supabase: SupabaseClient)"
    - path: "lib/db/habit-logs.ts"
      provides: "HabitLogsDB with required supabase constructor param"
      contains: "constructor(supabase: SupabaseClient)"
    - path: "lib/db/tasks.ts"
      provides: "TasksDB with required supabase constructor param"
      contains: "constructor(private supabase: SupabaseClient)"
    - path: "lib/db/profiles.ts"
      provides: "ProfilesDB with required supabase constructor param"
      contains: "constructor(private supabase: SupabaseClient)"
  key_links:
    - from: "lib/db/habits.ts"
      to: "lib/supabase/client.ts"
      via: "explicit createClient() in singleton export"
      pattern: "export const habitsDB = new HabitsDB\\(createClient\\(\\)\\)"
    - from: "components/theme-switcher.tsx"
      to: "next-themes"
      via: "useTheme hook (no manual DOM manipulation)"
      pattern: "useTheme"
---

<objective>
Create the logger wrapper module, fix the theme-switcher DOM workaround, and harden all four DB class constructors to require a Supabase client.

Purpose: Establishes the logger foundation needed by Plan 02, eliminates the fragile manual DOM manipulation in theme-switcher, and prevents silent wrong-client bugs in DB classes.
Output: `lib/logger.ts`, cleaned `theme-switcher.tsx`, hardened DB constructors in 4 files.
</objective>

<execution_context>
@/home/xingdi/.claude/get-shit-done/workflows/execute-plan.md
@/home/xingdi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-code-quality/03-CONTEXT.md
@.planning/phases/03-code-quality/03-RESEARCH.md
@components/theme-switcher.tsx
@tests/components/theme-switcher.test.tsx
@app/layout.tsx
@lib/db/habits.ts
@lib/db/habit-logs.ts
@lib/db/tasks.ts
@lib/db/profiles.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create thin logger wrapper module</name>
  <files>lib/logger.ts</files>
  <action>
Create `lib/logger.ts` exporting a `log` object with three methods:

- `log.error(message: string, error?: unknown, context?: LogContext): void` -- wraps `console.error`. Signature separates message from Error object because Sentry's `captureException` wants them as separate arguments. When swapping to Sentry later, this body becomes `Sentry.captureException(error, { extra: context })`.
- `log.warn(message: string, context?: LogContext): void` -- wraps `console.warn`. Future: `Sentry.captureMessage(message, { level: 'warning', extra: context })`.
- `log.info(message: string, context?: LogContext): void` -- wraps `console.info`. Future: gated by environment or stripped.

Where `LogContext = Record<string, unknown>` (flat key-value pairs for future Sentry "extra" data).

Use a `formatMessage` helper that appends `JSON.stringify(context)` to the message when context is provided.

Export as `export const log = { error, warn, info } as const;`. No log levels, no transports, no configuration -- just a facade. This is intentional per user decision; complexity belongs to Sentry later.

Follow the exact design from the research document's Pattern 1 section.
  </action>
  <verify>
Run `npx tsc --noEmit` -- should compile with no errors.
Run `pnpm lint` -- should pass with no new warnings.
Verify the file exports `log` with all three methods by checking the file contents.
  </verify>
  <done>
`lib/logger.ts` exists, exports `log` object with `error`, `warn`, `info` methods. TypeScript compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix theme-switcher and add disableTransitionOnChange</name>
  <files>components/theme-switcher.tsx, app/layout.tsx, tests/components/theme-switcher.test.tsx</files>
  <action>
**theme-switcher.tsx:**
Remove the entire second `useEffect` block (lines 23-43) that manually manipulates `document.documentElement` classes. This includes:
- The DOM class reading (`document.documentElement.className`)
- The `classList.add`/`classList.remove` calls for `dark`/`light`
- The three `console.log` debug statements (lines 39-41)

Keep the first `useEffect` (the hydration guard `setMounted(true)`) and all JSX unchanged. The component should only use `useTheme()` from next-themes -- no direct DOM manipulation. Add a comment: "// next-themes ThemeProvider with attribute='class' handles adding/removing the dark class on <html> via an injected blocking script."

Also remove the unused `theme` destructuring from `useTheme()` if it is only used in the removed useEffect and the dropdown. Check: `theme` IS used in the `DropdownMenuRadioGroup value={theme}` -- so keep it.

**app/layout.tsx:**
Add `disableTransitionOnChange` prop to the `<ThemeProvider>` component for instant theme swap with no CSS transition flash (per user decision: "Instant swap, no transition animation").

**tests/components/theme-switcher.test.tsx:**
- Remove the `beforeEach` line `document.documentElement.className = '';` and the `afterEach` block that cleans up `document.documentElement.className` -- these tested the removed DOM manipulation.
- Remove the two test cases that assert manual DOM class manipulation:
  - "adds dark class to document when resolved theme is dark" (lines 148-158)
  - "adds light class to document when resolved theme is light" (lines 160-170)
- Keep all other tests (renders button, shows icons, opens dropdown, calls setTheme for light/dark/system, aria attributes) -- these test real behavior, not the removed workaround.
- Add a new test: "does not manually manipulate document classes" that renders the component, waits for mount, and asserts `document.documentElement.className` remains empty (proving no manual DOM manipulation occurs).
  </action>
  <verify>
Run `pnpm vitest run tests/components/theme-switcher.test.tsx` -- all tests pass, no DOM manipulation tests remain.
Run `npx tsc --noEmit` -- no type errors.
Grep `components/theme-switcher.tsx` for `document.documentElement` -- should find zero matches.
Grep `components/theme-switcher.tsx` for `console.log` -- should find zero matches.
Grep `app/layout.tsx` for `disableTransitionOnChange` -- should find one match.
  </verify>
  <done>
Theme-switcher has no manual DOM class manipulation, no console.log statements. ThemeProvider has `disableTransitionOnChange`. All theme-switcher tests pass, and the two DOM manipulation tests are replaced by a negative assertion test.
  </done>
</task>

<task type="auto">
  <name>Task 3: Harden DB class constructors to require Supabase client</name>
  <files>lib/db/habits.ts, lib/db/habit-logs.ts, lib/db/tasks.ts, lib/db/profiles.ts</files>
  <action>
For each of the four DB classes (HabitsDB, HabitLogsDB, TasksDB, ProfilesDB), make the Supabase client parameter **required** (not optional):

**Pattern (same for all four):**
```typescript
// BEFORE:
constructor(supabase?: SupabaseClient) {
  this.supabase = supabase || createClient();
}

// AFTER:
constructor(supabase: SupabaseClient) {
  this.supabase = supabase;
}
```

For HabitsDB, TasksDB, ProfilesDB: use `constructor(private supabase: SupabaseClient)` shorthand since they have a simple `private supabase: SupabaseClient` field.

For HabitLogsDB: keep the explicit assignment since it also creates `this.habitsDB = new HabitsDB(supabase)` in the constructor body.

**Update singleton exports** at the bottom of each file. Change from no-arg construction to explicit browser client:
```typescript
// BEFORE:
export const habitsDB = new HabitsDB();

// AFTER:
import { createClient } from '@/lib/supabase/client';  // already imported at top
export const habitsDB = new HabitsDB(createClient());
```

Do this for all four: `habitsDB`, `habitLogsDB`, `tasksDB`, `profilesDB`.

Remove the `@param supabase - Optional Supabase client. Omit for client-side usage...` JSDoc comment from each constructor since the param is now required.

**Important:** The `import { createClient } from '@/lib/supabase/client'` already exists at the top of each file (it was used in the `|| createClient()` fallback). Keep it -- it is now used in the singleton export instead.

Note: InsightsDB and HabitMilestonesDB already require the client -- no changes needed for those.
  </action>
  <verify>
Run `npx tsc --noEmit` -- should compile cleanly. If any call site passes no argument, TypeScript will catch it.
Run `pnpm test:run` -- all tests should pass (test files mock Supabase and pass it explicitly already).
Grep all four files for `supabase?:` or `supabase ||` -- should find zero matches.
  </verify>
  <done>
All four DB classes (HabitsDB, HabitLogsDB, TasksDB, ProfilesDB) require a SupabaseClient in their constructor. Singleton exports pass `createClient()` explicitly. `new HabitLogsDB()` without args produces a TypeScript compile error. All tests pass.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes (no type errors from constructor changes or theme-switcher cleanup)
2. `pnpm test:run` passes (all existing tests, updated theme-switcher tests)
3. `pnpm lint` passes (no lint errors)
4. `grep -r "document.documentElement" components/theme-switcher.tsx` returns nothing
5. `grep -r "console.log" components/theme-switcher.tsx` returns nothing
6. `grep -rn "supabase?:" lib/db/habits.ts lib/db/habit-logs.ts lib/db/tasks.ts lib/db/profiles.ts` returns nothing
7. `lib/logger.ts` exists and exports `log` object
</verification>

<success_criteria>
- Logger module exists at lib/logger.ts with error/warn/info methods
- Theme-switcher has zero manual DOM manipulation and zero console.log statements
- ThemeProvider has disableTransitionOnChange prop
- All four DB classes require SupabaseClient in constructor (no optional param)
- All singleton exports pass createClient() explicitly
- TypeScript compiles, all tests pass, lint clean
</success_criteria>

<output>
After completion, create `.planning/phases/03-code-quality/03-01-SUMMARY.md`
</output>
