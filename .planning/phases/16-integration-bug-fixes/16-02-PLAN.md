---
phase: 16-integration-bug-fixes
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - components/kanban/kanban-board.tsx
  - components/tasks/tasks-page-content.tsx
  - i18n/messages/en.json
  - i18n/messages/zh.json
  - i18n/messages/zh-TW.json
autonomous: true
requirements:
  - KANB-02
  - PROJ-03

must_haves:
  truths:
    - "Dragging a kanban card between columns persists the change AND the board remains fully populated after the async mutation resolves"
    - "Users can navigate to the archived projects page from the tasks page UI"
  artifacts:
    - path: "components/kanban/kanban-board.tsx"
      provides: "SWR mutate async function returns correct {tasks: Task[]} cache shape"
      contains: "tasks: (current?.tasks ?? []).map"
    - path: "components/tasks/tasks-page-content.tsx"
      provides: "Archived projects navigation link in tasks page header"
      contains: "viewArchived"
    - path: "i18n/messages/en.json"
      provides: "viewArchived i18n key in English"
      contains: "viewArchived"
    - path: "i18n/messages/zh.json"
      provides: "viewArchived i18n key in Chinese Simplified"
    - path: "i18n/messages/zh-TW.json"
      provides: "viewArchived i18n key in Chinese Traditional"
  key_links:
    - from: "components/kanban/kanban-board.tsx"
      to: "/api/tasks/[id]"
      via: "PATCH fetch in SWR mutate async function"
      pattern: "const \\{ task: updatedTask \\} = await res\\.json"
    - from: "components/tasks/tasks-page-content.tsx"
      to: "/projects/archived"
      via: "Link component href"
      pattern: "href.*projects/archived"
---

<objective>
Fix kanban SWR cache corruption on drag-drop and add archived projects navigation link.

Purpose: After dragging a kanban card, the SWR mutate async function returns `{task: Task}` (PATCH response shape) but the cache expects `{tasks: Task[]}` (GET response shape). This causes the board to empty ~100-500ms after a drag because the wrong-shaped data replaces the cache. Additionally, users have no UI path to reach `/projects/archived` from the tasks page.

Output: Kanban drag-drop that persists correctly without cache corruption, and an "Archived" link button in the tasks page header area.
</objective>

<execution_context>
@/home/xingdi/.claude/get-shit-done/workflows/execute-plan.md
@/home/xingdi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-integration-bug-fixes/16-RESEARCH.md

# Source files to fix
@components/kanban/kanban-board.tsx
@components/tasks/tasks-page-content.tsx

# i18n files
@i18n/messages/en.json
@i18n/messages/zh.json
@i18n/messages/zh-TW.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix kanban SWR mutate to return correct cache shape after drag-drop</name>
  <files>
    components/kanban/kanban-board.tsx
  </files>
  <action>
    In `components/kanban/kanban-board.tsx`, find the `handleDragEnd` callback's `mutate()` call (~lines 138-165).

    **Current buggy code (the async function in mutate):**
    ```typescript
    mutate(
      async () => {
        const res = await fetch(`/api/tasks/${taskId}`, { ... });
        if (!res.ok) throw new Error("Failed to update task status");
        return res.json(); // Returns {task: Task} — WRONG SHAPE
      },
      { optimisticData: ..., rollbackOnError: true, revalidate: false }
    )
    ```

    **Replace the async function with one that returns the correct {tasks: Task[]} shape:**
    ```typescript
    mutate(
      async (current: { tasks: Task[] } | undefined) => {
        const res = await fetch(`/api/tasks/${taskId}`, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ status: newStatus }),
        });
        if (!res.ok) throw new Error("Failed to update task status");
        const { task: updatedTask } = await res.json();
        return {
          tasks: (current?.tasks ?? []).map((t) =>
            t.id === taskId ? updatedTask : t
          ),
        };
      },
      {
        optimisticData: (current: { tasks: Task[] } | undefined) => ({
          tasks: (current?.tasks ?? []).map((t) =>
            t.id === taskId
              ? {
                  ...t,
                  status: newStatus,
                  is_completed: newStatus === "done",
                }
              : t
          ),
        }),
        rollbackOnError: true,
        revalidate: false,
      }
    ).catch(() => {
      toast.error(t("dragError"));
    });
    ```

    **Key change:** The async function now (1) receives `current` data as its first argument (SWR v2 API), (2) destructures the PATCH response to get the updated task, and (3) returns the mapped list in `{tasks: Task[]}` shape matching the GET endpoint's response format.

    **Why this fixes the bug:** With `revalidate: false`, SWR uses the async function's return value as the final cache value. The old code returned `{task: Task}` which doesn't match `{tasks: Task[]}`, causing all components reading the cache to see an empty task list.
  </action>
  <verify>
    `pnpm build` succeeds (no TypeScript errors in kanban-board.tsx).
    `pnpm lint` passes with no errors in kanban-board.tsx.
  </verify>
  <done>
    SWR mutate async function returns `{tasks: Task[]}` shape matching the GET response format.
    After a drag-drop, the board remains fully populated with all tasks visible.
    The updated task in the cache reflects the server response (not just the optimistic data).
  </done>
</task>

<task type="auto">
  <name>Task 2: Add archived projects navigation link to tasks page header</name>
  <files>
    components/tasks/tasks-page-content.tsx
    i18n/messages/en.json
    i18n/messages/zh.json
    i18n/messages/zh-TW.json
  </files>
  <action>
    **Step 1 — Add i18n keys:**

    In `i18n/messages/en.json`, add a `viewArchived` key inside `tasks.page`:
    ```json
    "page": {
      "title": "My Tasks",
      "createButton": "Create Task",
      "createProject": "Create Project",
      "viewArchived": "Archived"
    }
    ```

    In `i18n/messages/zh.json`, add the same key:
    ```json
    "viewArchived": "已归档"
    ```

    In `i18n/messages/zh-TW.json`, add the same key:
    ```json
    "viewArchived": "已封存"
    ```

    **Step 2 — Add link in tasks page header (components/tasks/tasks-page-content.tsx):**

    Add imports at the top:
    - `import Link from "next/link";`
    - `import { Archive } from "lucide-react";` (add `Archive` to existing lucide-react import)

    In the PageHeader `actions` prop, add an "Archived" ghost button link BEFORE the "Create Project" button:
    ```tsx
    <Button variant="ghost" size="sm" asChild>
      <Link href="/projects/archived">
        <Archive className="size-4 mr-2" />
        {t("page.viewArchived")}
      </Link>
    </Button>
    ```

    The complete actions section should read:
    ```tsx
    actions={
      <div className="flex items-center gap-2">
        <Button variant="ghost" size="sm" asChild>
          <Link href="/projects/archived">
            <Archive className="size-4 mr-2" />
            {t("page.viewArchived")}
          </Link>
        </Button>
        <Button variant="outline" onClick={handleCreateProject}>
          <FolderPlus className="size-4 mr-2" />
          {t("page.createProject")}
        </Button>
        <Button onClick={handleCreateTask}>
          <Plus className="size-4 mr-2" />
          {t("page.createButton")}
        </Button>
      </div>
    }
    ```

    **Why ghost variant:** The "Archived" link is a secondary navigation action, not a primary action like Create. Ghost styling keeps the visual hierarchy correct — Create Project (outline) and Create Task (primary) remain visually dominant.
  </action>
  <verify>
    `pnpm build` succeeds.
    `pnpm lint` passes.
    `pnpm test:run` — all existing tests pass (no regressions from i18n or component changes).
  </verify>
  <done>
    Tasks page header has an "Archived" link button that navigates to `/projects/archived`.
    i18n key `viewArchived` exists in all 3 locale files (en, zh, zh-TW).
    Button uses ghost variant with Archive icon for appropriate visual hierarchy.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` succeeds with zero errors
2. `pnpm test:run` — full test suite passes
3. `pnpm lint` — no lint errors
4. Kanban drag-drop no longer empties the board after async mutation resolves
5. Tasks page header shows "Archived" link leading to `/projects/archived`
</verification>

<success_criteria>
- SWR mutate async function returns `{tasks: Task[]}` shape matching GET response
- Kanban board remains fully populated after drag-drop (no cache corruption)
- Tasks page has navigable link to archived projects page
- All 3 locale files have `viewArchived` key with correct translations
- Build, lint, and test suite all pass
</success_criteria>

<output>
After completion, create `.planning/phases/16-integration-bug-fixes/16-02-SUMMARY.md`
</output>
