---
phase: 15-kanban-board
plan: 02
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - components/kanban/kanban-board.tsx
  - components/kanban/kanban-column.tsx
  - components/kanban/kanban-card.tsx
  - components/kanban/kanban-card-overlay.tsx
autonomous: true
requirements: [KANB-01, KANB-02, KANB-03, KANB-04]

must_haves:
  truths:
    - "Kanban board displays 4 columns (Backlog, To Do, In Progress, Done) with project tasks grouped by status"
    - "Cards are sorted by priority (high to low) within each column"
    - "User can drag a card from one column to another to change its status"
    - "Status change persists (SWR mutation calls PATCH /api/tasks/[id])"
    - "If API fails on drag, card snaps back and error toast appears"
  artifacts:
    - path: "components/kanban/kanban-board.tsx"
      provides: "Main board with DndContext, SWR data fetching, drag handlers, 4 columns"
      contains: "DndContext"
    - path: "components/kanban/kanban-column.tsx"
      provides: "Single status column with useDroppable, isOver highlight"
      contains: "useDroppable"
    - path: "components/kanban/kanban-card.tsx"
      provides: "Draggable task card with title, priority badge, due date"
      contains: "useDraggable"
    - path: "components/kanban/kanban-card-overlay.tsx"
      provides: "Ghost card rendered in DragOverlay portal"
  key_links:
    - from: "components/kanban/kanban-board.tsx"
      to: "/api/tasks?project_id={id}"
      via: "useSWR fetch"
      pattern: "useSWR.*project_id"
    - from: "components/kanban/kanban-board.tsx"
      to: "/api/tasks/{id}"
      via: "PATCH on drag-end"
      pattern: "fetch.*api/tasks"
    - from: "components/kanban/kanban-board.tsx"
      to: "components/kanban/kanban-column.tsx"
      via: "renders 4 KanbanColumn components"
      pattern: "KanbanColumn"
    - from: "components/kanban/kanban-column.tsx"
      to: "components/kanban/kanban-card.tsx"
      via: "renders KanbanCard per task"
      pattern: "KanbanCard"
---

<objective>
Build the core kanban board with 4-column layout, drag-and-drop between columns via @dnd-kit, optimistic SWR mutations, and priority-sorted cards.

Purpose: Deliver the primary kanban interaction â€” users see their project's tasks organized by status and can drag cards between columns to change status with instant visual feedback and persistent state.
Output: KanbanBoard, KanbanColumn, KanbanCard, KanbanCardOverlay components.
</objective>

<execution_context>
@/home/xingdi/.claude/get-shit-done/workflows/execute-plan.md
@/home/xingdi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/15-kanban-board/15-CONTEXT.md
@.planning/phases/15-kanban-board/15-RESEARCH.md
@.planning/phases/15-kanban-board/15-01-SUMMARY.md
@lib/db/types.ts
@lib/tasks/sync.ts
@lib/fetcher.ts
@components/kanban/kanban-skeleton.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create KanbanColumn and KanbanCard components</name>
  <files>
    components/kanban/kanban-column.tsx
    components/kanban/kanban-card.tsx
    components/kanban/kanban-card-overlay.tsx
  </files>
  <action>
1. **Create `components/kanban/kanban-column.tsx`:**
   - `"use client"` directive
   - Props: `{ status: TaskStatus; title: string; tasks: Task[]; onCardClick: (task: Task) => void }`
   - Use `useDroppable({ id: status })` from `@dnd-kit/core`
   - Layout: `flex flex-col w-72 min-w-72 shrink-0 rounded-lg bg-muted/30`
   - Highlight on drag-over: `isOver && "ring-2 ring-primary/50 bg-primary/5"`
   - Column header: neutral/subtle with task count in a `Badge variant="secondary"` (per CONTEXT: "neutral/subtle with colored count badge")
   - Body: `ScrollArea` from shadcn wrapping a `div.space-y-2` of KanbanCard components
   - Empty state: centered muted text when `tasks.length === 0` using `t("kanban.emptyColumn")`
   - Cards are pre-sorted by caller (board passes sorted arrays)

2. **Create `components/kanban/kanban-card.tsx`:**
   - `"use client"` directive
   - Props: `{ task: Task; onClick: () => void }`
   - Use `useDraggable({ id: task.id, data: { task } })` from `@dnd-kit/core`
   - Apply transform via `CSS.Translate.toString(transform)` from `@dnd-kit/utilities`
   - Card content (Monday.com-style, per CONTEXT):
     - Task title: `text-sm font-medium leading-tight`
     - Priority badge (if priority > 0): use `Badge` component with colored classes:
       - 3 (high): `bg-red-500 text-white` (or `bg-priority-high text-white` if design token exists)
       - 2 (medium): `bg-yellow-500 text-white`
       - 1 (low): `bg-blue-500 text-white`
       - Use i18n keys `kanban.priority.high/medium/low` for badge text
     - Due date (if set): small text with Calendar icon, `text-xs text-muted-foreground`
   - Click handling: `onClick` fires only when `isDragging` is false (prevent click-during-drag)
   - Spread `{...listeners, ...attributes}` on the Card element
   - Styles: `cursor-grab active:cursor-grabbing`, dim when dragging `isDragging && "opacity-50 shadow-lg"`

3. **Create `components/kanban/kanban-card-overlay.tsx`:**
   - `"use client"` directive
   - Props: `{ task: Task }`
   - Renders the same visual as KanbanCard but WITHOUT useDraggable hooks (static presentation)
   - Same layout/content: title, priority badge, due date
   - Add `shadow-lg rotate-[2deg]` for visual lift effect during drag (Claude's discretion)
   - This is used inside `<DragOverlay>` in the board component
  </action>
  <verify>
    - `pnpm lint` passes for new files
    - All 3 component files exist and export named components
    - `grep "useDroppable" components/kanban/kanban-column.tsx` confirms DnD hook usage
    - `grep "useDraggable" components/kanban/kanban-card.tsx` confirms DnD hook usage
  </verify>
  <done>
    - KanbanColumn renders a droppable area with header, card list, and empty state
    - KanbanCard renders a draggable task card with title, priority badge, and due date
    - KanbanCardOverlay renders a static ghost card for DragOverlay
  </done>
</task>

<task type="auto">
  <name>Task 2: Create KanbanBoard with DndContext, SWR, and drag-end handler</name>
  <files>
    components/kanban/kanban-board.tsx
  </files>
  <action>
1. **Create `components/kanban/kanban-board.tsx`:**
   - `"use client"` directive
   - Exported as `KanbanBoard` (named export so dynamic import uses `.then(m => m.KanbanBoard)`)
   - Props: `{ projectId: string }`

2. **SWR data fetching:**
   - Fetch project: `useSWR<{ project: Project }>(\`/api/projects/${projectId}\`, fetcher)`
     - For error/loading: show error message or skeleton
   - Fetch tasks: `useSWR<{ tasks: Task[] }>(\`/api/tasks?project_id=${projectId}\`, fetcher, { revalidateOnFocus: false, keepPreviousData: true })`
     - `revalidateOnFocus: false` per Pitfall 3 in research (prevents drag interruption)

3. **Board header:**
   - Minimal header per CONTEXT: project name with colored accent, back arrow (ArrowLeft icon + link to /tasks), task count
   - Use `getProjectColor(project.color)` + `useTheme()` for the project color accent
   - Back button: `<Link href="/tasks">` with ArrowLeft icon and `t("kanban.backToTasks")`
   - Task count: `t("kanban.taskCount", { count: tasks.length })`

4. **Column data preparation:**
   - Define statuses array: `const STATUSES: TaskStatus[] = ["backlog", "todo", "in_progress", "done"]`
   - Group tasks by status: `useMemo(() => groupByStatus(tasks), [tasks])`
   - Sort within each group by priority descending: `(a, b) => b.priority - a.priority` (per CONTEXT: auto-sort by priority, no manual reorder)
   - `groupByStatus` helper: returns `Record<TaskStatus, Task[]>` with empty arrays for missing statuses
   - Column titles from i18n: `t(\`kanban.columns.${status}\`)`

5. **DndContext setup:**
   - Sensors: MouseSensor (distance: 8), TouchSensor (delay: 200, tolerance: 5), KeyboardSensor
   - Collision detection: `closestCorners` from `@dnd-kit/core`
   - `onDragStart`: set `activeTask` state (the task being dragged)
   - `onDragEnd`: handle status change (see below)
   - No `onDragOver` handler (per research: only call API on DragEnd)

6. **DragOverlay:**
   - Render `<KanbanCardOverlay task={activeTask} />` when `activeTask` is not null
   - Wrapped in `<DragOverlay>` component from @dnd-kit

7. **onDragEnd handler:**
   ```typescript
   function handleDragEnd(event: DragEndEvent) {
     const { active, over } = event;
     setActiveTask(null);
     if (!over) return;

     const taskId = active.id as string;
     const newStatus = over.id as TaskStatus;
     const task = tasks.find(t => t.id === taskId);

     // Guard: no-op if same column or task not found
     if (!task || task.status === newStatus) return;

     // Validate newStatus is a valid column
     if (!STATUSES.includes(newStatus)) return;

     // Optimistic SWR update
     mutate(
       async () => {
         const res = await fetch(`/api/tasks/${taskId}`, {
           method: "PATCH",
           headers: { "Content-Type": "application/json" },
           body: JSON.stringify({ status: newStatus }),
         });
         if (!res.ok) throw new Error("Failed to update task status");
         return res.json();
       },
       {
         optimisticData: (current: { tasks: Task[] } | undefined) => ({
           tasks: (current?.tasks ?? []).map((t) =>
             t.id === taskId
               ? { ...t, status: newStatus, is_completed: newStatus === "done" }
               : t
           ),
         }),
         rollbackOnError: true,
         revalidate: false,
       }
     ).catch(() => {
       toast.error(t("kanban.dragError"));
     });
   }
   ```
   Uses `mutate` from the tasks SWR hook. On failure, `rollbackOnError: true` reverts the optimistic update and `toast.error` shows an error toast.

8. **Card click handler:**
   - `const [selectedTask, setSelectedTask] = useState<Task | null>(null)`
   - Pass `onCardClick={setSelectedTask}` to each column
   - The detail modal integration will be done in Plan 03; for now, clicking a card sets `selectedTask` state (harmless no-op until modal is wired)

9. **Board layout:**
   - Main container: `flex flex-col h-[calc(100vh-theme(spacing.16))]` (full height minus header)
   - Header at top, then columns area: `flex gap-4 overflow-x-auto flex-1 pb-4 px-4`
   - Each column takes fixed width (w-72), horizontal scroll when many columns
  </action>
  <verify>
    - `pnpm lint` passes
    - `grep "DndContext" components/kanban/kanban-board.tsx` confirms DnD context setup
    - `grep "useSWR" components/kanban/kanban-board.tsx` confirms data fetching
    - `grep "mutate" components/kanban/kanban-board.tsx` confirms optimistic update
    - `pnpm build` succeeds (or `pnpm tsc --noEmit` for faster type check)
  </verify>
  <done>
    - KanbanBoard fetches project + tasks via SWR, renders 4 columns with priority-sorted cards
    - Drag-and-drop between columns changes task status via optimistic PATCH API call
    - Failed drags roll back and show error toast
    - Board has minimal header with project name, back arrow, task count
  </done>
</task>

</tasks>

<verification>
- `pnpm test:run` passes with no regressions
- `pnpm lint` passes
- `pnpm build` succeeds
- Navigating to /projects/{id}/kanban shows the 4-column kanban board with project tasks
- Dragging a card between columns updates the task status (visible after page refresh)
</verification>

<success_criteria>
- 4-column kanban board renders with project tasks grouped by status
- Cards sorted by priority within columns
- Cross-column drag changes status with optimistic update
- API failure causes rollback + error toast
- Board header shows project name with color accent, back link, task count
</success_criteria>

<output>
After completion, create `.planning/phases/15-kanban-board/15-02-SUMMARY.md`
</output>
