---
phase: 14-projects-sections
plan: 03
type: execute
wave: 3
depends_on: ["14-01", "14-02"]
files_modified:
  - components/tasks/tasks-page-content.tsx
  - components/tasks/task-list.tsx
  - components/projects/project-card.tsx
  - components/projects/archived-projects-content.tsx
  - app/projects/archived/page.tsx
  - app/projects/archived/layout.tsx
autonomous: true
requirements:
  - PROJ-05
  - PAGE-01
  - PAGE-02

must_haves:
  truths:
    - "Tasks page shows Personal section on top and Work section below in a single scrollable page"
    - "Each section shows standalone tasks first, then project cards below"
    - "Project cards display name, color accent, progress bar, X/Y done text, up to 5 task previews, and three-dot menu"
    - "Task previews on project cards show in-progress tasks first, then todo tasks, with status dots"
    - "Project cards show '+N more' when tasks exceed 5 preview limit"
    - "Three-dot menu on project cards has Edit, Archive, Delete actions"
    - "Archived projects page at /projects/archived lists archived projects with restore action"
  artifacts:
    - path: "components/tasks/tasks-page-content.tsx"
      provides: "Section-based tasks page layout"
      contains: "SectionBlock"
    - path: "components/projects/project-card.tsx"
      provides: "Rich project card with progress and task previews"
      contains: "ProjectCard"
    - path: "components/projects/archived-projects-content.tsx"
      provides: "Archived projects listing"
      contains: "ArchivedProjectsContent"
    - path: "app/projects/archived/page.tsx"
      provides: "Archived projects page route"
      contains: "ArchivedProjectsPage"
  key_links:
    - from: "components/tasks/tasks-page-content.tsx"
      to: "components/projects/project-card.tsx"
      via: "Component composition"
      pattern: "ProjectCard"
    - from: "components/tasks/tasks-page-content.tsx"
      to: "lib/hooks/use-projects.ts"
      via: "SWR data fetching"
      pattern: "useProjects"
    - from: "components/projects/project-card.tsx"
      to: "lib/projects/colors.ts"
      via: "Color accent rendering"
      pattern: "getProjectColor"
    - from: "components/tasks/tasks-page-content.tsx"
      to: "components/projects/project-modal.tsx"
      via: "Create project button"
      pattern: "ProjectModal"
    - from: "components/projects/archived-projects-content.tsx"
      to: "/api/projects/[id]"
      via: "fetch PATCH for restore"
      pattern: "fetch.*api/projects.*PATCH"
---

<objective>
Redesign the tasks page from a flat list to a section-based layout with project cards, and create the archived projects page.

Purpose: This is the main user-facing deliverable of Phase 14 — the tasks page becomes organized by Work/Personal sections with rich project cards showing progress and task previews. This transforms the task management experience from a flat list to a structured project view.

Output: Redesigned tasks-page-content.tsx with section layout, ProjectCard component with rich content, archived projects page, and all supporting wiring.
</objective>

<execution_context>
@/home/xingdi/.claude/get-shit-done/workflows/execute-plan.md
@/home/xingdi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-projects-sections/14-RESEARCH.md
@.planning/phases/14-projects-sections/14-01-SUMMARY.md
@.planning/phases/14-projects-sections/14-02-SUMMARY.md
@components/tasks/tasks-page-content.tsx
@components/tasks/task-list.tsx
@components/tasks/task-card.tsx
@components/projects/project-modal.tsx
@components/projects/project-delete-dialog.tsx
@lib/hooks/use-projects.ts
@lib/projects/colors.ts
@lib/db/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ProjectCard component and redesign tasks page with section layout</name>
  <files>
    components/projects/project-card.tsx
    components/tasks/tasks-page-content.tsx
    components/tasks/task-list.tsx
  </files>
  <action>
    **ProjectCard** (`components/projects/project-card.tsx`):
    "use client" component. This is the richest component in Phase 14 — follow the research code example closely.

    Props: `project: Project`, `tasks: Task[]`, `onEdit: (project: Project) => void`, `onArchive: (projectId: string) => void`, `onDelete: (projectId: string) => void`

    Layout (per locked decisions):
    - **Color accent:** Left border 4px solid + subtle background tint (per research recommendation: left border accent + tint combo). Use `getProjectColor(project.color)` to get HSL values. Apply `borderLeftColor: hsl(${color.hsl})` and `backgroundColor: hsl(${color.hsl} / 0.04)` in light mode. For dark mode, use `useTheme()` from `next-themes` to check `resolvedTheme === 'dark'` and switch to `color.hslDark` with 0.06 opacity.
    - **Card body click:** Navigates to kanban board (per Claude's discretion: click card opens kanban). Since kanban is Phase 15, use `router.push(\`/projects/${project.id}/board\`)` — the route won't exist yet but will be wired in Phase 15. Add `cursor-pointer` and hover effect (`hover:shadow-md hover:-translate-y-0.5 transition-all duration-200`).
    - **Header row:** Project name (font-medium, truncated) + three-dot menu (DropdownMenu) in top-right. Menu items: Edit, Archive, Delete (Delete styled as text-destructive). Each menu item calls `e.stopPropagation()` to prevent card click.
    - **Progress section:** Radix Progress bar (h-1.5) showing `(done/total) * 100` percentage + text below: "{done}/{total} done" (use i18n `t("done")`).
    - **Task previews:** Show up to 5 non-completed tasks. Sort by: in_progress first, then todo, then backlog. Each preview line: status dot (small colored circle — use semantic color for in_progress vs muted for todo/backlog) + truncated task title. Per locked decision: "Each task preview has a status dot (colored indicator for in_progress vs todo)".
    - **"+N more":** If there are more than 5 non-completed tasks, show "+N more" text below previews (per locked decision).
    - **Empty state:** If project has no tasks, show "No tasks yet" (i18n).
    - **"Open Board" button:** Small secondary button at bottom of card (per locked decision: "a button to open the kanban"). Links to `/projects/${project.id}/board`.

    Progress calculation helper (inline or extracted):
    ```typescript
    function getProjectProgress(tasks: Task[]): { done: number; total: number } {
      return { done: tasks.filter(t => t.is_completed).length, total: tasks.length };
    }

    function getTaskPreviews(tasks: Task[], limit: number): Task[] {
      const active = tasks.filter(t => !t.is_completed);
      const sorted = active.sort((a, b) => {
        const order = { in_progress: 0, todo: 1, backlog: 2, done: 3 };
        return (order[a.status] ?? 3) - (order[b.status] ?? 3);
      });
      return sorted.slice(0, limit);
    }
    ```

    **Tasks page content redesign** (`components/tasks/tasks-page-content.tsx`):
    Major rewrite from flat task list to section-based layout.

    Data fetching:
    - Keep existing SWR fetch for tasks (already in the file).
    - Add `useProjects()` hook to fetch active projects.
    - Both SWR keys should be fetched in parallel (two separate useSWR calls).

    State management:
    - `projectModalOpen` + `editingProject` state for create/edit modal.
    - `deleteDialogOpen` + `deletingProject` state for delete confirmation.
    - Handlers: `handleEditProject`, `handleArchiveProject`, `handleDeleteProject`, `handleProjectSuccess` (mutates both SWR caches).

    Layout structure (per locked decisions):
    - **Top bar:** Keep existing search input and "Create Task" button. Add "Create Project" button (secondary/outline variant, with FolderPlus icon) next to "Create Task" (per locked decision: "Single 'Create Project' button at the top of the tasks page").
    - **Section blocks:** Two `SectionBlock` sections — Personal on top, Work below (per locked decision: "Stacked vertically — Personal section on top, Work section below, single scrollable page").
    - **Sections are always expanded, not collapsible** (per locked decision).

    `SectionBlock` inline component (or extracted):
    - Receives: section name ('personal'|'work'), all tasks, all projects, handlers.
    - Filters: `sectionTasks = tasks.filter(t => t.section === section)`, `standaloneTasks = sectionTasks.filter(t => !t.project_id)`, `sectionProjects = projects.filter(p => p.section === section)`.
    - Renders:
      1. Section header: h2 with section name (i18n: `t("sections.personal")` / `t("sections.work")`).
      2. Standalone tasks first (per locked decision: "Within each section: standalone tasks appear first, then project cards below"). Use existing TaskCard/TaskList for rendering standalone tasks in a grid.
      3. Project cards grid below: `grid gap-4 md:grid-cols-2 lg:grid-cols-3`. For each project, filter its tasks from sectionTasks by `project_id`.

    Handle search: The existing search filter should work across both sections and both standalone and project tasks. If search is active, filter tasks before passing to SectionBlock.

    Handle completed tasks: Keep existing pending/completed tab behavior. When "pending" tab is active, show only incomplete standalone tasks and exclude completed tasks from project previews (but keep progress counts accurate with all tasks). When "completed" tab is active, show completed standalone tasks.

    SWR cache invalidation after project mutations:
    - After any project CRUD (create, edit, archive, delete): call `projectsMutate()` to refetch projects.
    - After delete/archive: also call `tasksMutate()` because task project_id may have changed (delete nullifies it).

    **ProjectModal and ProjectDeleteDialog integration:**
    - Import and render ProjectModal and ProjectDeleteDialog at the page level.
    - Wire open/close state and success handlers.
    - ProjectModal `onSuccess`: mutate projects SWR cache.
    - ProjectDeleteDialog `onSuccess`: mutate both projects and tasks SWR caches.

    **Task list adjustment** (`components/tasks/task-list.tsx`):
    The existing `TaskList` component has its own internal pending/completed tabs (Tabs/TabsList/TabsTrigger) AND a search input with debounce. This conflicts with the new section-based layout where:
    - Pending/completed filtering is managed at the parent `tasks-page-content.tsx` level (top-bar tabs apply to the entire page, not per-section)
    - Search is also managed at the parent level (single search across both sections)

    **Resolution: Do NOT use TaskList inside SectionBlock.** Instead:
    1. Inside each `SectionBlock`, render standalone tasks directly as a grid of `TaskCard` components (imported from `components/tasks/task-card.tsx`), using the same grid layout: `grid gap-card-gap md:grid-cols-2 lg:grid-cols-3`.
    2. The parent `tasks-page-content.tsx` keeps the top-bar with pending/completed tabs and search input (lifted from TaskList's current implementation). The parent filters tasks by completion status and search query BEFORE passing them to SectionBlock.
    3. `TaskList` remains unchanged for backward compatibility but is no longer used on the tasks page. It may still be used elsewhere or removed in a future cleanup.
    4. For the empty state within a section, if a section has zero standalone tasks and zero projects, render the `TaskEmptyState` component with variant "no_tasks" inline.
  </action>
  <verify>
    - `pnpm lint` passes with no new errors
    - `pnpm test:run` passes (update any tasks-page-content tests if they exist)
    - Tasks page renders two section blocks (Personal on top, Work below)
    - ProjectCard shows left border color accent, progress bar, task previews with status dots
    - Three-dot menu on project cards works (Edit opens modal, Archive calls API, Delete opens confirmation)
    - "Create Project" button opens ProjectModal
    - Search filters across both sections
  </verify>
  <done>
    Tasks page redesigned with section-based layout: Personal on top, Work below, always expanded. Each section shows standalone tasks first, then project cards. ProjectCard has left border color accent + subtle tint, progress bar + X/Y done, up to 5 task previews (in-progress first with status dots), +N more indicator, three-dot menu (Edit/Archive/Delete), and "Open Board" button. Create Project button at page top opens ProjectModal. All project CRUD wired with SWR cache invalidation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create archived projects page</name>
  <files>
    components/projects/archived-projects-content.tsx
    app/projects/archived/page.tsx
    app/projects/archived/layout.tsx
  </files>
  <action>
    **Archived projects page layout** (`app/projects/archived/layout.tsx`):
    Server component. Wrap children in the SidebarShell layout (follow same pattern as `app/tasks/layout.tsx` or `app/habits/layout.tsx`). Import the appropriate layout wrapper.

    **Archived projects page** (`app/projects/archived/page.tsx`):
    Server component (per locked decision: "Archived projects accessed via a separate /projects/archived page").
    - Auth check: `createClient()` → `supabase.auth.getUser()` → redirect to login if not authenticated.
    - Render `ArchivedProjectsContent` client component.
    - Page metadata: title "Archived Projects" (i18n via `getTranslations`).

    **ArchivedProjectsContent** (`components/projects/archived-projects-content.tsx`):
    "use client" component.
    - Fetch archived projects via `useProjects({ status: 'archived' })`.
    - Display a list of archived project cards (simpler than active cards — just name, color accent, and task count).
    - Each card has a "Restore" button that PATCHes `/api/projects/[id]` with `{ status: 'active' }`. On success: toast + mutate SWR cache.
    - Empty state: "No archived projects" message with appropriate icon.
    - Page header: "Archived Projects" (i18n) with a back link to `/tasks`.
    - Use `useTranslations('projects.archived')` for text.
  </action>
  <verify>
    - `pnpm lint` passes with no new errors
    - `pnpm test:run` passes (no regressions)
    - `/projects/archived` page renders with correct layout
    - Archived projects show with Restore button
    - Restoring a project changes its status back to 'active'
    - Empty state shows when no archived projects exist
  </verify>
  <done>
    Archived projects page at /projects/archived with server auth check, SidebarShell layout, and client content component. Lists archived projects with name, color accent, and Restore button (PATCH to active). Empty state shown when no archived projects. All text translated via i18n.
  </done>
</task>

</tasks>

<verification>
- `pnpm test:run` — all tests pass
- `pnpm lint` — zero new lint errors
- Tasks page shows Personal section on top, Work section below
- Standalone tasks appear before project cards in each section
- Project cards are rich: color accent, progress, previews, menu
- Create Project button works at page level
- Archive sends project to archived page
- Delete shows confirmation, then orphans tasks
- /projects/archived page lists archived projects with restore
</verification>

<success_criteria>
- Tasks page has section-based layout (Personal top, Work bottom)
- Project cards show: name, color accent (left border + tint), progress bar, X/Y done, up to 5 task previews (in-progress first), +N more, three-dot menu, Open Board button
- Three-dot menu: Edit (opens modal), Archive (hides project), Delete (confirmation then orphan)
- Archived projects page at /projects/archived with restore functionality
- All SWR caches invalidated correctly after mutations
- No test regressions
</success_criteria>

<output>
After completion, create `.planning/phases/14-projects-sections/14-03-SUMMARY.md`
</output>
