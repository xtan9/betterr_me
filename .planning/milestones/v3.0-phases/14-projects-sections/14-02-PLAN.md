---
phase: 14-projects-sections
plan: 02
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - components/projects/project-modal.tsx
  - components/projects/project-color-picker.tsx
  - components/projects/project-delete-dialog.tsx
  - components/tasks/task-form.tsx
  - components/tasks/create-task-content.tsx
  - components/tasks/edit-task-content.tsx
  - lib/hooks/use-projects.ts
  - i18n/messages/en.json
  - i18n/messages/zh.json
  - i18n/messages/zh-TW.json
autonomous: true
requirements:
  - PROJ-01
  - PROJ-02
  - PROJ-03
  - PROJ-04
  - FORM-01
  - FORM-02

must_haves:
  truths:
    - "User can open a modal to create a project with name, section toggle, and color picker"
    - "User can edit a project's name, section, and color via the same modal"
    - "User sees a confirmation dialog before deleting a project"
    - "Task form shows a section toggle (Personal/Work) right after the title field"
    - "Task form shows a project dropdown filtered by the selected section"
    - "Switching section in the task form silently clears the selected project"
  artifacts:
    - path: "components/projects/project-modal.tsx"
      provides: "Create/edit project dialog"
      contains: "ProjectModal"
    - path: "components/projects/project-color-picker.tsx"
      provides: "Grid of 12 preset color swatches"
      contains: "ProjectColorPicker"
    - path: "components/projects/project-delete-dialog.tsx"
      provides: "Delete confirmation with explanation"
      contains: "ProjectDeleteDialog"
    - path: "components/tasks/task-form.tsx"
      provides: "Section toggle and project dropdown"
      contains: "ToggleGroup"
    - path: "lib/hooks/use-projects.ts"
      provides: "SWR hook for fetching projects"
      exports: ["useProjects"]
  key_links:
    - from: "components/projects/project-modal.tsx"
      to: "/api/projects"
      via: "fetch POST/PATCH"
      pattern: "fetch.*api/projects"
    - from: "components/tasks/task-form.tsx"
      to: "lib/hooks/use-projects.ts"
      via: "useProjects hook"
      pattern: "useProjects"
    - from: "components/tasks/task-form.tsx"
      to: "lib/projects/colors.ts"
      via: "Color dot rendering"
      pattern: "getProjectColor"
---

<objective>
Build project CRUD UI components (create/edit modal, color picker, delete dialog) and extend the task form with section toggle and project dropdown.

Purpose: Users need the ability to create/edit/delete projects through UI, and the task form needs section and project fields per user decisions. These components are consumed by the tasks page redesign in Plan 14-03.

Output: ProjectModal (create/edit), ProjectColorPicker, ProjectDeleteDialog, extended TaskForm with section toggle and project dropdown, useProjects SWR hook, and all i18n strings for three locales.
</objective>

<execution_context>
@/home/xingdi/.claude/get-shit-done/workflows/execute-plan.md
@/home/xingdi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-projects-sections/14-RESEARCH.md
@.planning/phases/14-projects-sections/14-01-SUMMARY.md
@components/tasks/task-form.tsx
@components/tasks/create-task-content.tsx
@components/tasks/edit-task-content.tsx
@lib/projects/colors.ts
@lib/validations/project.ts
@lib/validations/task.ts
@lib/db/types.ts
@i18n/messages/en.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create project UI components and useProjects hook</name>
  <files>
    components/projects/project-modal.tsx
    components/projects/project-color-picker.tsx
    components/projects/project-delete-dialog.tsx
    lib/hooks/use-projects.ts
  </files>
  <action>
    **useProjects SWR hook** (`lib/hooks/use-projects.ts`):
    Follow pattern from `lib/hooks/use-habits.ts`:
    - `useProjects(filters?: { section?: string; status?: string })`: Returns `{ projects, error, isLoading, mutate }`.
    - SWR key: `/api/projects?status=${status}&section=${section}` (omit params if not provided). Use `fetcher` from `@/lib/fetcher`.
    - Extract `projects` from response data (`data?.projects`).
    - Export the hook as named export.

    **ProjectColorPicker** (`components/projects/project-color-picker.tsx`):
    "use client" component.
    - Props: `value: string`, `onChange: (color: string) => void`
    - Render a CSS grid (4 columns) of circular color swatches from `PROJECT_COLORS`.
    - Each swatch: 32x32px circle with `backgroundColor: hsl(${color.hsl})`, border on selected state (ring-2 ring-offset-2). Use `useTheme()` from `next-themes` to choose `hsl` vs `hslDark`. Actually, simpler: use CSS `.dark` class approach: render both `hsl` and `hslDark` and select via Tailwind dark: variant. But since colors are dynamic HSL strings applied via `style`, use `useTheme()` to check `resolvedTheme === 'dark'` and pick `hslDark` vs `hsl`.
    - Add `aria-label` with color label for accessibility. Use `useTranslations('projects')` for label text.
    - Clicking a swatch calls `onChange(color.key)`.

    **ProjectModal** (`components/projects/project-modal.tsx`):
    "use client" component using Dialog from `components/ui/dialog`.
    - Props: `open: boolean`, `onOpenChange: (open: boolean) => void`, `project?: Project` (if editing), `onSuccess?: () => void`
    - Mode detection: `project` prop present = edit mode, absent = create mode.
    - Form using `react-hook-form` + `zodResolver(projectFormSchema)`:
      - Name input (text, max 50 chars)
      - Section toggle (ToggleGroup with 'personal' and 'work' items, per locked decision)
      - Color picker (ProjectColorPicker component)
    - Default values: create mode → { name: '', section: 'personal', color: 'blue' }; edit mode → project's current values.
    - Submit handler: `fetch` to POST /api/projects (create) or PATCH /api/projects/[id] (edit). On success: show toast (sonner), call `onSuccess()`, close dialog. On error: show error toast.
    - Dialog title: create mode → "Create Project" / edit mode → "Edit Project" (i18n keys: `projects.createTitle` / `projects.editTitle`).
    - Use `useTranslations('projects')` for all text.

    **ProjectDeleteDialog** (`components/projects/project-delete-dialog.tsx`):
    "use client" component using AlertDialog from `components/ui/alert-dialog`.
    - Props: `open: boolean`, `onOpenChange: (open: boolean) => void`, `projectName: string`, `projectId: string`, `onSuccess?: () => void`
    - Displays warning text explaining tasks will become standalone (per locked decision: "Tasks in this project will become standalone tasks in the same section").
    - Confirm button: DELETE /api/projects/[id]. On success: toast, call `onSuccess()`, close. On error: error toast.
    - Use `useTranslations('projects')` for all text.
    - Confirm button styled as destructive: `className="bg-destructive text-destructive-foreground"`.
  </action>
  <verify>
    - `pnpm lint` passes with no new errors
    - `pnpm test:run` passes (no regressions — these are new files, no tests yet)
    - All 4 files exist with correct exports
    - ProjectModal uses react-hook-form + zodResolver
    - ProjectDeleteDialog uses AlertDialog with destructive styling
    - useProjects hook follows SWR pattern with fetcher
  </verify>
  <done>
    ProjectModal (create/edit with form validation), ProjectColorPicker (12-swatch grid with dark mode support), ProjectDeleteDialog (confirmation with explanation text), and useProjects SWR hook all created. Components use Dialog/AlertDialog primitives, react-hook-form, Zod validation, sonner toasts, and next-intl translations.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend task form with section toggle and project dropdown, add all i18n strings</name>
  <files>
    components/tasks/task-form.tsx
    components/tasks/create-task-content.tsx
    components/tasks/edit-task-content.tsx
    i18n/messages/en.json
    i18n/messages/zh.json
    i18n/messages/zh-TW.json
  </files>
  <action>
    **Task form extension** (`components/tasks/task-form.tsx`):
    Add two new form fields right after the title field (per locked decision: "Section selector placed near the top of the form, right after task name"):

    1. **Section toggle** (FORM-01):
       - Use ToggleGroup (type="single") from `components/ui/toggle-group` with variant="outline".
       - Two items: "Personal" (value="personal") and "Work" (value="work"), each with flex-1 for equal width.
       - Default value: 'personal' (per locked decision).
       - Icons: User icon for Personal, Briefcase icon for Work (from lucide-react). Per research code example.
       - Register as `section` field in react-hook-form.
       - On value change: update `section` field AND clear `project_id` to null (per Claude's discretion: silent clear when section changes — see research Pattern 5).

    2. **Project dropdown** (FORM-02):
       - Use Select from `components/ui/select`.
       - Fetch projects via `useProjects()` hook.
       - Watch the `section` field: `const watchedSection = form.watch('section') ?? 'personal';`
       - Filter projects by section: `projects?.filter(p => p.section === watchedSection && p.status === 'active')`.
       - First option: "No Project" (value="none") — maps to null project_id.
       - Each project option: color dot (small circle with project color) + project name (per locked decision: "shows color dots next to project names").
       - Register as `project_id` field. Map "none" → null on change.
       - Optional field — task can be standalone.

    Ensure the form's `defaultValues` include `section` (default 'personal') and `project_id` (default null). Check that the existing form schema (`taskFormSchema` from `lib/validations/task.ts`) now includes these fields from Plan 14-01.

    **Create/Edit task content** (`components/tasks/create-task-content.tsx`, `components/tasks/edit-task-content.tsx`):
    - These wrapper components pass initial values to TaskForm.
    - Ensure `create-task-content.tsx` passes `section: 'personal'` and `project_id: null` as defaults.
    - Ensure `edit-task-content.tsx` passes the task's existing `section` and `project_id` values.
    - If these wrappers construct the initial form data, add section and project_id to that construction.

    **i18n strings** — Add ALL new strings needed for Phase 14 to all three locale files:

    In `en.json`, add a `projects` namespace:
    ```json
    "projects": {
      "createTitle": "Create Project",
      "editTitle": "Edit Project",
      "nameLabel": "Project Name",
      "namePlaceholder": "Enter project name",
      "sectionLabel": "Section",
      "colorLabel": "Color",
      "createButton": "Create Project",
      "saveButton": "Save Changes",
      "deleteTitle": "Delete Project",
      "deleteDescription": "Are you sure you want to delete \"{name}\"? Tasks in this project will become standalone tasks in the same section.",
      "confirmDelete": "Delete Project",
      "cancel": "Cancel",
      "archiveSuccess": "Project archived",
      "deleteSuccess": "Project deleted",
      "createSuccess": "Project created",
      "updateSuccess": "Project updated",
      "done": "done",
      "more": "more",
      "openBoard": "Open Board",
      "noTasks": "No tasks yet",
      "sections": {
        "personal": "Personal",
        "work": "Work"
      },
      "colors": {
        "blue": "Blue",
        "red": "Red",
        "green": "Green",
        "orange": "Orange",
        "purple": "Purple",
        "pink": "Pink",
        "teal": "Teal",
        "yellow": "Yellow",
        "indigo": "Indigo",
        "cyan": "Cyan",
        "slate": "Slate",
        "emerald": "Emerald"
      },
      "archived": {
        "title": "Archived Projects",
        "empty": "No archived projects",
        "restore": "Restore",
        "restoreSuccess": "Project restored"
      }
    }
    ```

    In the `tasks` namespace of `en.json`, add:
    ```json
    "sectionLabel": "Section",
    "projectLabel": "Project",
    "projectPlaceholder": "Select a project",
    "noProject": "No Project"
    ```

    Translate ALL new keys into `zh.json` (Simplified Chinese) and `zh-TW.json` (Traditional Chinese):
    - `projects.createTitle` → zh: "创建项目" / zh-TW: "建立專案"
    - `projects.editTitle` → zh: "编辑项目" / zh-TW: "編輯專案"
    - `projects.nameLabel` → zh: "项目名称" / zh-TW: "專案名稱"
    - `projects.sectionLabel` → zh: "分区" / zh-TW: "分區"
    - `projects.colorLabel` → zh: "颜色" / zh-TW: "顏色"
    - `projects.sections.personal` → zh: "个人" / zh-TW: "個人"
    - `projects.sections.work` → zh: "工作" / zh-TW: "工作"
    - `projects.deleteTitle` → zh: "删除项目" / zh-TW: "刪除專案"
    - `projects.deleteDescription` → zh: "确定要删除「{name}」吗？项目中的任务将变为同一分区中的独立任务。" / zh-TW: "確定要刪除「{name}」嗎？專案中的任務將變為同一分區中的獨立任務。"
    - All color names translated (blue=蓝色/藍色, red=红色/紅色, green=绿色/綠色, etc.)
    - All task form strings translated (sectionLabel=分区/分區, projectLabel=项目/專案, etc.)
    - All archived page strings translated
    - Translate every string — missing translations cause runtime fallback to keys.
  </action>
  <verify>
    - `pnpm lint` passes with no new errors
    - `pnpm test:run` passes (check for task form test updates needed — if existing tests break due to new form fields, update test mocks to include section/project_id defaults)
    - i18n: All three locale files have identical key structures for the new `projects` namespace
    - Task form renders section toggle before project dropdown, both after title field
    - Section toggle defaults to 'personal'
    - Project dropdown clears when section changes
  </verify>
  <done>
    Task form extended with section toggle (ToggleGroup, defaults to Personal) and project dropdown (Select, filtered by section, with color dots). Section switch silently clears project_id. All i18n strings added to en.json, zh.json, and zh-TW.json for projects namespace (CRUD labels, section names, color names, delete confirmation, archived page) and tasks namespace (section/project form fields). Create/edit task content components pass section and project_id values.
  </done>
</task>

</tasks>

<verification>
- `pnpm test:run` — all tests pass (existing + any updated form tests)
- `pnpm lint` — zero new lint errors
- ProjectModal renders name field, section toggle, color picker with 12 swatches
- ProjectDeleteDialog shows confirmation with explanation about standalone tasks
- TaskForm has section toggle right after title, project dropdown below it
- useProjects returns projects filtered by section/status
- All three locale files have complete project translations
</verification>

<success_criteria>
- ProjectModal creates/edits projects via API with form validation
- ProjectColorPicker shows 12 preset color swatches with dark mode support
- ProjectDeleteDialog warns about tasks becoming standalone
- Task form has section toggle (Personal default) and filtered project dropdown with color dots
- Section change clears project selection silently
- All UI strings translated in en, zh, zh-TW
- No test regressions
</success_criteria>

<output>
After completion, create `.planning/phases/14-projects-sections/14-02-SUMMARY.md`
</output>
