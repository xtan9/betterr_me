---
phase: 16-integration-bug-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/api/tasks/route.ts
  - app/api/tasks/[id]/route.ts
  - lib/db/types.ts
  - tests/app/api/tasks/route.test.ts
  - tests/app/api/tasks/[id]/route.test.ts
autonomous: true
requirements:
  - FORM-01
  - FORM-02
  - PROJ-01
  - PROJ-03
  - PAGE-01
  - PAGE-02

must_haves:
  truths:
    - "Creating a task with section=work via POST /api/tasks stores section='work' in the database"
    - "Creating a task with project_id via POST /api/tasks stores the project_id FK in the database"
    - "Editing a task's project_id via PATCH /api/tasks/[id] persists the change"
    - "Editing a task's project_id to null (unassign) via PATCH /api/tasks/[id] persists null"
    - "pnpm build succeeds without TypeScript errors in app/api/projects/route.ts"
  artifacts:
    - path: "app/api/tasks/route.ts"
      provides: "POST handler forwards section and project_id from validated body to TaskInsert"
      contains: "section: validation.data.section"
    - path: "app/api/tasks/[id]/route.ts"
      provides: "PATCH handler forwards project_id from validated body to updates object"
      contains: "updates.project_id = validation.data.project_id"
    - path: "lib/db/types.ts"
      provides: "ProjectInsert type with optional status and sort_order"
      contains: "status?: ProjectStatus"
    - path: "tests/app/api/tasks/route.test.ts"
      provides: "Unit tests for section and project_id forwarding in POST"
    - path: "tests/app/api/tasks/[id]/route.test.ts"
      provides: "Unit tests for project_id forwarding in PATCH"
  key_links:
    - from: "app/api/tasks/route.ts"
      to: "lib/db/types.ts"
      via: "TaskInsert type usage"
      pattern: "section: validation\\.data\\.section"
    - from: "app/api/tasks/[id]/route.ts"
      to: "lib/db/types.ts"
      via: "TaskUpdate type usage"
      pattern: "updates\\.project_id"
    - from: "app/api/projects/route.ts"
      to: "lib/db/types.ts"
      via: "ProjectInsert type usage — status must be optional"
      pattern: "createProject"
---

<objective>
Fix task API handlers to forward section and project_id fields, and fix ProjectInsert type to make status optional.

Purpose: POST /api/tasks silently drops `section` and `project_id` from validated request bodies, so tasks always get defaults instead of user selections. PATCH /api/tasks/[id] silently drops `project_id`, so task reassignment never persists. ProjectInsert requires `status` but POST /api/projects doesn't provide it, causing TypeScript build failure.

Output: Working POST/PATCH task endpoints that correctly persist section and project_id, ProjectInsert type that compiles without errors, and unit tests proving field forwarding.
</objective>

<execution_context>
@/home/xingdi/.claude/get-shit-done/workflows/execute-plan.md
@/home/xingdi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-integration-bug-fixes/16-RESEARCH.md

# Source files to fix
@app/api/tasks/route.ts
@app/api/tasks/[id]/route.ts
@lib/db/types.ts
@app/api/projects/route.ts

# Existing tests
@tests/app/api/tasks/route.test.ts
@tests/app/api/tasks/[id]/route.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Forward section and project_id in POST /api/tasks, forward project_id in PATCH /api/tasks/[id], fix ProjectInsert type</name>
  <files>
    app/api/tasks/route.ts
    app/api/tasks/[id]/route.ts
    lib/db/types.ts
  </files>
  <action>
    **Fix 1 — POST /api/tasks (app/api/tasks/route.ts, ~line 157-169):**
    Add `section` and `project_id` fields to the `taskData: TaskInsert` object:
    ```
    section: validation.data.section,
    project_id: validation.data.project_id ?? null,
    ```
    Insert these two lines after the `status: validation.data.status` line and before the `sort_order` line.

    **Fix 2 — PATCH /api/tasks/[id] (app/api/tasks/[id]/route.ts, after ~line 136):**
    Add project_id forwarding after the `sort_order` block:
    ```
    if (validation.data.project_id !== undefined) {
      updates.project_id = validation.data.project_id;
    }
    ```
    Insert this after the existing `if (validation.data.sort_order !== undefined)` block (around line 136).

    **Fix 3 — ProjectInsert type (lib/db/types.ts, ~line 99):**
    Change the ProjectInsert type to Omit both `status` and `sort_order` from the base type, then re-add them as optional:
    ```typescript
    export type ProjectInsert = Omit<Project, 'id' | 'created_at' | 'updated_at' | 'status' | 'sort_order'> & {
      id?: string;
      status?: ProjectStatus;
      sort_order?: number;
    };
    ```
    This fixes the TypeScript intersection issue where required `status` from `Omit<Project, ...>` couldn't be overridden by optional `status` in the intersection.

    **Why these specific fixes:** The Zod schemas already validate these fields. The problem is that the API handlers don't map validated fields into the DB insert/update objects. TaskInsert already has section and project_id as optional fields, so no type changes needed there. For ProjectInsert, the DB column has `DEFAULT 'active'`, so making the TypeScript type optional correctly reflects the DB behavior.
  </action>
  <verify>
    Run `pnpm build` — must succeed with zero TypeScript errors.
    Run `pnpm test:run -- tests/app/api/tasks/route.test.ts tests/app/api/tasks/\\[id\\]/route.test.ts tests/app/api/projects/route.test.ts` — all existing tests must still pass.
  </verify>
  <done>
    POST /api/tasks taskData object includes `section` and `project_id` from validation.data.
    PATCH /api/tasks/[id] updates object includes `project_id` when present in validation.data.
    ProjectInsert type has `status` and `sort_order` as truly optional fields.
    `pnpm build` succeeds.
    All existing tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add unit tests for section and project_id field forwarding</name>
  <files>
    tests/app/api/tasks/route.test.ts
    tests/app/api/tasks/[id]/route.test.ts
  </files>
  <action>
    **Tests for POST /api/tasks (tests/app/api/tasks/route.test.ts):**
    Add these test cases to the existing POST test suite:

    1. `'should create task with section=work when provided'` — POST with `{ title: "Test", section: "work" }`. Assert mockCreateTask was called with an object containing `section: "work"`.

    2. `'should create task with project_id when provided'` — POST with `{ title: "Test", project_id: "some-uuid" }`. Assert mockCreateTask was called with an object containing `project_id: "some-uuid"`.

    3. `'should create task with project_id=null when not provided'` — POST with `{ title: "Test" }` (no project_id). Assert mockCreateTask was called with an object containing `project_id: null`.

    **Tests for PATCH /api/tasks/[id] (tests/app/api/tasks/[id]/route.test.ts):**
    Add these test cases to the existing PATCH test suite:

    4. `'should update project_id when provided'` — PATCH with `{ project_id: "some-uuid" }`. Assert mockUpdateTask was called with updates containing `project_id: "some-uuid"`.

    5. `'should clear project_id when set to null'` — PATCH with `{ project_id: null }`. Assert mockUpdateTask was called with updates containing `project_id: null`.

    **Use existing mocking patterns:** Follow the same `vi.hoisted` + mock DB class pattern already in these test files. Use `expect(mockFn).toHaveBeenCalledWith(expect.objectContaining({ field: value }))` for assertions.

    **Important:** Do not break or modify existing tests. Only add new test cases.
  </action>
  <verify>
    Run `pnpm test:run -- tests/app/api/tasks/route.test.ts tests/app/api/tasks/\\[id\\]/route.test.ts` — all tests pass including the new ones.
    Run `pnpm test:run` — full test suite passes (no regressions).
  </verify>
  <done>
    5 new unit tests prove that:
    - POST /api/tasks forwards section=work to DB layer
    - POST /api/tasks forwards project_id to DB layer
    - POST /api/tasks defaults project_id to null when not provided
    - PATCH /api/tasks/[id] forwards project_id to DB layer
    - PATCH /api/tasks/[id] can clear project_id by setting it to null
    All existing tests continue to pass.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` succeeds with zero errors
2. `pnpm test:run` — full test suite passes
3. `pnpm lint` — no lint errors
4. New tests explicitly verify section and project_id are forwarded through POST and PATCH handlers
</verification>

<success_criteria>
- POST /api/tasks correctly forwards `section` and `project_id` from validated request body to TaskInsert
- PATCH /api/tasks/[id] correctly forwards `project_id` from validated request body to updates
- ProjectInsert type makes `status` and `sort_order` truly optional (fixing pnpm build)
- 5 new unit tests pass, proving field forwarding works
- Full test suite passes with no regressions
</success_criteria>

<output>
After completion, create `.planning/phases/16-integration-bug-fixes/16-01-SUMMARY.md`
</output>
