---
phase: 03-code-quality
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - lib/cache.ts
  - tests/lib/cache.test.ts
  - app/api/habits/[id]/stats/route.ts
  - app/api/habits/[id]/route.ts
  - app/api/habits/[id]/toggle/route.ts
  - app/api/profile/preferences/route.ts
  - tests/app/api/habits/[id]/stats/route.test.ts
  - tests/app/api/habits/[id]/route.test.ts
  - tests/app/api/habits/[id]/toggle/route.test.ts
  - tests/app/api/profile/preferences/route.test.ts
  - app/api/dashboard/route.ts
  - lib/db/types.ts
  - app/api/habits/route.ts
  - app/api/habits/[id]/logs/route.ts
  - app/api/tasks/route.ts
  - app/api/tasks/[id]/route.ts
  - app/api/tasks/[id]/toggle/route.ts
  - app/api/insights/weekly/route.ts
  - app/api/export/route.ts
  - app/api/profile/route.ts
  - lib/validations/api.ts
  - lib/auth/redirect.ts
autonomous: true

must_haves:
  truths:
    - "The file lib/cache.ts does not exist and no imports reference it anywhere in the codebase"
    - "No console.log statements exist in theme-switcher.tsx or auth/callback/route.ts"
    - "When computeMissedDays encounters an error, the dashboard response includes a _warnings array and the error is logged via the logger module"
    - "All server-side API routes use log.error from lib/logger.ts instead of console.error"
    - "The validation helper and auth redirect module use log.warn instead of console.warn"
  artifacts:
    - path: "lib/db/types.ts"
      provides: "DashboardData with optional _warnings field"
      contains: "_warnings"
    - path: "app/api/dashboard/route.ts"
      provides: "Dashboard route with _warnings pattern and log.error for computeMissedDays"
      contains: "_warnings"
  key_links:
    - from: "app/api/dashboard/route.ts"
      to: "lib/logger.ts"
      via: "import { log } from '@/lib/logger'"
      pattern: "import.*log.*from.*@/lib/logger"
    - from: "app/api/habits/[id]/stats/route.ts"
      to: "lib/logger.ts"
      via: "import for log.error in catch block"
      pattern: "import.*log.*from.*@/lib/logger"
    - from: "app/api/habits/[id]/stats/route.ts"
      to: "lib/cache.ts"
      via: "REMOVED - no import should exist"
      pattern: "cache"
---

<objective>
Remove the dead in-memory cache module and all references, add the `_warnings` convention to the dashboard route for graceful degradation, and convert all server-side console.error/console.warn calls to use the logger module.

Purpose: Eliminates dead code (cache is useless on serverless), surfaces errors visibly via `_warnings` instead of silently swallowing them (QUAL-06), and establishes consistent logging across all API routes for future Sentry integration.
Output: Cache deleted, dashboard has `_warnings`, all server-side routes use `log.error`/`log.warn`.
</objective>

<execution_context>
@/home/xingdi/.claude/get-shit-done/workflows/execute-plan.md
@/home/xingdi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-code-quality/03-CONTEXT.md
@.planning/phases/03-code-quality/03-RESEARCH.md
@.planning/phases/03-code-quality/03-01-SUMMARY.md
@lib/cache.ts
@app/api/dashboard/route.ts
@app/api/habits/[id]/stats/route.ts
@lib/db/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove in-memory cache module and all references</name>
  <files>lib/cache.ts, tests/lib/cache.test.ts, app/api/habits/[id]/stats/route.ts, app/api/habits/[id]/route.ts, app/api/habits/[id]/toggle/route.ts, app/api/profile/preferences/route.ts, tests/app/api/habits/[id]/stats/route.test.ts, tests/app/api/habits/[id]/route.test.ts, tests/app/api/habits/[id]/toggle/route.test.ts, tests/app/api/profile/preferences/route.test.ts</files>
  <action>
**Delete files:**
- `lib/cache.ts` -- the entire TTLCache module
- `tests/lib/cache.test.ts` -- tests for the deleted module

**Update production files (remove cache imports and usage):**

1. `app/api/habits/[id]/stats/route.ts`:
   - Remove `import { statsCache, getStatsCacheKey } from '@/lib/cache';`
   - Remove the server-side cache check block (lines ~40-56: `statsCache.delete(...)` in 404 handler, `const cacheKey = ...`, `const cachedStats = statsCache.get(...)`, the entire `if (cachedStats)` early return)
   - Remove `statsCache.set(cacheKey, responseData);` after computation
   - Remove the `'X-Cache': 'HIT'` and `'X-Cache': 'MISS'` headers
   - Keep the `Cache-Control: private, max-age=${CACHE_MAX_AGE}` header and the `CACHE_MAX_AGE` constant -- HTTP caching is still useful
   - Remove the JSDoc mention of server-side in-memory cache; update to only mention HTTP Cache-Control

2. `app/api/habits/[id]/route.ts`:
   - Remove `import { invalidateStatsCache } from '@/lib/cache';`
   - Remove all three `invalidateStatsCache(id, user.id);` calls (in PATCH success, DELETE start, and DELETE success)

3. `app/api/habits/[id]/toggle/route.ts`:
   - Remove `import { invalidateStatsCache } from '@/lib/cache';`
   - Remove the `invalidateStatsCache(habitId, user.id);` call after toggle

4. `app/api/profile/preferences/route.ts`:
   - Remove `import { invalidateUserStatsCache } from '@/lib/cache';`
   - Remove the `invalidateUserStatsCache(user.id);` call when week_start_day changes

**Update test files (remove cache imports and cache-related tests):**

1. `tests/app/api/habits/[id]/stats/route.test.ts`:
   - Remove `import { statsCache } from '@/lib/cache';`
   - Remove any `statsCache.clear()` in `beforeEach`
   - Remove or update tests that assert `X-Cache: HIT`/`MISS` headers -- these headers no longer exist. Keep tests that verify stats computation and `Cache-Control` header.

2. `tests/app/api/habits/[id]/route.test.ts`:
   - Remove `import { statsCache, getStatsCacheKey } from '@/lib/cache';`
   - Remove any `statsCache.clear()` in `beforeEach`
   - Remove tests that assert cache invalidation behavior (e.g., "invalidates stats cache on update", "invalidates stats cache on delete"). The underlying behavior (update/delete succeeding) is still tested by other assertions.

3. `tests/app/api/habits/[id]/toggle/route.test.ts`:
   - Remove `import { statsCache, getStatsCacheKey } from '@/lib/cache';`
   - Remove any `statsCache.clear()` in `beforeEach`
   - Remove cache invalidation test assertions

4. `tests/app/api/profile/preferences/route.test.ts`:
   - Remove `import { statsCache, getStatsCacheKey } from '@/lib/cache';`
   - Remove any `statsCache.clear()` in `beforeEach`
   - Remove cache invalidation test assertions
  </action>
  <verify>
Run `pnpm test:run` -- all tests pass (no broken imports).
Run `npx tsc --noEmit` -- compiles cleanly.
Verify `lib/cache.ts` does not exist: `ls lib/cache.ts` should fail.
Verify no remaining cache imports: `grep -r "from.*@/lib/cache" --include="*.ts" --include="*.tsx" .` (excluding .planning/) returns nothing.
  </verify>
  <done>
`lib/cache.ts` and `tests/lib/cache.test.ts` are deleted. No file in the codebase imports from `@/lib/cache`. All route files compile and all tests pass. HTTP `Cache-Control` headers are preserved on the stats route.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add _warnings to dashboard and fix computeMissedDays error handling (QUAL-06)</name>
  <files>app/api/dashboard/route.ts, lib/db/types.ts</files>
  <action>
**lib/db/types.ts:**
Add an optional `_warnings?: string[]` field to the `DashboardData` interface. Place it after the `stats` field with a comment: `/** Non-fatal warnings about degraded data (omitted when empty) */`.

**app/api/dashboard/route.ts:**
1. Add `import { log } from '@/lib/logger';` at the top.
2. Declare `const warnings: string[] = [];` before the enrichment loop.
3. Update the `computeMissedDays` catch block (currently line ~107-110):
   - Replace `console.error('computeMissedDays failed for habit', habit.id, err)` with `log.error('computeMissedDays failed', err, { userId: user.id, habitId: habit.id, date, dateRange: \`${thirtyDaysAgoStr} to ${date}\` })` -- per user decision: "log error message plus relevant context (user ID, date range, habit IDs involved)".
   - Add `warnings.push(\`Absence data unavailable for habit ${habit.id}\`);`
   - Keep `return { ...habit, missed_scheduled_days: 0, previous_streak: 0 };` -- zeros are the mathematical identity and there is no cached prior value available. Document this with a comment: `// Zeros as fallback: no prior cached value available (see RESEARCH.md Pitfall 5)`.

4. Update the two supplementary query catch blocks:
   - `Failed to fetch habit logs` -> `log.error('Failed to fetch habit logs for absence', err, { userId: user.id, date })`
   - `Failed to fetch milestones` -> `log.error('Failed to fetch milestones', err, { userId: user.id, date })`

5. Update the top-level catch block: `console.error('GET /api/dashboard error:', error)` -> `log.error('GET /api/dashboard error', error)`

6. Spread `_warnings` into the response only when non-empty:
   ```typescript
   const dashboardData: DashboardData = {
     habits: enrichedHabits,
     tasks_today: todayTasks,
     tasks_tomorrow: tasksTomorrow,
     milestones_today: milestonesToday,
     stats: { ... },
     ...(warnings.length > 0 && { _warnings: warnings }),
   };
   ```

Note: The `_warnings` pattern is established as a reusable convention per user decision. The underscore prefix signals metadata. Only present when there are warnings -- no empty array noise in normal responses.

Note on "stale data" fallback: The user decision says "show last known good / stale data if available." There is no caching mechanism to provide stale data at this point. The zeros remain as the safest fallback (mathematical identity for missed days). The _warnings field makes the degradation visible. Document this limitation in a code comment.
  </action>
  <verify>
Run `npx tsc --noEmit` -- compiles cleanly (DashboardData updated).
Run `pnpm vitest run tests/app/api/dashboard/route.test.ts` -- existing tests pass.
Grep `app/api/dashboard/route.ts` for `console.error` -- should find zero matches.
Grep `app/api/dashboard/route.ts` for `_warnings` -- should find at least one match.
Grep `app/api/dashboard/route.ts` for `log.error` -- should find at least 3 matches.
  </verify>
  <done>
Dashboard route uses `log.error` with full context for all error paths. `computeMissedDays` failures add to `_warnings` array. `DashboardData` type includes optional `_warnings`. No `console.error` remains in the dashboard route.
  </done>
</task>

<task type="auto">
  <name>Task 3: Convert all server-side console.error/console.warn to logger</name>
  <files>app/api/habits/route.ts, app/api/habits/[id]/route.ts, app/api/habits/[id]/stats/route.ts, app/api/habits/[id]/toggle/route.ts, app/api/habits/[id]/logs/route.ts, app/api/tasks/route.ts, app/api/tasks/[id]/route.ts, app/api/tasks/[id]/toggle/route.ts, app/api/insights/weekly/route.ts, app/api/export/route.ts, app/api/profile/route.ts, app/api/profile/preferences/route.ts, lib/validations/api.ts, lib/auth/redirect.ts</files>
  <action>
Add `import { log } from '@/lib/logger';` to each file listed below, then convert console calls:

**Convert console.error to log.error (API route catch blocks):**

| File | Current | Replacement |
|------|---------|-------------|
| `app/api/habits/route.ts` (line ~63) | `console.error('GET /api/habits error:', error)` | `log.error('GET /api/habits error', error)` |
| `app/api/habits/route.ts` (line ~114) | `console.error('POST /api/habits error:', error)` | `log.error('POST /api/habits error', error)` |
| `app/api/habits/[id]/route.ts` (line ~37) | `console.error(...)` | `log.error('GET /api/habits/[id] error', error)` |
| `app/api/habits/[id]/route.ts` (line ~105) | `console.error(...)` | `log.error('PATCH /api/habits/[id] error', error)` |
| `app/api/habits/[id]/route.ts` (line ~154) | `console.error(...)` | `log.error('DELETE /api/habits/[id] error', error)` |
| `app/api/habits/[id]/stats/route.ts` (line ~88) | `console.error(...)` | `log.error('GET /api/habits/[id]/stats error', error)` |
| `app/api/habits/[id]/toggle/route.ts` (line ~60) | `console.error(...)` (milestone) | `log.error('Milestone check failed', error, { habitId })` |
| `app/api/habits/[id]/toggle/route.ts` (line ~71) | `console.error(...)` | `log.error('POST /api/habits/[id]/toggle error', error)` |
| `app/api/habits/[id]/logs/route.ts` (line ~76) | `console.error(...)` | `log.error('GET /api/habits/[id]/logs error', error)` |
| `app/api/tasks/route.ts` (line ~81) | `console.error(...)` | `log.error('GET /api/tasks error', error)` |
| `app/api/tasks/route.ts` (line ~129) | `console.error(...)` | `log.error('POST /api/tasks error', error)` |
| `app/api/tasks/[id]/route.ts` (line ~36) | `console.error(...)` | `log.error('GET /api/tasks/[id] error', error)` |
| `app/api/tasks/[id]/route.ts` (line ~110) | `console.error(...)` | `log.error('PATCH /api/tasks/[id] error', error)` |
| `app/api/tasks/[id]/route.ts` (line ~147) | `console.error(...)` | `log.error('DELETE /api/tasks/[id] error', error)` |
| `app/api/tasks/[id]/toggle/route.ts` (line ~28) | `console.error(...)` | `log.error('PATCH /api/tasks/[id]/toggle error', error)` |
| `app/api/insights/weekly/route.ts` (line ~14) | `console.error(...)` (auth) | `log.error('Auth error in weekly insights', error)` |
| `app/api/insights/weekly/route.ts` (line ~41) | `console.error(...)` | `log.error('GET /api/insights/weekly error', error)` |
| `app/api/export/route.ts` (line ~179) | `console.error(...)` | `log.error('GET /api/export error', error)` |
| `app/api/profile/route.ts` (line ~32) | `console.error(...)` | `log.error('GET /api/profile error', error)` |
| `app/api/profile/route.ts` (line ~80) | `console.error(...)` | `log.error('PATCH /api/profile error', error)` |
| `app/api/profile/preferences/route.ts` (line ~40) | `console.error(...)` | `log.error('PATCH /api/profile/preferences error', error)` |

**Convert console.warn to log.warn (utility modules):**

| File | Current | Replacement |
|------|---------|-------------|
| `lib/validations/api.ts` (line ~31) | `console.warn("Validation failed:", ...)` | `log.warn('Validation failed', { path: ..., errors: ... })` -- preserve the validation error details as context |
| `lib/auth/redirect.ts` (line ~49) | `console.warn("Blocked redirect to disallowed path:", ...)` | `log.warn('Blocked redirect to disallowed path', { path })` -- security-relevant, keep |

**DO NOT convert client-side console.error calls** in `components/` files. Those are captured by Sentry browser SDK automatically. Only convert server-side API routes and lib modules.

**DO NOT convert e2e/ or scripts/ console calls** -- those are test/dev infrastructure.

For each route-level catch block, the pattern is simple: `console.error('message:', error)` becomes `log.error('message', error)`. Remove the trailing colon from messages since the logger handles formatting.
  </action>
  <verify>
Run `pnpm test:run` -- all tests pass.
Run `npx tsc --noEmit` -- compiles cleanly.
Run `pnpm lint` -- no lint errors.
Verify no remaining server-side console.error/console.warn in API routes:
  `grep -rn "console\.\(error\|warn\)" app/api/ lib/validations/ lib/auth/` -- should return zero matches.
Verify all API routes import from logger:
  `grep -rn "from.*@/lib/logger" app/api/` -- should find imports in all route files.
  </verify>
  <done>
All ~20 server-side `console.error` calls converted to `log.error`. Both `console.warn` calls converted to `log.warn`. No `console.error` or `console.warn` remains in `app/api/` or relevant `lib/` modules. Client-side component code left untouched. All tests pass, TypeScript compiles, lint clean.
  </done>
</task>

</tasks>

<verification>
1. `pnpm test:run` passes (all tests, no broken imports from cache removal)
2. `npx tsc --noEmit` passes
3. `pnpm lint` passes
4. `ls lib/cache.ts` fails (file deleted)
5. `grep -r "from.*@/lib/cache" --include="*.ts" --include="*.tsx" .` returns nothing (excluding .planning/)
6. `grep -rn "console\.\(error\|warn\|log\)" app/api/ lib/validations/ lib/auth/ lib/cache.ts 2>/dev/null` returns nothing
7. `grep -rn "_warnings" app/api/dashboard/route.ts lib/db/types.ts` shows the pattern
8. `grep -rn "from.*@/lib/logger" app/api/` shows imports in all route files
</verification>

<success_criteria>
- lib/cache.ts deleted, tests/lib/cache.test.ts deleted
- Zero imports of @/lib/cache anywhere in the codebase
- HTTP Cache-Control headers preserved on stats route
- DashboardData type has optional _warnings field
- Dashboard route logs computeMissedDays errors with full context via log.error
- Dashboard route includes _warnings in response when errors occur
- All server-side API routes use log.error instead of console.error
- lib/validations/api.ts and lib/auth/redirect.ts use log.warn instead of console.warn
- Client-side component console.error calls remain unchanged
- All tests pass, TypeScript compiles, lint clean
</success_criteria>

<output>
After completion, create `.planning/phases/03-code-quality/03-02-SUMMARY.md`
</output>
