---
phase: 02-security-and-validation
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - app/api/habits/route.ts
  - app/api/habits/[id]/route.ts
  - app/api/tasks/route.ts
  - app/api/tasks/[id]/route.ts
  - app/api/profile/route.ts
  - app/api/profile/preferences/route.ts
  - tests/app/api/habits/route.test.ts
  - tests/app/api/tasks/route.test.ts
  - tests/app/api/habits/[id]/route.test.ts
  - tests/app/api/tasks/[id]/route.test.ts
  - tests/app/api/profile/route.test.ts
  - tests/app/api/profile/preferences/route.test.ts
autonomous: true

must_haves:
  truths:
    - "Sending a POST/PATCH request with an oversized name (>100 chars) or description (>500 chars) to any API route returns a 400 validation error"
    - "Sending a PATCH request with only a subset of fields succeeds (partial update via .partial() Zod schema)"
    - "A user signing up via OAuth without an email address does not crash profile auto-creation"
    - "Attempting to create a 21st habit returns a 400 error with a clear message about the 20-habit limit"
    - "Hand-rolled isValidFrequency function is removed from both habit route files"
  artifacts:
    - path: "app/api/habits/route.ts"
      provides: "Zod-validated habit POST with ensureProfile and habit count limit"
      contains: "validateRequestBody"
    - path: "app/api/habits/[id]/route.ts"
      provides: "Zod-validated habit PATCH with habitUpdateSchema"
      contains: "validateRequestBody"
    - path: "app/api/tasks/route.ts"
      provides: "Zod-validated task POST with ensureProfile"
      contains: "validateRequestBody"
    - path: "app/api/tasks/[id]/route.ts"
      provides: "Zod-validated task PATCH with taskUpdateSchema"
      contains: "validateRequestBody"
    - path: "app/api/profile/route.ts"
      provides: "Zod-validated profile PATCH with profileUpdateSchema"
      contains: "validateRequestBody"
    - path: "app/api/profile/preferences/route.ts"
      provides: "Zod-validated preferences PATCH with preferencesSchema"
      contains: "validateRequestBody"
  key_links:
    - from: "app/api/habits/route.ts"
      to: "lib/validations/api.ts"
      via: "import validateRequestBody"
      pattern: "import.*validateRequestBody.*from.*lib/validations/api"
    - from: "app/api/habits/route.ts"
      to: "lib/db/ensure-profile.ts"
      via: "import ensureProfile"
      pattern: "import.*ensureProfile.*from.*lib/db/ensure-profile"
    - from: "app/api/habits/route.ts"
      to: "lib/constants.ts"
      via: "import MAX_HABITS_PER_USER"
      pattern: "MAX_HABITS_PER_USER"
    - from: "app/api/tasks/route.ts"
      to: "lib/db/ensure-profile.ts"
      via: "import ensureProfile"
      pattern: "import.*ensureProfile.*from.*lib/db/ensure-profile"
---

<objective>
Wire Zod validation into all 6 POST/PATCH API routes, replace hand-rolled validators, add ensureProfile to creation routes, and enforce 20-habit limit. Update all affected tests.

Purpose: Every API route boundary validates input with Zod schemas, preventing invalid data from reaching the database layer. Profile auto-creation handles missing OAuth email safely.

Output: 6 updated API routes, 6 updated test files. Zero hand-rolled validation remaining in API routes.
</objective>

<execution_context>
@/home/xingdi/.claude/get-shit-done/workflows/execute-plan.md
@/home/xingdi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-security-and-validation/02-RESEARCH.md
@.planning/phases/02-security-and-validation/02-01-SUMMARY.md
@app/api/habits/route.ts
@app/api/habits/[id]/route.ts
@app/api/tasks/route.ts
@app/api/tasks/[id]/route.ts
@app/api/profile/route.ts
@app/api/profile/preferences/route.ts
@tests/app/api/habits/route.test.ts
@tests/app/api/tasks/route.test.ts
@tests/app/api/habits/[id]/route.test.ts
@tests/app/api/tasks/[id]/route.test.ts
@tests/app/api/profile/route.test.ts
@tests/app/api/profile/preferences/route.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire Zod validation into habits and tasks routes (POST + PATCH)</name>
  <files>
    app/api/habits/route.ts
    app/api/habits/[id]/route.ts
    app/api/tasks/route.ts
    app/api/tasks/[id]/route.ts
  </files>
  <action>
**app/api/habits/route.ts (POST):**
- Import `validateRequestBody` from `@/lib/validations/api`
- Import `habitFormSchema` from `@/lib/validations/habit`
- Import `ensureProfile` from `@/lib/db/ensure-profile`
- Import `MAX_HABITS_PER_USER` from `@/lib/constants`
- Remove `VALID_CATEGORIES`, `VALID_FREQUENCY_TYPES` constants and `isValidFrequency()` function entirely
- Replace all hand-rolled validation (name check, frequency check, category check) with: `const validation = validateRequestBody(body, habitFormSchema); if (!validation.success) return validation.response;`
- Replace inline profile auto-creation block (the `user.email!` non-null assertion code) with: `await ensureProfile(supabase, user);`
- Add habit count limit check AFTER ensureProfile, BEFORE createHabit:
  ```
  const activeCount = await habitsDB.getActiveHabitCount(user.id);
  if (activeCount >= MAX_HABITS_PER_USER) {
    return NextResponse.json(
      { error: `You have ${activeCount}/${MAX_HABITS_PER_USER} habits. Remove one before adding another.` },
      { status: 400 }
    );
  }
  ```
  (Per locked decision: message includes current count, uses named constant)
- Use `validation.data` for building `habitData` instead of `body.*`
- Keep the GET handler unchanged (it doesn't need body validation)

**app/api/habits/[id]/route.ts (PATCH):**
- Import `validateRequestBody` from `@/lib/validations/api`
- Import `habitUpdateSchema` from `@/lib/validations/habit`
- Remove `VALID_CATEGORIES`, `VALID_STATUSES`, `VALID_FREQUENCY_TYPES` constants and `isValidFrequency()` function
- Replace all hand-rolled field-by-field validation with: `const validation = validateRequestBody(body, habitUpdateSchema); if (!validation.success) return validation.response;`
- Build `updates` from `validation.data` instead of `body.*`
- Keep the `paused_at` business logic: if `validation.data.status === 'paused'`, set `updates.paused_at = new Date().toISOString()`; if `'active'`, set `updates.paused_at = null`
- Keep GET and DELETE handlers unchanged
- Keep `invalidateStatsCache` import and usage (it will be removed in Phase 3, not now)

**app/api/tasks/route.ts (POST):**
- Import `validateRequestBody` from `@/lib/validations/api`
- Import `taskFormSchema` from `@/lib/validations/task`
- Import `ensureProfile` from `@/lib/db/ensure-profile` (tasks also have FK to profiles)
- Replace hand-rolled validation (title check, priority check) with: `const validation = validateRequestBody(body, taskFormSchema); if (!validation.success) return validation.response;`
- Add `await ensureProfile(supabase, user);` before `tasksDB.createTask`
- Need to get the user object: the current code destructures `user` from `supabase.auth.getUser()` -- add `const { data: { user } } = await supabase.auth.getUser();` if not already done (it IS already done)
- Use `validation.data` for building `taskData`
- Keep GET handler unchanged

**app/api/tasks/[id]/route.ts (PATCH):**
- Import `validateRequestBody` from `@/lib/validations/api`
- Import `taskUpdateSchema` from `@/lib/validations/task`
- Replace all hand-rolled field-by-field validation with: `const validation = validateRequestBody(body, taskUpdateSchema); if (!validation.success) return validation.response;`
- Build `updates` from `validation.data`
- Keep the `is_completed` business logic: if `validation.data.is_completed !== undefined`, set `updates.completed_at` accordingly
- Keep GET and DELETE handlers unchanged

IMPORTANT: The error response format CHANGES from `{ error: 'Name is required' }` to `{ error: 'Validation failed', details: { name: ['Required'] } }`. This means tests must be updated in Task 2.
  </action>
  <verify>
Run `pnpm build` to confirm no TypeScript errors. Do NOT run tests yet -- test assertions for error messages will fail until Task 2 updates them.
  </verify>
  <done>
All 4 route files use `validateRequestBody` with Zod schemas. No `isValidFrequency()` function exists anywhere. No `VALID_CATEGORIES` or `VALID_FREQUENCY_TYPES` constants remain in route files. Habit POST has ensureProfile + habit count limit. Task POST has ensureProfile.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire Zod into profile routes and update ALL affected tests</name>
  <files>
    app/api/profile/route.ts
    app/api/profile/preferences/route.ts
    tests/app/api/habits/route.test.ts
    tests/app/api/tasks/route.test.ts
    tests/app/api/habits/[id]/route.test.ts
    tests/app/api/tasks/[id]/route.test.ts
    tests/app/api/profile/route.test.ts
    tests/app/api/profile/preferences/route.test.ts
  </files>
  <action>
**app/api/profile/route.ts (PATCH):**
- Import `validateRequestBody` from `@/lib/validations/api`
- Import `profileUpdateSchema` from `@/lib/validations/profile`
- Replace hand-rolled field-by-field validation with: `const validation = validateRequestBody(body, profileUpdateSchema); if (!validation.success) return validation.response;`
- Build `updates` from `validation.data`
- Keep GET handler unchanged

**app/api/profile/preferences/route.ts (PATCH):**
- Import `validateRequestBody` from `@/lib/validations/api`
- Import `preferencesSchema` from `@/lib/validations/preferences`
- Replace ALL hand-rolled validation (typeof checks, parseInt, includes checks) with: `const validation = validateRequestBody(body, preferencesSchema); if (!validation.success) return validation.response;`
- Use `validation.data` to build the preferences update object
- Keep `invalidateUserStatsCache` import and usage (Phase 3 removes cache)

**Update ALL test files** to reflect the new Zod error response format:

For each test file, the key changes are:
1. Tests asserting `data.error === 'Title is required'` or `data.error === 'Name is required'` etc must now assert `data.error === 'Validation failed'` and optionally check `data.details` for field-level errors
2. Tests asserting `data.error` contains specific strings like 'frequency' must check `data.error === 'Validation failed'` instead
3. Status code assertions (400, 401, 500) should remain the same
4. Tests for successful operations should remain unchanged
5. Add new test for habit count limit: when `getActiveHabitCount` returns 20, POST should return 400 with message matching `You have 20/20 habits`
6. Add new test for ensureProfile being called in habits POST and tasks POST
7. The profile auto-creation test in habits route.test.ts needs updating: mock `ensureProfile` instead of inline Supabase calls. Add a `vi.mock('@/lib/db/ensure-profile')` mock.
8. The profile creation failure test should mock `ensureProfile` to throw and verify 500 response

Specific test changes for `tests/app/api/habits/route.test.ts`:
- Mock `@/lib/db/ensure-profile` module with `vi.mock`
- Mock `@/lib/constants` to export `MAX_HABITS_PER_USER: 20`
- Add `mockGetActiveHabitCount` to the HabitsDB mock class
- Default `mockGetActiveHabitCount` to resolve with 0 (under limit)
- Update "should return 400 if name is missing" -- assert `data.error === 'Validation failed'`
- Update "should return 400 if frequency is missing" -- assert `data.error === 'Validation failed'` (not contains 'frequency')
- Update "should return 400 if frequency type is invalid" -- assert status 400
- Update "should return 400 if category is invalid" -- assert status 400
- Update "should return 400 for whitespace-only name" -- assert status 400
- Update "should auto-create profile" test to verify `ensureProfile` was called (not inline Supabase profile insert)
- Update "should return 500 when profile creation fails" to mock `ensureProfile` throwing
- Add test: "should return 400 when habit limit reached" -- mock `getActiveHabitCount` returning 20, assert response contains `You have 20/20 habits`
- Simplify `mockSupabaseClient` -- no longer needs `profileData` param since profile creation is handled by `ensureProfile`

Specific test changes for `tests/app/api/tasks/route.test.ts`:
- Mock `@/lib/db/ensure-profile` module
- Update "should return 400 if title is missing" -- assert `data.error === 'Validation failed'` (not `'Title is required'`)
- Update "should return 400 if priority is invalid" -- assert `data.error === 'Validation failed'` (not `'Priority must be 0-3'`)

For test files in `[id]/` directories and profile directories: read the existing tests first, then update any assertions that check specific hand-rolled error messages to use the new Zod format.

Run all tests frequently during this task. Fix test failures iteratively.
  </action>
  <verify>
Run `pnpm test:run` -- ALL tests must pass. Run `pnpm lint` -- no lint errors. Run `pnpm build` -- clean build.
  </verify>
  <done>
All 6 API routes use Zod validation via `validateRequestBody`. All test files pass with updated assertions. Habit count limit test exists and passes. ensureProfile mock tests exist and pass. No hand-rolled validation remains in any API route. `pnpm test:run` and `pnpm build` both pass cleanly.
  </done>
</task>

</tasks>

<verification>
- `pnpm build` passes
- `pnpm test:run` passes (all existing + new tests)
- `pnpm lint` passes
- Manual check: `grep -r "isValidFrequency" app/` returns nothing (hand-rolled validators removed)
- Manual check: `grep -r "VALID_CATEGORIES" app/api/` returns nothing (constants removed from routes)
- Manual check: `grep -r "validateRequestBody" app/api/` returns 6 matches (one per route file with POST/PATCH)
- Manual check: `grep -r "user.email!" app/` returns nothing (non-null assertion removed)
</verification>

<success_criteria>
- All 6 POST/PATCH routes call `validateRequestBody` with appropriate Zod schema
- Oversized name (>100 chars) returns 400 on POST and PATCH habits/tasks
- Oversized description (>500 chars) returns 400
- PATCH with subset of fields succeeds (`.partial()` schema)
- POST /api/habits with 20+ active habits returns 400 with count message
- ensureProfile called in habits POST and tasks POST
- `user.email!` non-null assertion no longer exists in codebase
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-security-and-validation/02-02-SUMMARY.md`
</output>
