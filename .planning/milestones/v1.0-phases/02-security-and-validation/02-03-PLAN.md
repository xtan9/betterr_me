---
phase: 02-security-and-validation
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - app/auth/callback/route.ts
  - app/auth/confirm/route.ts
  - supabase/migrations/20260216000001_fix_handle_new_user.sql
autonomous: true

must_haves:
  truths:
    - "Auth callback with an external or unexpected redirect path falls back to a safe default route"
    - "Auth confirm route also validates redirect path against the allowlist"
    - "The handle_new_user trigger does not crash for OAuth users without email"
    - "The handle_new_user trigger does not block signup on any error"
  artifacts:
    - path: "app/auth/callback/route.ts"
      provides: "Auth callback with redirect allowlist"
      contains: "getSafeRedirectPath"
    - path: "app/auth/confirm/route.ts"
      provides: "Auth confirm with redirect allowlist"
      contains: "getSafeRedirectPath"
    - path: "supabase/migrations/20260216000001_fix_handle_new_user.sql"
      provides: "Fixed handle_new_user trigger with COALESCE and EXCEPTION handling"
      contains: "COALESCE"
  key_links:
    - from: "app/auth/callback/route.ts"
      to: "lib/auth/redirect.ts"
      via: "import getSafeRedirectPath"
      pattern: "import.*getSafeRedirectPath.*from.*lib/auth/redirect"
    - from: "app/auth/confirm/route.ts"
      to: "lib/auth/redirect.ts"
      via: "import getSafeRedirectPath"
      pattern: "import.*getSafeRedirectPath.*from.*lib/auth/redirect"
---

<objective>
Harden auth redirect paths in callback and confirm routes using the allowlist helper, fix the handle_new_user database trigger to handle missing email and not block signups on error.

Purpose: Prevent open redirect vulnerabilities in auth flows and ensure OAuth signup reliability regardless of email availability.

Output: 2 updated auth route files, 1 new SQL migration file.
</objective>

<execution_context>
@/home/xingdi/.claude/get-shit-done/workflows/execute-plan.md
@/home/xingdi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-security-and-validation/02-RESEARCH.md
@.planning/phases/02-security-and-validation/02-01-SUMMARY.md
@app/auth/callback/route.ts
@app/auth/confirm/route.ts
@lib/auth/redirect.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Apply redirect allowlist to auth callback and confirm routes</name>
  <files>
    app/auth/callback/route.ts
    app/auth/confirm/route.ts
  </files>
  <action>
**app/auth/callback/route.ts:**
- Import `getSafeRedirectPath` from `@/lib/auth/redirect`
- Remove the `console.log('callback')` debug statement (it's a stale debug log)
- Replace the current redirect guard logic:
  ```
  let next = searchParams.get('next') ?? '/'
  if (!next.startsWith('/')) {
    next = '/'
  }
  ```
  With:
  ```
  const next = getSafeRedirectPath(searchParams.get('next'))
  ```
- Keep all other logic unchanged: code exchange, forwardedHost check, error redirect to `/auth/auth-code-error`
- The `next` variable is now `const` since `getSafeRedirectPath` handles all validation

**app/auth/confirm/route.ts:**
- Import `getSafeRedirectPath` from `@/lib/auth/redirect`
- Replace `const next = searchParams.get("next") ?? "/"` with `const next = getSafeRedirectPath(searchParams.get("next"))`
- Keep all other logic unchanged: token_hash verification, error redirects
- This route currently has ZERO redirect validation (Research identified this as more vulnerable than callback)
  </action>
  <verify>
Run `pnpm build` to confirm no TypeScript errors. Run `pnpm lint` to confirm no lint issues. Run `pnpm test:run` to confirm no test regressions.
  </verify>
  <done>
Both auth routes import and use `getSafeRedirectPath`. The `console.log('callback')` debug statement is removed from callback route. No raw `next` parameter is used for redirects without allowlist validation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create SQL migration to fix handle_new_user trigger</name>
  <files>
    supabase/migrations/20260216000001_fix_handle_new_user.sql
  </files>
  <action>
Create migration file `supabase/migrations/20260216000001_fix_handle_new_user.sql` with:

```sql
-- Fix handle_new_user trigger to handle OAuth users without email
-- and not block signup on any error.
--
-- Issues fixed:
-- 1. NEW.email is NULL for some OAuth providers (GitHub without public email,
--    Apple Sign-In with hidden email). The NOT NULL constraint on profiles.email
--    caused the insert to fail, blocking signup entirely.
-- 2. No exception handling meant ANY error (constraint violation, RLS, etc.)
--    would prevent the user from being created in auth.users.
--
-- Solution:
-- - COALESCE(NEW.email, 'no-email-' || NEW.id::text) ensures a unique,
--   non-null fallback for emailless users
-- - EXCEPTION WHEN OTHERS catches all errors, logs a warning, and allows
--   signup to proceed. The ensureProfile() application helper provides
--   defense-in-depth for profile creation.

CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.profiles (id, email, full_name, avatar_url)
  VALUES (
    NEW.id,
    COALESCE(NEW.email, 'no-email-' || NEW.id::text),
    NEW.raw_user_meta_data->>'full_name',
    NEW.raw_user_meta_data->>'avatar_url'
  );
  RETURN NEW;
EXCEPTION WHEN OTHERS THEN
  -- Log the error but do not block signup.
  -- The ensureProfile() helper in the application layer will create
  -- the profile on the user's first API write if the trigger failed.
  RAISE WARNING 'handle_new_user failed for user %: %', NEW.id, SQLERRM;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

This is a `CREATE OR REPLACE` so it will update the existing function without needing to drop/recreate the trigger. The trigger itself (`ON INSERT ON auth.users`) remains unchanged.
  </action>
  <verify>
Verify the SQL file exists and has correct syntax by reading it back. The migration will be applied when the user runs `supabase db push` or `supabase migration up` -- this cannot be verified automatically in the test environment.
  </verify>
  <done>
Migration file exists at `supabase/migrations/20260216000001_fix_handle_new_user.sql`. It uses `COALESCE` for email fallback and `EXCEPTION WHEN OTHERS` to prevent signup blocking. The comment block explains both issues and the solution.
  </done>
</task>

</tasks>

<verification>
- `pnpm build` passes
- `pnpm test:run` passes
- `pnpm lint` passes
- `grep -r "console.log" app/auth/callback/route.ts` returns nothing (debug log removed)
- `grep -r "getSafeRedirectPath" app/auth/` returns 2 matches (callback + confirm)
- Migration file exists and contains `COALESCE` and `EXCEPTION WHEN OTHERS`
</verification>

<success_criteria>
- Auth callback uses `getSafeRedirectPath` instead of manual `startsWith('/')` check
- Auth confirm uses `getSafeRedirectPath` (previously had ZERO redirect validation)
- `console.log('callback')` debug statement removed
- SQL migration ready for deployment
- All tests pass, build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/02-security-and-validation/02-03-SUMMARY.md`
</output>
