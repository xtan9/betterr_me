---
phase: 02-security-and-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/validations/api.ts
  - lib/validations/habit.ts
  - lib/validations/task.ts
  - lib/validations/profile.ts
  - lib/validations/preferences.ts
  - lib/db/ensure-profile.ts
  - lib/db/habits.ts
  - lib/auth/redirect.ts
  - lib/constants.ts
autonomous: true

must_haves:
  truths:
    - "A shared validateRequestBody helper exists that all POST/PATCH routes can call"
    - "Partial update schemas exist for habits, tasks, and profile PATCH routes"
    - "A preferences Zod schema exists for the preferences PATCH route"
    - "An ensureProfile helper exists that safely creates profiles for users without one"
    - "A getSafeRedirectPath function exists that validates redirect paths against an allowlist"
    - "A MAX_HABITS_PER_USER constant and getActiveHabitCount DB method exist"
  artifacts:
    - path: "lib/validations/api.ts"
      provides: "validateRequestBody shared helper"
      exports: ["validateRequestBody"]
    - path: "lib/validations/habit.ts"
      provides: "habitUpdateSchema for PATCH routes"
      exports: ["habitFormSchema", "habitUpdateSchema", "HabitFormValues", "HabitUpdateValues"]
    - path: "lib/validations/task.ts"
      provides: "taskUpdateSchema for PATCH routes"
      exports: ["taskFormSchema", "taskUpdateSchema", "TaskFormValues", "TaskUpdateValues"]
    - path: "lib/validations/profile.ts"
      provides: "profileUpdateSchema for PATCH routes"
      exports: ["profileFormSchema", "profileUpdateSchema", "ProfileFormValues", "ProfileUpdateValues"]
    - path: "lib/validations/preferences.ts"
      provides: "preferencesSchema for preferences PATCH route"
      exports: ["preferencesSchema", "PreferencesValues"]
    - path: "lib/db/ensure-profile.ts"
      provides: "ensureProfile helper for safe profile auto-creation"
      exports: ["ensureProfile"]
    - path: "lib/db/habits.ts"
      provides: "getActiveHabitCount method on HabitsDB"
      contains: "getActiveHabitCount"
    - path: "lib/auth/redirect.ts"
      provides: "getSafeRedirectPath function with redirect allowlist"
      exports: ["getSafeRedirectPath"]
    - path: "lib/constants.ts"
      provides: "MAX_HABITS_PER_USER constant"
      exports: ["MAX_HABITS_PER_USER"]
  key_links:
    - from: "lib/validations/api.ts"
      to: "zod"
      via: "ZodSchema generic parameter"
      pattern: "safeParse"
    - from: "lib/db/ensure-profile.ts"
      to: "supabase"
      via: "SupabaseClient parameter"
      pattern: "from.*profiles.*insert"
    - from: "lib/db/habits.ts"
      to: "supabase"
      via: "SupabaseClient query"
      pattern: "count.*exact.*head.*true"
---

<objective>
Create all shared infrastructure (helpers, schemas, constants) needed by Phase 2 API route hardening.

Purpose: Establish the reusable building blocks that API routes will import in Plan 02 and auth routes will import in Plan 03. This avoids duplication and ensures consistent validation/error format across all routes.

Output: 9 files -- 5 validation schemas/helpers, 1 DB helper, 1 DB method addition, 1 auth helper, 1 constants file.
</objective>

<execution_context>
@/home/xingdi/.claude/get-shit-done/workflows/execute-plan.md
@/home/xingdi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-security-and-validation/02-RESEARCH.md
@lib/validations/habit.ts
@lib/validations/task.ts
@lib/validations/profile.ts
@lib/db/habits.ts
@lib/db/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create validation helper, update schemas, and preferences schema</name>
  <files>
    lib/validations/api.ts
    lib/validations/habit.ts
    lib/validations/task.ts
    lib/validations/profile.ts
    lib/validations/preferences.ts
  </files>
  <action>
Create `lib/validations/api.ts` with a `validateRequestBody` function:
- Accept `body: unknown` and `schema: ZodSchema<T>` (generic)
- Call `schema.safeParse(body)`
- On success: return `{ success: true, data: T }`
- On failure: `console.warn('Validation failed:', JSON.stringify(fieldErrors))`, return `{ success: false, response: NextResponse.json({ error: 'Validation failed', details: fieldErrors }, { status: 400 }) }`
- Export types `ValidationSuccess<T>`, `ValidationFailure`, `ValidationResult<T>`
- Use `result.error.flatten().fieldErrors` for structured errors

Update `lib/validations/habit.ts` -- add `habitUpdateSchema`:
- `habitFormSchema.partial()` extended with `.extend({ status: z.enum(['active', 'paused', 'archived']).optional() })`
- Add `.refine(data => Object.keys(data).length > 0, { message: 'At least one field must be provided' })`
- Export `habitUpdateSchema` and `HabitUpdateValues` type

Update `lib/validations/task.ts` -- add `taskUpdateSchema`:
- `taskFormSchema.partial()` extended with `.extend({ is_completed: z.boolean().optional(), completed_at: z.string().nullable().optional() })`
- Add `.refine(data => Object.keys(data).length > 0, { message: 'At least one field must be provided' })`
- Export `taskUpdateSchema` and `TaskUpdateValues` type

Update `lib/validations/profile.ts` -- add `profileUpdateSchema`:
- `profileFormSchema.partial()` extended with `.extend({ preferences: z.record(z.unknown()).optional() })`
- Add `.refine(data => Object.keys(data).length > 0, { message: 'At least one field must be provided' })`
- Export `profileUpdateSchema` and `ProfileUpdateValues` type

Create `lib/validations/preferences.ts`:
- `preferencesSchema = z.object({ date_format: z.string().optional(), week_start_day: z.number().int().min(0).max(6).optional(), theme: z.enum(['system', 'light', 'dark']).optional() }).refine(data => Object.keys(data).length > 0, { message: 'At least one preference must be provided' })`
- Export `preferencesSchema` and `PreferencesValues` type

IMPORTANT: Do NOT remove any existing exports from validation files. Only ADD new exports.
  </action>
  <verify>
Run `pnpm build` to confirm no TypeScript errors. Run `pnpm test:run` to confirm existing tests still pass (validation files are imported by form components and existing tests).
  </verify>
  <done>
All 5 validation files exist with correct exports. `validateRequestBody` returns discriminated union. Update schemas use `.partial()`. Preferences schema validates the three known preference fields. Existing tests pass unchanged.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ensureProfile helper, getActiveHabitCount method, redirect allowlist, and constants</name>
  <files>
    lib/db/ensure-profile.ts
    lib/db/habits.ts
    lib/auth/redirect.ts
    lib/constants.ts
  </files>
  <action>
Create `lib/constants.ts`:
- Export `const MAX_HABITS_PER_USER = 20` (per user's locked decision: named constant, not hardcoded inline)

Create `lib/db/ensure-profile.ts`:
- Export `async function ensureProfile(supabase: SupabaseClient, user: User): Promise<void>`
- Import `SupabaseClient` and `User` types from `@supabase/supabase-js`
- Check if profile exists: `supabase.from('profiles').select('id').eq('id', user.id).single()`
- If profile exists, return early
- If missing, insert with `user.email ?? 'no-email-' + user.id` as email fallback (NOT empty string -- would violate UNIQUE constraint for multiple emailless users)
- Include `full_name: user.user_metadata?.full_name || null` and `avatar_url: user.user_metadata?.avatar_url || null`
- Catch error code `23505` (unique_violation) and return silently (race condition: another request or trigger already created it)
- Throw on any other insert error

Add `getActiveHabitCount` method to `HabitsDB` class in `lib/db/habits.ts`:
- `async getActiveHabitCount(userId: string): Promise<number>`
- Query: `this.supabase.from('habits').select('*', { count: 'exact', head: true }).eq('user_id', userId).in('status', ['active', 'paused'])`
- Per user's locked decision: only active (non-deleted) habits count. Both `active` and `paused` count toward limit (archived = soft-deleted, doesn't count)
- If error, throw it
- Return `count ?? 0`

Create `lib/auth/redirect.ts`:
- Create the `lib/auth/` directory (doesn't exist yet)
- Define `ALLOWED_REDIRECT_PATHS` array: `['/', '/dashboard', '/habits', '/tasks', '/dashboard/settings']`
- Define `ALLOWED_REDIRECT_PREFIXES` array: `['/habits/', '/tasks/']`
- Export `function getSafeRedirectPath(next: string | null): string`
- If `!next` return `/` (per locked decision: fallback to root)
- If `!next.startsWith('/') || next.startsWith('//')` return `/` (block external URLs and protocol-relative URLs)
- Strip query params and hash for matching: `const pathname = next.split('?')[0].split('#')[0]`
- Check exact matches first, then prefix matches
- If no match: `console.warn('Blocked redirect to disallowed path:', next)` and return `/`
- If match: return the original `next` (preserving query params/hash)
  </action>
  <verify>
Run `pnpm build` to confirm no TypeScript errors. Run `pnpm test:run` to confirm existing tests pass (HabitsDB is used in many tests, adding a method should not break anything).
  </verify>
  <done>
`lib/constants.ts` exports `MAX_HABITS_PER_USER = 20`. `lib/db/ensure-profile.ts` exports `ensureProfile` that handles missing email and race conditions. `HabitsDB.getActiveHabitCount` counts active+paused habits. `lib/auth/redirect.ts` exports `getSafeRedirectPath` with allowlist and `/` fallback. All existing tests pass.
  </done>
</task>

</tasks>

<verification>
- `pnpm build` passes with zero TypeScript errors
- `pnpm test:run` passes (all existing tests unaffected)
- `pnpm lint` passes
- Each new file has correct exports verified by import in a quick TS check
</verification>

<success_criteria>
- 5 new files created: `lib/validations/api.ts`, `lib/validations/preferences.ts`, `lib/db/ensure-profile.ts`, `lib/auth/redirect.ts`, `lib/constants.ts`
- 3 existing files updated: `lib/validations/habit.ts`, `lib/validations/task.ts`, `lib/validations/profile.ts`
- 1 existing file has new method: `lib/db/habits.ts` (getActiveHabitCount)
- All exports available for Plan 02 and Plan 03 to import
- Zero test regressions
</success_criteria>

<output>
After completion, create `.planning/phases/02-security-and-validation/02-01-SUMMARY.md`
</output>
