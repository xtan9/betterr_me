---
phase: 05-test-coverage
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/lib/validations/habit.test.ts
  - tests/lib/db/habit-logs.test.ts
autonomous: true

must_haves:
  truths:
    - "habitFormSchema rejects name over 100 chars, whitespace-only name, and empty name"
    - "habitFormSchema rejects description over 500 chars and accepts null/omitted description"
    - "habitFormSchema rejects invalid category values and accepts all 5 valid values plus null"
    - "habitFormSchema validates each frequency discriminated union variant with type-specific constraints"
    - "habitUpdateSchema rejects empty body (refine) and validates per-field when fields are present"
    - "Edge cases tested: Unicode strings, null bytes, extremely long payloads, special characters, SQL injection attempts"
    - "times_per_week regression: 3 completions in a week for a 3x/week habit = 100% completion rate"
    - "weekly regression: any single completion in a week = satisfied (100%)"
  artifacts:
    - path: "tests/lib/validations/habit.test.ts"
      provides: "Comprehensive habitFormSchema and habitUpdateSchema validation tests"
      min_lines: 200
    - path: "tests/lib/db/habit-logs.test.ts"
      provides: "Two added frequency regression tests"
  key_links:
    - from: "tests/lib/validations/habit.test.ts"
      to: "lib/validations/habit.ts"
      via: "imports habitFormSchema and habitUpdateSchema"
      pattern: "import.*habitFormSchema.*habitUpdateSchema.*from.*validations/habit"
---

<objective>
Create exhaustive validation tests for the habit Zod schemas and add two focused frequency regression tests.

Purpose: TEST-02 (Zod validation path coverage) and TEST-04 (frequency regression tests) are the schema/DB-level test requirements for Phase 5.
Output: New habit validation test file, two additional frequency regression tests in existing file.
</objective>

<execution_context>
@/home/xingdi/.claude/get-shit-done/workflows/execute-plan.md
@/home/xingdi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@lib/validations/habit.ts
@tests/lib/validations/task.test.ts
@tests/lib/db/habit-logs.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create habitFormSchema and habitUpdateSchema validation tests</name>
  <files>tests/lib/validations/habit.test.ts</files>
  <action>
Create a new test file following the pattern in `tests/lib/validations/task.test.ts` (pure schema .safeParse() tests, no API mocking needed).

Import: `import { habitFormSchema, habitUpdateSchema } from '@/lib/validations/habit';`

Top-level structure:

**describe('habitFormSchema')**:

**describe('name field')**:
- `it('accepts valid name')` -- safeParse with name 'Morning Run', frequency { type: 'daily' }. Assert success true.
- `it('rejects empty name')` -- name: ''. Assert success false, error message contains 'required'.
- `it('rejects whitespace-only name')` -- name: '   '. Assert success false (trim + min 1).
- `it('trims whitespace from name')` -- name: '  Morning Run  '. Assert success true, result.data.name === 'Morning Run'.
- `it('accepts name at exactly 100 characters')` -- name: 'a'.repeat(100). Assert success true.
- `it('rejects name over 100 characters')` -- name: 'a'.repeat(101). Assert success false, error message contains '100'.
- `it('accepts Unicode characters in name')` -- name: 'Habitude quotidienne'. Assert success true.
- `it('accepts emoji in name')` -- name: 'Morning Run üèÉ'. Assert success true.
- `it('rejects name with only null bytes')` -- name: '\0\0\0'. Assert behavior (will be trimmed to '\0\0\0' -- document actual result).
- `it('handles extremely long name (10000 chars)')` -- name: 'a'.repeat(10000). Assert success false.
- `it('accepts name with special characters')` -- name: "Habit <script>alert('xss')</script>". Assert success true (Zod validates length, not content).
- `it('accepts name with SQL injection attempt')` -- name: "'; DROP TABLE habits; --". Assert success true (Zod validates format, DB uses parameterized queries).

**describe('description field')**:
- `it('accepts valid description')` -- description: 'A morning run'. Assert success true.
- `it('accepts null description')` -- description: null. Assert success true.
- `it('accepts omitted description')` -- no description field. Assert success true.
- `it('accepts description at exactly 500 characters')` -- description: 'a'.repeat(500). Assert success true.
- `it('rejects description over 500 characters')` -- description: 'a'.repeat(501). Assert success false.
- `it('accepts empty string description')` -- description: ''. Assert success true (optional, no min).
- `it('handles Unicode in description')` -- description: 'Run every morning at 6am'. Assert success true.

**describe('category field')**:
- `it('accepts all valid category values')` -- loop through ['health', 'wellness', 'learning', 'productivity', 'other'], safeParse each with valid name+frequency. Assert all success true.
- `it('rejects invalid category value')` -- category: 'invalid'. Assert success false.
- `it('accepts null category')` -- category: null. Assert success true.
- `it('accepts omitted category')` -- no category field. Assert success true.

**describe('frequency field')**:
- `it('accepts daily frequency')` -- frequency: { type: 'daily' }. Assert success true.
- `it('accepts weekdays frequency')` -- frequency: { type: 'weekdays' }. Assert success true.
- `it('accepts weekly frequency')` -- frequency: { type: 'weekly' }. Assert success true.
- `it('accepts times_per_week with count 2')` -- frequency: { type: 'times_per_week', count: 2 }. Assert success true.
- `it('accepts times_per_week with count 3')` -- frequency: { type: 'times_per_week', count: 3 }. Assert success true.
- `it('rejects times_per_week with count 1')` -- frequency: { type: 'times_per_week', count: 1 }. Assert success false.
- `it('rejects times_per_week with count 5')` -- frequency: { type: 'times_per_week', count: 5 }. Assert success false.
- `it('rejects times_per_week without count')` -- frequency: { type: 'times_per_week' }. Assert success false.
- `it('accepts custom frequency with valid days')` -- frequency: { type: 'custom', days: [1, 3, 5] }. Assert success true.
- `it('accepts custom frequency with single day')` -- frequency: { type: 'custom', days: [0] }. Assert success true.
- `it('accepts custom frequency with all days')` -- frequency: { type: 'custom', days: [0,1,2,3,4,5,6] }. Assert success true.
- `it('rejects custom frequency with empty days')` -- frequency: { type: 'custom', days: [] }. Assert success false, error message contains 'at least one day'.
- `it('rejects custom frequency without days')` -- frequency: { type: 'custom' }. Assert success false.
- `it('rejects custom frequency with day > 6')` -- frequency: { type: 'custom', days: [7] }. Assert success false.
- `it('rejects custom frequency with day < 0')` -- frequency: { type: 'custom', days: [-1] }. Assert success false.
- `it('rejects invalid frequency type')` -- frequency: { type: 'monthly' }. Assert success false.
- `it('rejects missing frequency')` -- no frequency field. Assert success false.

**describe('habitUpdateSchema')**:

- `it('rejects empty body')` -- safeParse({}). Assert success false (refine: "At least one field must be provided").
- `it('accepts single field update (name)')` -- { name: 'New Name' }. Assert success true.
- `it('accepts single field update (category)')` -- { category: 'health' }. Assert success true.
- `it('accepts single field update (status)')` -- { status: 'paused' }. Assert success true.
- `it('accepts single field update (frequency)')` -- { frequency: { type: 'daily' } }. Assert success true.
- `it('accepts single field update (description)')` -- { description: 'Updated desc' }. Assert success true.
- `it('accepts multi-field update')` -- { name: 'New', category: 'health', status: 'active' }. Assert success true.
- `it('rejects invalid name in update')` -- { name: '' }. Assert success false.
- `it('rejects name over 100 chars in update')` -- { name: 'a'.repeat(101) }. Assert success false.
- `it('rejects invalid category in update')` -- { category: 'bad' }. Assert success false.
- `it('rejects invalid status in update')` -- { status: 'deleted' }. Assert success false.
- `it('accepts all valid status values')` -- loop ['active', 'paused', 'archived'], assert all succeed.
- `it('rejects invalid frequency in update')` -- { frequency: { type: 'monthly' } }. Assert success false.

For all safeParse calls on habitFormSchema, provide valid defaults for other fields: `{ name: 'Test', frequency: { type: 'daily' }, ...fieldOverride }`. Use a helper function for this:
```typescript
const validHabit = (overrides: Record<string, unknown> = {}) => ({
  name: 'Test Habit',
  frequency: { type: 'daily' },
  ...overrides,
});
```
  </action>
  <verify>Run `pnpm vitest run tests/lib/validations/habit.test.ts` -- all tests pass</verify>
  <done>New test file with 40+ tests covering every field of habitFormSchema individually (name, description, category, frequency variants) and habitUpdateSchema (empty body, per-field solo sends, multi-field combo, invalid values). Edge cases include Unicode, null bytes, extremely long strings, special characters, and SQL injection attempts. All tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Add frequency regression tests</name>
  <files>tests/lib/db/habit-logs.test.ts</files>
  <action>
Add two focused regression tests to the existing `tests/lib/db/habit-logs.test.ts` file. Place them in the existing describe blocks.

**Test 1: times_per_week 3/3 = 100%**
Inside the existing `describe("times_per_week frequency handling")` > `describe("getDetailedHabitStats")` block (after the existing "should return weekly progress for thisWeek" test around line 320):

```typescript
it("should return 100% when target exactly met (3/3 completions)", async () => {
  // Regression: times_per_week with count=3, exactly 3 completions = 100%
  mockSupabaseClient.setMockResponse([
    { ...mockLog, logged_date: weekDate(0), completed: true },
    { ...mockLog, logged_date: weekDate(1), completed: true },
    { ...mockLog, logged_date: weekDate(2), completed: true },
  ]);

  const stats = await habitLogsDB.getDetailedHabitStats(
    mockHabitId,
    mockUserId,
    timesPerWeekFrequency,
    createdAt,
    0,
  );

  expect(stats.thisWeek.completed).toBe(3);
  expect(stats.thisWeek.total).toBe(3);
  expect(stats.thisWeek.percent).toBe(100); // 3/3 = 100%
});
```

Use the existing `weekDate`, `timesPerWeekFrequency`, `createdAt`, `mockLog`, `mockHabitId`, `mockUserId`, and `mockSupabaseClient` variables that are already defined in that describe scope.

**Test 2: weekly any completion = satisfied**
Inside the existing `describe("weekly frequency handling")` > `describe("getDetailedHabitStats")` block (after the existing "should use week-level evaluation" test around line 472):

```typescript
it("should treat any single completion as 100% (regression)", async () => {
  // Regression: weekly habit, 1 completion on any day of the week = 100% satisfied
  mockSupabaseClient.setMockResponse([
    { ...mockLog, logged_date: wkDate(5), completed: true },
  ]);

  const stats = await habitLogsDB.getDetailedHabitStats(
    mockHabitId,
    mockUserId,
    weeklyFrequency,
    createdAt,
    0,
  );

  expect(stats.thisWeek.completed).toBe(1);
  expect(stats.thisWeek.total).toBe(1);
  expect(stats.thisWeek.percent).toBe(100);
});
```

Use the existing `wkDate`, `weeklyFrequency`, `createdAt`, `mockLog`, `mockHabitId`, `mockUserId`, and `mockSupabaseClient` variables.

IMPORTANT: Do NOT modify any existing tests. Only ADD these two new tests within the existing describe blocks. Place each immediately after the most related existing test in the same describe block.
  </action>
  <verify>Run `pnpm vitest run tests/lib/db/habit-logs.test.ts` -- all tests pass including the 2 new regression tests</verify>
  <done>Two regression tests added: (1) times_per_week 3/3 = 100% completion rate, (2) weekly any-completion = 100% satisfied. Both pass alongside all existing tests.</done>
</task>

</tasks>

<verification>
```bash
# Run both test files
pnpm vitest run tests/lib/validations/habit.test.ts tests/lib/db/habit-logs.test.ts

# Verify full test suite still passes
pnpm test:run

# Verify lint passes
pnpm lint
```
</verification>

<success_criteria>
- habitFormSchema has exhaustive per-field validation tests including edge cases (Unicode, null bytes, oversized payloads, SQL injection)
- habitUpdateSchema tests cover empty body rejection, per-field solo sends, multi-field combo, and invalid values
- times_per_week regression test: 3 completions / 3 target = 100%
- weekly regression test: any completion = 100% satisfied
- All tests in the project pass
- Lint passes
</success_criteria>

<output>
After completion, create `.planning/phases/05-test-coverage/05-02-SUMMARY.md`
</output>
