---
phase: 03-sidebar-collapse-persistence
plan: 03
type: execute
wave: 3
depends_on: ["03-01", "03-02"]
files_modified:
  - components/layouts/sidebar-layout.tsx
  - components/layouts/app-sidebar.tsx
  - app/globals.css
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "When unpinned, sidebar shows icon-only rail (~48px wide) with nav icons visible, matching Chameleon's collapsed state"
    - "Hovering the icon rail expands the sidebar as an overlay with full labels, without pushing content"
    - "Pin toggle button and brand text are visible when sidebar is expanded (pinned or hover-overlay)"
    - "All existing pin/unpin, cookie persistence, and animation behavior continues working"
  artifacts:
    - path: "components/layouts/app-sidebar.tsx"
      provides: "Sidebar with collapsible=icon instead of offcanvas"
      contains: "collapsible=\"icon\""
    - path: "components/layouts/sidebar-layout.tsx"
      provides: "No invisible hover trigger zone; icon rail wrapper handles hover events"
    - path: "app/globals.css"
      provides: "CSS overlay rules for icon-mode hover (gap stays at icon width, sidebar expands as overlay)"
      contains: "data-sidebar-hover"
---

<objective>
Switch sidebar collapse mode from "offcanvas" (fully hidden) to "icon" (icon-only rail) to match Chameleon's pattern. When unpinned, users see a persistent icon rail. Hovering the rail expands the sidebar as an overlay without pushing content.

Purpose: Match Chameleon's collapsed sidebar behavior as shown in user screenshots. The icon rail provides visual affordance for hover interaction.

Output: Icon-only rail when unpinned, hover overlay expansion, no invisible trigger zone.
</objective>

<execution_context>
@/home/xingdi/.claude/get-shit-done/workflows/execute-plan.md
@/home/xingdi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/phases/03-sidebar-collapse-persistence/03-01-SUMMARY.md
@.planning/phases/03-sidebar-collapse-persistence/03-02-SUMMARY.md

# Key source files:
@components/layouts/sidebar-layout.tsx
@components/layouts/app-sidebar.tsx
@app/globals.css
@components/ui/sidebar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Switch to icon collapse mode and update hover overlay CSS</name>
  <files>
    components/layouts/app-sidebar.tsx
    components/layouts/sidebar-layout.tsx
    app/globals.css
  </files>
  <action>
**1. `components/layouts/app-sidebar.tsx`:**
Change `collapsible="offcanvas"` to `collapsible="icon"`:
```tsx
<Sidebar collapsible="icon">
```

**2. `components/layouts/sidebar-layout.tsx`:**

Remove the invisible hover trigger zone div entirely (lines 62-68 — the `{!pinned && !hoverOpen && (` block with `w-[22px]`). The icon rail itself is now the hover target.

The state model stays the same:
- `open = pinned || hoverOpen`
- When pinned: `open=true`, sidebar expanded, pushes content normally
- When unpinned resting: `open=false`, `state="collapsed"`, `collapsible="icon"` → shows icon rail
- When unpinned hovering: `open=true`, `state="expanded"`, BUT CSS overlay keeps gap at icon width

The `data-sidebar-hover` wrapper div around `<AppSidebar>` stays — it still drives the CSS overlay. Mouse enter/leave on the wrapper div still toggles `hoverOpen`.

**3. `app/globals.css`:**

Replace the existing offcanvas hover-overlay CSS rules (lines 142-152) with icon-mode overlay rules:

```css
/* Sidebar hover-overlay mode: when unpinned, hovering icon rail expands sidebar as overlay */
/* Keep the gap div at icon width so content doesn't shift */
[data-sidebar-hover="true"] .peer[data-state="expanded"] > div:first-child {
  width: var(--sidebar-width-icon) !important;
  transition: none !important;
}

/* Add overlay shadow/z-index to the expanded sidebar in hover mode */
[data-sidebar-hover="true"] .peer[data-state="expanded"] > div:last-child {
  z-index: 30;
  box-shadow: 4px 0 16px rgba(0, 0, 0, 0.08);
}

.dark [data-sidebar-hover="true"] .peer[data-state="expanded"] > div:last-child {
  box-shadow: 4px 0 16px rgba(0, 0, 0, 0.3);
}
```

Key logic:
- `div:first-child` is the gap div (spacer that pushes content). Override its width to icon size so content stays put.
- `div:last-child` is the fixed sidebar div. It naturally expands to `--sidebar-width` when `state="expanded"`. Add z-index + shadow for overlay appearance.
  </action>
  <verify>
Run `pnpm build` and `pnpm lint` to verify compilation. Run `pnpm test:run` to confirm all tests pass. Check that:
1. `app-sidebar.tsx` has `collapsible="icon"`
2. `sidebar-layout.tsx` has NO invisible hover trigger zone div
3. `globals.css` targets `[data-state="expanded"]` not `[data-state="collapsed"][data-collapsible="offcanvas"]`
  </verify>
  <done>
Sidebar collapse mode switched from offcanvas to icon. Icon rail visible when unpinned. Hover overlay expands sidebar without pushing content. Build, lint, and tests pass.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` passes
2. `pnpm lint` clean
3. `pnpm test:run` all tests pass
4. Sidebar shows icon rail when unpinned (not fully hidden)
5. Hovering icon rail expands sidebar as overlay
</verification>

<success_criteria>
- Icon-only rail visible when unpinned (collapsible="icon")
- Hover overlay expands sidebar without content shift
- No invisible trigger zone
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-sidebar-collapse-persistence/03-03-SUMMARY.md`
</output>
</task>
