---
phase: 03-sidebar-collapse-persistence
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - tests/components/layouts/app-sidebar.test.tsx
autonomous: true

must_haves:
  truths:
    - "Pin toggle button rendering is tested (visible, correct icon, tooltip text)"
    - "Pin toggle aria-pressed attribute reflects pinned/unpinned state correctly"
    - "All existing AppSidebar tests still pass (nav items, active state, i18n, accessibility)"
    - "Build, lint, and full test suite pass"
  artifacts:
    - path: "tests/components/layouts/app-sidebar.test.tsx"
      provides: "Updated test suite covering pin toggle button, aria-pressed, tooltip text, and existing nav behavior"
      contains: "aria-pressed"
  key_links:
    - from: "tests/components/layouts/app-sidebar.test.tsx"
      to: "components/layouts/app-sidebar.tsx"
      via: "render with pinned/onTogglePin props"
      pattern: "pinned.*onTogglePin"
---

<objective>
Update the AppSidebar test suite to cover the new pin toggle button (rendering, aria-pressed state, tooltip, click handler). Verify the full build, lint, and test suite pass cleanly.

Purpose: Ensure the pin/unpin feature is tested and doesn't break any existing functionality. This validates Phase 3's implementation before moving forward.

Output: Updated test file, all tests green, build and lint clean.
</objective>

<execution_context>
@/home/xingdi/.claude/get-shit-done/workflows/execute-plan.md
@/home/xingdi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-sidebar-collapse-persistence/03-01-SUMMARY.md

# Key source files:
@tests/components/layouts/app-sidebar.test.tsx
@components/layouts/app-sidebar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update AppSidebar tests for pin toggle button and verify suite</name>
  <files>
    tests/components/layouts/app-sidebar.test.tsx
  </files>
  <action>
**Update the existing test file** to cover the new pin toggle functionality. The existing 10 tests for nav items, active state, i18n, and accessibility must continue to pass.

**Mock updates needed:**

The `AppSidebar` component now accepts props: `pinned: boolean` and `onTogglePin: () => void`. Update all existing `render(<AppSidebar />)` calls to pass these props:
```tsx
const defaultProps = {
  pinned: true,
  onTogglePin: vi.fn(),
};
render(<AppSidebar {...defaultProps} />);
```

Add `Tooltip` and `TooltipProvider` to the sidebar mock since AppSidebar now imports them:
```tsx
// Add to the vi.mock("@/components/ui/tooltip") or vi.mock("@/components/ui/sidebar") block:
vi.mock("@/components/ui/tooltip", () => ({
  Tooltip: ({ children }: any) => <>{children}</>,
  TooltipTrigger: ({ children, asChild }: any) => {
    if (asChild) return <>{children}</>;
    return <>{children}</>;
  },
  TooltipContent: ({ children }: any) => <span data-testid="tooltip-content">{children}</span>,
  TooltipProvider: ({ children }: any) => <>{children}</>,
}));
```

**New tests to add** (in a new `describe("pin toggle button")` block):

1. **"renders pin toggle button in sidebar header"** -- Verify a button with role="button" and aria-pressed exists inside the sidebar header area.

2. **"shows aria-pressed=true when pinned"** -- Render with `pinned={true}`, verify the pin button has `aria-pressed="true"`.

3. **"shows aria-pressed=false when unpinned"** -- Render with `pinned={false}`, verify the pin button has `aria-pressed="false"`.

4. **"calls onTogglePin when pin button is clicked"** -- Render with `onTogglePin` mock, click the pin button, verify mock was called once.

5. **"shows unpin label when pinned"** -- When `pinned={true}`, verify the button's `aria-label` contains the unpinLabel translation key (since useTranslations is mocked to return the key, check for "unpinLabel"). Also check tooltip content shows "unpin".

6. **"shows pin label when unpinned"** -- When `pinned={false}`, verify `aria-label` contains "pinLabel" and tooltip shows "pin".

Use `screen.getByRole("button", { pressed: true })` or filter by `aria-pressed` attribute to find the pin button (since nav items are links, the pin toggle is the only button).

For click test: use `@testing-library/user-event` or `fireEvent.click`.

**Verify all existing tests still pass** by ensuring the `defaultProps` are passed in all existing test cases. The existing tests check nav links, active state, i18n, brand text, and accessibility -- none should be affected by the new pin props as long as they're provided.

Run `pnpm test:run` to verify all tests pass (including the 2 known pre-existing failures in habit-logs.test.ts per CLAUDE.md). Run `pnpm lint` to fix any lint issues. Run `pnpm build` for final verification.
  </action>
  <verify>
Run the following commands and verify they pass:
1. `pnpm test:run -- tests/components/layouts/app-sidebar.test.tsx` -- all tests pass
2. `pnpm test:run` -- full suite passes (with known 2 failures in habit-logs.test.ts)
3. `pnpm lint` -- clean
4. `pnpm build` -- succeeds
  </verify>
  <done>
AppSidebar test suite has 16+ tests covering nav items (original 10) plus pin toggle button (6 new: rendering, aria-pressed states, click handler, tooltip labels). Full test suite, lint, and build pass.
  </done>
</task>

</tasks>

<verification>
After this plan completes:
1. All existing AppSidebar tests pass unchanged in behavior
2. 6 new pin toggle tests pass
3. `pnpm test:run` full suite passes
4. `pnpm lint` clean
5. `pnpm build` succeeds
</verification>

<success_criteria>
- AppSidebar test suite updated with pin toggle coverage (aria-pressed, click handler, tooltip labels)
- All 10 existing tests still pass
- 6+ new tests for pin toggle pass
- Build, lint, and full test suite clean
</success_criteria>

<output>
After completion, create `.planning/phases/03-sidebar-collapse-persistence/03-02-SUMMARY.md`
</output>
