---
phase: 02-sidebar-shell-navigation-switch
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - components/ui/sidebar.tsx
  - components/layouts/app-sidebar.tsx
  - components/layouts/sidebar-shell.tsx
  - app/dashboard/layout.tsx
  - app/habits/layout.tsx
  - app/tasks/layout.tsx
  - components/layouts/app-layout.tsx
  - components/main-nav.tsx
  - components/mobile-bottom-nav.tsx
autonomous: true

must_haves:
  truths:
    - "User sees a left sidebar with icon + label navigation items for Dashboard, Habits, and Tasks on desktop viewports"
    - "Current page is visually highlighted with an active state indicator in the sidebar"
    - "On mobile viewports (<768px), sidebar appears as a sheet/drawer from the left edge"
    - "Old top navigation bar and mobile bottom navigation are fully removed (no dual-nav state)"
  artifacts:
    - path: "components/ui/sidebar.tsx"
      provides: "shadcn/ui sidebar primitive with width constants aligned to Phase 1 tokens"
      contains: "SIDEBAR_WIDTH"
    - path: "components/layouts/app-sidebar.tsx"
      provides: "Sidebar navigation component with 3 nav items, active state, i18n"
      exports: ["AppSidebar"]
    - path: "components/layouts/sidebar-shell.tsx"
      provides: "Shared layout wrapper: SidebarProvider + AppSidebar + SidebarInset + mobile header"
      exports: ["SidebarShell"]
    - path: "app/dashboard/layout.tsx"
      provides: "Dashboard layout using SidebarShell"
      contains: "SidebarShell"
    - path: "app/habits/layout.tsx"
      provides: "Habits layout using SidebarShell"
      contains: "SidebarShell"
    - path: "app/tasks/layout.tsx"
      provides: "Tasks layout using SidebarShell"
      contains: "SidebarShell"
  key_links:
    - from: "components/layouts/app-sidebar.tsx"
      to: "components/ui/sidebar.tsx"
      via: "imports SidebarMenuButton with isActive prop for active state"
      pattern: "isActive.*match.*pathname"
    - from: "components/layouts/sidebar-shell.tsx"
      to: "components/layouts/app-sidebar.tsx"
      via: "composes AppSidebar inside SidebarProvider + SidebarInset"
      pattern: "SidebarProvider.*AppSidebar.*SidebarInset"
    - from: "app/dashboard/layout.tsx"
      to: "components/layouts/sidebar-shell.tsx"
      via: "renders children inside SidebarShell"
      pattern: "SidebarShell"
---

<objective>
Install the shadcn/ui Sidebar component, build the AppSidebar and SidebarShell components, replace the old top-nav/bottom-nav layout with the new sidebar layout in all three authenticated route layouts, and delete the old navigation components.

Purpose: Switch the app from top-nav + bottom-tab-bar navigation to a persistent left sidebar on desktop and a Sheet/drawer on mobile, fulfilling SIDE-01, SIDE-03, SIDE-04, SIDE-07.

Output: Working sidebar navigation across all authenticated pages with active state highlighting, mobile sheet access, and zero dual-nav state.
</objective>

<execution_context>
@/home/xingdi/.claude/get-shit-done/workflows/execute-plan.md
@/home/xingdi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-sidebar-shell-navigation-switch/02-RESEARCH.md
@.planning/phases/01-design-token-extraction-css-foundation/01-01-SUMMARY.md
@.planning/phases/01-design-token-extraction-css-foundation/01-02-SUMMARY.md
@components/layouts/app-layout.tsx
@components/main-nav.tsx
@components/mobile-bottom-nav.tsx
@app/dashboard/layout.tsx
@app/habits/layout.tsx
@app/tasks/layout.tsx
@app/globals.css
@tailwind.config.ts
@components.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install shadcn sidebar and create AppSidebar + SidebarShell components</name>
  <files>
    components/ui/sidebar.tsx
    components/layouts/app-sidebar.tsx
    components/layouts/sidebar-shell.tsx
  </files>
  <action>
**Step 1: Fix components.json config field.**

Read `components.json`. The `"config"` field is `""` (empty string, TW4 pattern). Before installing the sidebar, update it to `"config": "tailwind.config.ts"` so the CLI generates Tailwind v3-compatible code. The project uses Tailwind CSS 3 with `tailwind.config.ts`.

**Step 2: Install the shadcn/ui sidebar component.**

Run:
```bash
pnpx shadcn@latest add sidebar --yes
```

This creates `components/ui/sidebar.tsx`. It may also attempt to create `hooks/use-mobile.ts` (already exists -- let it overwrite or skip, both are fine).

**Step 3: Update sidebar width constants.**

In `components/ui/sidebar.tsx`, find and update these three constants to match Phase 1 design tokens:
- `SIDEBAR_WIDTH = "16rem"` -> `SIDEBAR_WIDTH = "12.5rem"` (200px, matches --sidebar-width)
- `SIDEBAR_WIDTH_MOBILE = "18rem"` -> `SIDEBAR_WIDTH_MOBILE = "17.5rem"` (280px, matches --sidebar-width-mobile)
- `SIDEBAR_WIDTH_ICON = "3rem"` -> keep as-is (48px, already matches --sidebar-width-icon)

NOTE: `components/ui/` is normally not edited, but this is an exception documented in the research -- we are aligning shadcn defaults with our design token system. This is a configuration adjustment, not a component behavior change.

**Step 4: Create AppSidebar component.**

Create `components/layouts/app-sidebar.tsx` as a `"use client"` component:

```typescript
"use client";

import Link from "next/link";
import { usePathname } from "next/navigation";
import { useTranslations } from "next-intl";
import { Home, ClipboardList, ListChecks } from "lucide-react";
import {
  Sidebar,
  SidebarContent,
  SidebarGroup,
  SidebarGroupContent,
  SidebarHeader,
  SidebarMenu,
  SidebarMenuItem,
  SidebarMenuButton,
  SidebarFooter,
} from "@/components/ui/sidebar";
```

Navigation items array (single source of truth):
```typescript
const navItems = [
  {
    href: "/dashboard",
    icon: Home,
    labelKey: "dashboard",
    match: (p: string) => p === "/dashboard" || p === "/dashboard/settings",
  },
  {
    href: "/habits",
    icon: ClipboardList,
    labelKey: "habits",
    match: (p: string) => p.startsWith("/habits"),
  },
  {
    href: "/tasks",
    icon: ListChecks,
    labelKey: "tasks",
    match: (p: string) => p.startsWith("/tasks"),
  },
];
```

The component:
- Uses `usePathname()` for active state detection
- Uses `useTranslations("common.nav")` for i18n labels (reuses existing keys: dashboard, habits, tasks)
- Renders `<Sidebar>` with:
  - `<SidebarHeader>`: Brand text "BetterR.me" using `font-display font-bold text-lg text-primary`
  - `<SidebarContent>`: One `<SidebarGroup>` containing `<SidebarMenu>` with items
  - Each item: `<SidebarMenuItem>` > `<SidebarMenuButton asChild isActive={item.match(pathname)} tooltip={t(item.labelKey)}>` > `<Link href={item.href}>` with icon + label span
  - `<SidebarFooter />`: Empty for now (Phase 7 adds user profile, theme/language switchers)
- Follows Chameleon visual reference: clean, spacious items with icon + label layout

**Step 5: Create SidebarShell shared layout wrapper.**

Create `components/layouts/sidebar-shell.tsx` as a **server component** (NO "use client"):

```typescript
import { cookies } from "next/headers";
import {
  SidebarProvider,
  SidebarInset,
  SidebarTrigger,
} from "@/components/ui/sidebar";
import { AppSidebar } from "@/components/layouts/app-sidebar";
```

The component:
- Reads `sidebar_state` cookie via `await cookies()` to determine `defaultOpen` (true if cookie is missing or not "false")
- Renders the full sidebar shell layout:
  ```
  <SidebarProvider defaultOpen={defaultOpen}>
    <AppSidebar />
    <SidebarInset>
      <header className="flex h-14 shrink-0 items-center gap-2 border-b px-4 md:hidden">
        <SidebarTrigger className="-ml-1" />
        <span className="font-display font-bold text-lg text-primary">BetterR.me</span>
      </header>
      <div className="flex-1 p-4 md:p-6">
        {children}
      </div>
    </SidebarInset>
  </SidebarProvider>
  ```
- The mobile header (md:hidden) contains a hamburger trigger button + brand text
- NO `container`, NO `max-w-screen-2xl` on content div -- sidebar constrains width. Use simple `p-4 md:p-6` padding.
- NO `pb-20 md:pb-0` padding -- that was for the old MobileBottomNav
- NO `overflow-x-hidden` -- the old layout needed it for skeleton widths; the sidebar layout has proper containment

Export `SidebarShell` as a named export with `async function` signature taking `{ children: React.ReactNode }`.
  </action>
  <verify>
- `components/ui/sidebar.tsx` exists and contains `SIDEBAR_WIDTH = "12.5rem"`
- `components/layouts/app-sidebar.tsx` exists, has `"use client"`, exports `AppSidebar`, imports from `@/components/ui/sidebar`
- `components/layouts/sidebar-shell.tsx` exists, does NOT have `"use client"`, exports `SidebarShell`, imports `AppSidebar` and `SidebarProvider`
- `pnpm lint` passes (no unused imports, no type errors)
  </verify>
  <done>
- shadcn sidebar component installed with width constants matching Phase 1 tokens (12.5rem, 17.5rem, 3rem)
- AppSidebar renders 3 nav items (Dashboard, Habits, Tasks) with icons, i18n labels, and active state detection via pathname matching
- SidebarShell wraps AppSidebar in SidebarProvider with cookie-based defaultOpen, includes mobile-only header with SidebarTrigger
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace AppLayout with SidebarShell and delete old navigation components</name>
  <files>
    app/dashboard/layout.tsx
    app/habits/layout.tsx
    app/tasks/layout.tsx
    components/layouts/app-layout.tsx
    components/main-nav.tsx
    components/mobile-bottom-nav.tsx
  </files>
  <action>
**Step 1: Update all 3 layout files to use SidebarShell.**

Replace the contents of `app/dashboard/layout.tsx`, `app/habits/layout.tsx`, and `app/tasks/layout.tsx`. Each layout becomes an async server component that simply wraps children in SidebarShell.

Example for `app/dashboard/layout.tsx`:
```typescript
import { SidebarShell } from "@/components/layouts/sidebar-shell";

export default async function DashboardLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return <SidebarShell>{children}</SidebarShell>;
}
```

Same pattern for habits and tasks layouts (only the function name differs: `HabitsLayout`, `TasksLayout`).

Key changes from old layout:
- Import changes from `AppLayout` to `SidebarShell`
- Function becomes `async` (SidebarShell uses `await cookies()`)
- No other changes needed -- SidebarShell handles everything

**Step 2: Delete old navigation components.**

Delete these 3 files (they are fully replaced by AppSidebar + SidebarShell):
- `components/layouts/app-layout.tsx` -- replaced by SidebarShell
- `components/main-nav.tsx` -- replaced by nav items inside AppSidebar
- `components/mobile-bottom-nav.tsx` -- replaced by sidebar's mobile Sheet

Use `git rm` to delete them so git tracks the deletion:
```bash
git rm components/layouts/app-layout.tsx
git rm components/main-nav.tsx
git rm components/mobile-bottom-nav.tsx
```

**Step 3: Verify no remaining imports of deleted components.**

Run a search for any remaining references to the deleted components:
```bash
grep -r "app-layout\|AppLayout\|main-nav\|MainNav\|mobile-bottom-nav\|MobileBottomNav" --include="*.tsx" --include="*.ts" app/ components/ lib/
```

The only remaining reference should be in `tests/components/mobile-bottom-nav.test.tsx` (handled in Plan 02-02). If any other references are found in production code, fix them.

Note: `e2e/task-detail.spec.ts` line 41 has a comment mentioning "AppLayout wraps in <main>" -- this is just a comment and does NOT need updating (the new layout still has a main-like content area; updating E2E test comments is Phase 9 scope).

**Step 4: Verify the app builds.**

Run:
```bash
pnpm build
```

The build must succeed. If it fails due to import errors from deleted components, fix any missed references.
  </action>
  <verify>
- `app/dashboard/layout.tsx` imports `SidebarShell` (not `AppLayout`)
- `app/habits/layout.tsx` imports `SidebarShell` (not `AppLayout`)
- `app/tasks/layout.tsx` imports `SidebarShell` (not `AppLayout`)
- `components/layouts/app-layout.tsx` does NOT exist
- `components/main-nav.tsx` does NOT exist
- `components/mobile-bottom-nav.tsx` does NOT exist
- `pnpm build` succeeds
- No production code imports `AppLayout`, `MainNav`, or `MobileBottomNav`
  </verify>
  <done>
- All 3 authenticated route layouts use SidebarShell wrapper instead of AppLayout
- Old navigation components (app-layout.tsx, main-nav.tsx, mobile-bottom-nav.tsx) are deleted
- No dual-nav state exists -- only the sidebar provides navigation
- Production build succeeds with no import errors
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` passes -- no import errors, no TypeScript errors
2. `pnpm lint` passes -- no ESLint issues
3. `components/ui/sidebar.tsx` exists with `SIDEBAR_WIDTH = "12.5rem"`
4. `components/layouts/app-sidebar.tsx` exports `AppSidebar` with 3 nav items
5. `components/layouts/sidebar-shell.tsx` exports `SidebarShell` with SidebarProvider + AppSidebar + SidebarInset
6. All 3 layout files (dashboard, habits, tasks) import and use `SidebarShell`
7. No file imports `AppLayout`, `MainNav`, or `MobileBottomNav`
8. Deleted files do not exist: `components/layouts/app-layout.tsx`, `components/main-nav.tsx`, `components/mobile-bottom-nav.tsx`
</verification>

<success_criteria>
- Desktop viewport shows a left sidebar with BetterR.me branding and 3 nav items (Dashboard, Habits, Tasks) with icons and labels
- Active page is highlighted in the sidebar via isActive prop on SidebarMenuButton
- Mobile viewport (<768px) shows a header with hamburger trigger; tapping it opens a Sheet/drawer from the left with the same 3 nav items
- No top navigation bar or bottom tab bar exists anywhere in the app
- Build and lint pass cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/02-sidebar-shell-navigation-switch/02-01-SUMMARY.md`
</output>
