---
phase: 02-sidebar-shell-navigation-switch
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - tests/components/mobile-bottom-nav.test.tsx
  - tests/components/layouts/app-sidebar.test.tsx
autonomous: true

must_haves:
  truths:
    - "AppSidebar component renders all 3 navigation items with correct links"
    - "AppSidebar highlights the active page based on pathname matching"
    - "AppSidebar uses i18n translation keys for nav labels"
    - "Old MobileBottomNav test is removed (component no longer exists)"
    - "Full test suite passes (build, lint, vitest)"
  artifacts:
    - path: "tests/components/layouts/app-sidebar.test.tsx"
      provides: "Unit tests for AppSidebar: rendering, active states, i18n, accessibility"
      contains: "AppSidebar"
  key_links:
    - from: "tests/components/layouts/app-sidebar.test.tsx"
      to: "components/layouts/app-sidebar.tsx"
      via: "imports and renders AppSidebar component"
      pattern: "import.*AppSidebar.*app-sidebar"
---

<objective>
Delete the obsolete MobileBottomNav test and create a comprehensive unit test for the new AppSidebar component, then verify the full test suite (build, lint, vitest) passes cleanly.

Purpose: Maintain test coverage for navigation behavior after the nav architecture switch, ensuring active state detection, i18n label rendering, and accessibility are verified.

Output: New AppSidebar test file with full coverage, no test regressions.
</objective>

<execution_context>
@/home/xingdi/.claude/get-shit-done/workflows/execute-plan.md
@/home/xingdi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-sidebar-shell-navigation-switch/02-01-SUMMARY.md
@components/layouts/app-sidebar.tsx
@tests/components/mobile-bottom-nav.test.tsx
@tests/setup.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Delete old MobileBottomNav test and create AppSidebar test</name>
  <files>
    tests/components/mobile-bottom-nav.test.tsx
    tests/components/layouts/app-sidebar.test.tsx
  </files>
  <action>
**Step 1: Delete the old MobileBottomNav test.**

```bash
git rm tests/components/mobile-bottom-nav.test.tsx
```

This test references the deleted `MobileBottomNav` component and would fail with an import error.

**Step 2: Create the AppSidebar test file.**

Create `tests/components/layouts/app-sidebar.test.tsx`. The test needs these mocks:

1. **next/navigation mock:** Mock `usePathname` to return controlled pathnames for active state testing.
2. **next-intl mock:** Mock `useTranslations` to return the key as-is (standard pattern: `(key: string) => key`).
3. **shadcn sidebar mock:** The sidebar components use React Context internally (`SidebarProvider` provides context to `SidebarMenuButton`). The simplest approach is to wrap `AppSidebar` in `<SidebarProvider>` in each test render. Import `SidebarProvider` from `@/components/ui/sidebar`. If `SidebarProvider` requires browser APIs not available in jsdom, mock the sidebar UI components instead -- mock `@/components/ui/sidebar` to render simplified versions (e.g., `Sidebar` renders a `<nav>`, `SidebarMenuButton` renders a `<button>` with `data-active` from `isActive` prop).

**Recommended mock approach for sidebar (use simplified component mocks):**

```typescript
vi.mock("@/components/ui/sidebar", () => ({
  Sidebar: ({ children, ...props }: any) => <nav data-testid="sidebar" {...props}>{children}</nav>,
  SidebarContent: ({ children }: any) => <div>{children}</div>,
  SidebarGroup: ({ children }: any) => <div>{children}</div>,
  SidebarGroupContent: ({ children }: any) => <div>{children}</div>,
  SidebarHeader: ({ children }: any) => <div data-testid="sidebar-header">{children}</div>,
  SidebarMenu: ({ children }: any) => <ul>{children}</ul>,
  SidebarMenuItem: ({ children }: any) => <li>{children}</li>,
  SidebarMenuButton: ({ children, isActive, asChild, tooltip, ...props }: any) => {
    if (asChild) {
      // When asChild, render children directly but add data-active attribute
      // Clone the child element and add the attribute
      const child = React.Children.only(children);
      return React.cloneElement(child, {
        "data-active": isActive || undefined,
        "aria-current": isActive ? "page" : undefined,
      });
    }
    return <button data-active={isActive || undefined} {...props}>{children}</button>;
  },
  SidebarFooter: ({ children }: any) => <div data-testid="sidebar-footer">{children}</div>,
}));
```

**Test cases to cover (port from MobileBottomNav test + extend):**

1. **Renders all 3 nav items:** Renders 3 links with correct hrefs (/dashboard, /habits, /tasks).
2. **Renders i18n labels:** Each nav item shows its translation key text (dashboard, habits, tasks).
3. **Active state -- dashboard:** When pathname is "/dashboard", the dashboard link has `aria-current="page"` or `data-active` attribute.
4. **Active state -- dashboard/settings:** When pathname is "/dashboard/settings", the dashboard link is still active (match function includes settings).
5. **Active state -- habits nested:** When pathname is "/habits/abc-123", the habits link is active.
6. **Active state -- tasks:** When pathname is "/tasks", the tasks link is active.
7. **Only one active item at a time:** When on /dashboard, only 1 link has the active indicator.
8. **Renders brand text in header:** The sidebar header contains "BetterR.me" text.
9. **Accessibility:** The sidebar renders with a `<nav>` element (via the Sidebar mock rendering `<nav>`).

**Mock pattern for pathname:**
```typescript
const mockPathname = vi.fn(() => "/dashboard");
vi.mock("next/navigation", () => ({
  usePathname: () => mockPathname(),
}));
```

Use `mockPathname.mockReturnValue("/habits/abc-123")` before each test that needs a different pathname.
  </action>
  <verify>
- `tests/components/mobile-bottom-nav.test.tsx` does NOT exist
- `tests/components/layouts/app-sidebar.test.tsx` exists and imports `AppSidebar`
- `pnpm vitest run tests/components/layouts/app-sidebar.test.tsx` passes all tests
  </verify>
  <done>
- Old MobileBottomNav test deleted
- New AppSidebar test covers: rendering 3 nav items, i18n labels, active state for dashboard/habits/tasks with nested routes, single active item constraint, brand text, accessibility landmark
- All new tests pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify full build, lint, and test suite pass</name>
  <files></files>
  <action>
**Step 1: Run the full build.**

```bash
pnpm build
```

Must pass with no errors. If TypeScript or import errors appear, fix them (likely residual references to deleted components).

**Step 2: Run lint.**

```bash
pnpm lint
```

Must pass. Fix any ESLint errors in new or modified files.

**Step 3: Run the full Vitest test suite.**

```bash
pnpm test:run
```

Must pass. Known pre-existing failures: 2 in `habit-logs.test.ts` (`times_per_week getDetailedHabitStats`) per issue #98 -- these are expected and not caused by this phase.

If any NEW test failures occur (beyond the 2 known ones), diagnose and fix:
- Import errors from deleted components: Search for remaining imports of `MobileBottomNav`, `MainNav`, `AppLayout` in test files and remove/update them.
- Sidebar-related failures: Ensure mocks are correct in the new test file.
- Accessibility test failures: Check `tests/accessibility/a11y.test.tsx` -- the Navbar test (lines 130-137) tests the PUBLIC landing page nav component, NOT the authenticated app nav. It should still pass since `Navbar` (the public landing page component) is NOT being modified in this phase. If it fails, investigate.

**Step 4: Confirm test count.**

The total test count should be approximately the same as before (937 from Phase 1). The delta should be: -9 tests (deleted MobileBottomNav tests) + N new AppSidebar tests (~9 tests) = approximately net zero change.
  </action>
  <verify>
- `pnpm build` exits with code 0
- `pnpm lint` exits with code 0
- `pnpm test:run` passes (only the 2 known pre-existing failures in habit-logs.test.ts are acceptable)
  </verify>
  <done>
- Production build succeeds
- ESLint passes with no errors
- Full Vitest suite passes (minus the 2 known pre-existing failures)
- No test regressions introduced by the sidebar switch
  </done>
</task>

</tasks>

<verification>
1. `tests/components/mobile-bottom-nav.test.tsx` does not exist
2. `tests/components/layouts/app-sidebar.test.tsx` exists with 8+ test cases
3. `pnpm build` passes
4. `pnpm lint` passes
5. `pnpm test:run` passes (only 2 known pre-existing failures acceptable)
6. No imports of `MobileBottomNav`, `MainNav`, or `AppLayout` exist in any test file
</verification>

<success_criteria>
- AppSidebar test covers rendering, active states (dashboard, habits, tasks with nested routes), i18n, and accessibility
- Full build + lint + test suite passes with no new regressions
- Test count approximately maintained (delta from deleted + added tests)
</success_criteria>

<output>
After completion, create `.planning/phases/02-sidebar-shell-navigation-switch/02-02-SUMMARY.md`
</output>
