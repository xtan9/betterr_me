---
phase: 09-test-stabilization-baseline-regeneration
plan: 02
type: execute
wave: 2
depends_on:
  - "09-01"
files_modified:
  - e2e/visual-regression.spec.ts-snapshots/
  - e2e/locale-verification.spec.ts
autonomous: true
requirements:
  - TEST-03
  - TEST-05
  - TEST-06

must_haves:
  truths:
    - "Visual regression baselines reflect the final post-Phase-8 sidebar design"
    - "Visual regression tests pass clean against the new baselines (no diff failures)"
    - "All three locales (en, zh, zh-TW) render correct sidebar text in the new layout"
    - "Both light and dark mode are captured in visual regression baselines"
    - "The full E2E test suite passes across all browser projects"
  artifacts:
    - path: "e2e/visual-regression.spec.ts-snapshots/"
      provides: "18 regenerated baseline PNGs for the new sidebar design"
    - path: "e2e/locale-verification.spec.ts"
      provides: "E2E locale smoke test verifying sidebar nav text in 3 locales"
      contains: "locale"
  key_links:
    - from: "e2e/visual-regression.spec.ts"
      to: "e2e/visual-regression.spec.ts-snapshots/"
      via: "toHaveScreenshot() comparison"
      pattern: "toHaveScreenshot"
    - from: "e2e/locale-verification.spec.ts"
      to: "i18n/messages/*.json"
      via: "locale cookie setting + sidebar text verification"
      pattern: "addCookies.*locale"
---

<objective>
Regenerate all visual regression baselines to capture the final post-redesign sidebar layout, add locale verification E2E tests, and run the full test suite to confirm zero regressions.

Purpose: Ensure the visual regression baselines are fresh and accurate for the new design, verify all three locales render correctly in the sidebar layout, and confirm the entire test suite (unit + E2E across all browsers) passes green.

Output: 18 regenerated baseline PNGs, a locale verification E2E spec, and a confirmed-green full test suite.
</objective>

<execution_context>
@/home/xingdi/.claude/get-shit-done/workflows/execute-plan.md
@/home/xingdi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-test-stabilization-baseline-regeneration/09-RESEARCH.md
@.planning/phases/09-test-stabilization-baseline-regeneration/09-01-SUMMARY.md
@e2e/visual-regression.spec.ts
@playwright.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Regenerate visual regression baselines</name>
  <files>e2e/visual-regression.spec.ts-snapshots/</files>
  <action>
Step 1: Delete ALL existing baseline PNGs in the snapshots directory:
```bash
rm -rf e2e/visual-regression.spec.ts-snapshots/
```
This removes all 18 stale baselines (login-page, dashboard-light, dashboard-dark, habits-list, create-habit-form, settings-page -- each in chromium, mobile-chrome, and mobile-small variants).

Step 2: Regenerate baselines using the visual-regression Playwright project with the `--update-snapshots` flag:
```bash
pnpm test:e2e:visual -- --update-snapshots
```
This creates fresh baselines reflecting the current sidebar layout, card-on-gray design, desaturated dark mode accents, and hover/focus polish from Phases 1-8.

Step 3: Verify the new baselines pass clean (no diff failures):
```bash
pnpm test:e2e:visual
```
All 6 visual regression tests (login-page, dashboard-light, dashboard-dark, habits-list, create-habit-form, settings-page) should pass with 0 diff.

Step 4: Verify 18 baseline PNGs were created (6 tests x 3 viewport variants: chromium, mobile-chrome, mobile-small):
```bash
ls e2e/visual-regression.spec.ts-snapshots/ | wc -l
```
Expect 18 files. Each filename follows the pattern `{test-name}-{project}-linux.png`.

Note: Baselines are platform-dependent (Linux). The Playwright config uses `{platform}` in the snapshot path template. Always regenerate on the same platform used in CI.
  </action>
  <verify>Run `pnpm test:e2e:visual` (without --update-snapshots). All 6 visual regression tests pass with 0 diff. Exactly 18 baseline PNGs exist in `e2e/visual-regression.spec.ts-snapshots/`.</verify>
  <done>18 visual regression baselines regenerated for the post-redesign sidebar layout. Visual regression tests pass clean against new baselines. Both light and dark mode dashboards captured.</done>
</task>

<task type="auto">
  <name>Task 2: Add locale verification E2E test and run full suite</name>
  <files>e2e/locale-verification.spec.ts</files>
  <action>
**Create `e2e/locale-verification.spec.ts`** -- a lightweight E2E smoke test that verifies all three locales render correct sidebar navigation text.

The test sets the `locale` cookie before navigating to `/dashboard`, then verifies that key sidebar nav labels appear in the expected language. This covers TEST-05 (all three locales render correctly with the sidebar layout).

```typescript
import { test, expect } from '@playwright/test';

/**
 * Locale verification — confirms sidebar navigation text renders
 * correctly for all three supported locales (en, zh, zh-TW).
 */

const localeExpectations = [
  {
    locale: 'en',
    navLabels: ['Dashboard', 'Habits', 'Tasks', 'Settings'],
  },
  {
    locale: 'zh',
    navLabels: ['仪表板', '习惯', '任务', '设置'],
  },
  {
    locale: 'zh-TW',
    navLabels: ['儀表板', '習慣', '任務', '設定'],
  },
];

for (const { locale, navLabels } of localeExpectations) {
  test(`sidebar renders correct text for locale: ${locale}`, async ({ page }) => {
    // Set locale cookie before navigation
    await page.context().addCookies([{
      name: 'locale',
      value: locale,
      domain: 'localhost',
      path: '/',
    }]);

    await page.goto('/dashboard');
    await page.waitForLoadState('networkidle');

    // On mobile viewports, open the sidebar sheet first
    const sidebarTrigger = page.locator('button[data-sidebar="trigger"]');
    const isMobile = await sidebarTrigger.isVisible().catch(() => false);
    if (isMobile) {
      await sidebarTrigger.click();
      await page.waitForTimeout(300);
    }

    // Verify at least the Dashboard and Habits nav labels appear in the correct locale
    // Use first two labels as a sufficient smoke test
    for (const label of navLabels.slice(0, 2)) {
      await expect(page.getByText(label, { exact: true }).first()).toBeVisible({ timeout: 10000 });
    }
  });
}
```

After creating the locale spec, run the full E2E test suite across all projects to confirm everything passes:

1. `pnpm test:e2e:chromium` -- chromium + visual-regression projects (primary gate)
2. If chromium passes, run the broader suite: `pnpm test:e2e` -- all 8 projects (chromium, firefox, webkit, mobile-chrome, mobile-safari, tablet, mobile-small, visual-regression)

Also run the full Vitest unit suite one final time to confirm nothing regressed:
```bash
pnpm test:run
```

And verify lint is clean:
```bash
pnpm lint
```

The 2 known pre-existing failures in `habit-logs.test.ts` (issue #98) are expected and out of scope.
  </action>
  <verify>
1. `pnpm test:e2e:chromium` passes (including locale-verification.spec.ts)
2. `pnpm test:run` passes (all Vitest unit tests, minus 2 known failures)
3. `pnpm lint` passes
4. Locale verification tests confirm en, zh, zh-TW sidebar text renders correctly
  </verify>
  <done>Locale verification E2E test created and passing for all 3 locales. Full E2E suite passes across chromium project. Full Vitest suite passes. Lint is clean. Zero functional regressions confirmed.</done>
</task>

</tasks>

<verification>
1. `ls e2e/visual-regression.spec.ts-snapshots/ | wc -l` returns 18
2. `pnpm test:e2e:visual` -- All visual regression tests pass clean (no diff)
3. `pnpm test:e2e:chromium` -- All E2E tests pass on chromium + visual-regression projects
4. `pnpm test:run` -- All Vitest unit tests pass (minus 2 known failures)
5. `pnpm lint` -- No lint errors
6. `pnpm build` -- Production build succeeds (final sanity check)
</verification>

<success_criteria>
- 18 visual regression baselines regenerated and passing clean
- Locale verification E2E test confirms en, zh, zh-TW render correct sidebar text
- Both light and dark mode captured in visual regression baselines
- Full Vitest unit test suite passes
- Full E2E chromium suite passes
- Lint and build are clean
</success_criteria>

<output>
After completion, create `.planning/phases/09-test-stabilization-baseline-regeneration/09-02-SUMMARY.md`
</output>
