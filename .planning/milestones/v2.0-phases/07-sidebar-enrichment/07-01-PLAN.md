---
phase: 07-sidebar-enrichment
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - components/layouts/app-sidebar.tsx
  - tests/components/layouts/app-sidebar.test.tsx
  - i18n/messages/en.json
  - i18n/messages/zh.json
  - i18n/messages/zh-TW.json
autonomous: true
requirements: [SIDE-08]

must_haves:
  truths:
    - "Nav items are organized into Main (Dashboard, Habits, Tasks) and Account (Settings) groups"
    - "Group labels are visible in expanded mode and hidden in icon (collapsed) mode"
    - "Both groups default to open"
    - "Settings nav item shows gear icon, is active on /dashboard/settings, and links to /dashboard/settings"
    - "Dashboard nav item is NOT active when on /dashboard/settings"
  artifacts:
    - path: "components/layouts/app-sidebar.tsx"
      provides: "Collapsible section groups with Settings nav item"
      contains: "SidebarGroupLabel"
    - path: "tests/components/layouts/app-sidebar.test.tsx"
      provides: "Updated tests covering groups and Settings nav"
      contains: "settings"
    - path: "i18n/messages/en.json"
      provides: "Group label translations"
      contains: "mainGroup"
  key_links:
    - from: "components/layouts/app-sidebar.tsx"
      to: "components/ui/sidebar.tsx"
      via: "SidebarGroupLabel, Collapsible imports"
      pattern: "SidebarGroupLabel"
    - from: "components/layouts/app-sidebar.tsx"
      to: "components/ui/collapsible.tsx"
      via: "Collapsible wrapping SidebarGroup"
      pattern: "Collapsible"
---

<objective>
Restructure the AppSidebar navigation into two collapsible section groups (Main and Account) and add a Settings nav item under the Account group.

Purpose: Organizes sidebar navigation into logical sections per SIDE-08, and separates Settings from Dashboard's active state so Settings can have its own nav item.
Output: Restructured AppSidebar with collapsible groups, Settings nav item, updated tests, i18n strings.
</objective>

<execution_context>
@/home/xingdi/.claude/get-shit-done/workflows/execute-plan.md
@/home/xingdi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-sidebar-enrichment/07-RESEARCH.md
@components/layouts/app-sidebar.tsx
@components/ui/sidebar.tsx
@components/ui/collapsible.tsx
@tests/components/layouts/app-sidebar.test.tsx
@i18n/messages/en.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Restructure AppSidebar into collapsible section groups with Settings nav item</name>
  <files>
    components/layouts/app-sidebar.tsx
    i18n/messages/en.json
    i18n/messages/zh.json
    i18n/messages/zh-TW.json
  </files>
  <action>
Modify `components/layouts/app-sidebar.tsx`:

1. Add imports: `SidebarGroupLabel`, `SidebarMenuBadge` from `@/components/ui/sidebar` (SidebarMenuBadge imported now for future use in 07-03). Add `Collapsible`, `CollapsibleTrigger`, `CollapsibleContent` from `@/components/ui/collapsible`. Add `Settings` and `ChevronDown` icons from `lucide-react`.

2. Split `navItems` into two arrays:
   - `mainNavItems`: Dashboard, Habits, Tasks (existing 3 items)
   - `accountNavItems`: Settings (new item: `{ href: "/dashboard/settings", icon: Settings, labelKey: "settings", match: (p: string) => p === "/dashboard/settings" }`)

3. Update Dashboard's match function to EXCLUDE `/dashboard/settings`:
   - Before: `match: (p: string) => p === "/dashboard" || p === "/dashboard/settings"`
   - After: `match: (p: string) => p === "/dashboard"`

4. Replace the single `SidebarGroup` in `SidebarContent` with two collapsible groups using this pattern:
   ```tsx
   <Collapsible defaultOpen className="group/collapsible">
     <SidebarGroup>
       <SidebarGroupLabel asChild>
         <CollapsibleTrigger className="flex w-full items-center">
           {tSidebar("mainGroup")}
           <ChevronDown className="ml-auto size-4 transition-transform duration-200 group-data-[state=open]/collapsible:rotate-180" />
         </CollapsibleTrigger>
       </SidebarGroupLabel>
       <CollapsibleContent>
         <SidebarGroupContent>
           <SidebarMenu>
             {mainNavItems.map(/* existing render */)}
           </SidebarMenu>
         </SidebarGroupContent>
       </CollapsibleContent>
     </SidebarGroup>
   </Collapsible>
   ```
   Repeat for Account group with `accountNavItems`. Note: each `Collapsible` needs a unique `className` to avoid CSS selector conflicts: use `group/main` and `group/account` respectively, or keep `group/collapsible` since each is a separate DOM tree.

5. Add a new `useTranslations` call: `const tNav = useTranslations("common.nav");` -- but actually, the existing `t` already uses `common.nav`. Use `t("settings")` for the Settings label since `settings` already exists in `common.nav`.

6. Add i18n keys to all three locale files under `common.sidebar`:
   - en.json: `"mainGroup": "Main"`, `"accountGroup": "Account"`
   - zh.json: `"mainGroup": "主要"`, `"accountGroup": "账户"`
   - zh-TW.json: `"mainGroup": "主要"`, `"accountGroup": "帳戶"`
  </action>
  <verify>
Run `pnpm build` to confirm no TypeScript or build errors. Visually inspect that group labels and Settings nav item render by checking the component structure compiles.
  </verify>
  <done>
AppSidebar renders two collapsible groups (Main with Dashboard/Habits/Tasks, Account with Settings). Dashboard active state no longer matches /dashboard/settings. Settings has its own nav item with gear icon active on /dashboard/settings. All three locale files have mainGroup/accountGroup translations.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update AppSidebar tests for section groups and Settings nav item</name>
  <files>
    tests/components/layouts/app-sidebar.test.tsx
  </files>
  <action>
Update `tests/components/layouts/app-sidebar.test.tsx`:

1. Add mock for `@/components/ui/collapsible`:
   ```tsx
   vi.mock("@/components/ui/collapsible", () => ({
     Collapsible: ({ children }: any) => <div>{children}</div>,
     CollapsibleTrigger: ({ children, asChild, ...props }: any) => {
       if (asChild) return <>{children}</>;
       return <button {...props}>{children}</button>;
     },
     CollapsibleContent: ({ children }: any) => <div>{children}</div>,
   }));
   ```

2. Add `SidebarGroupLabel` to the existing sidebar mock:
   ```tsx
   SidebarGroupLabel: ({ children, asChild }: any) => {
     if (asChild) return <>{children}</>;
     return <span data-testid="sidebar-group-label">{children}</span>;
   },
   ```
   Also add `SidebarMenuBadge` mock (for future 07-03 compatibility):
   ```tsx
   SidebarMenuBadge: ({ children }: any) => (
     <span data-testid="sidebar-menu-badge">{children}</span>
   ),
   ```

3. Update the "renders all nav items as links" test: expect 4 links now (Dashboard, Habits, Tasks, Settings).

4. Update the "renders correct hrefs" test: add assertion for Settings link at `/dashboard/settings` (4th link).

5. Update the "renders i18n translation keys" test: add assertion for "settings" text.

6. Update the "highlights dashboard when pathname is /dashboard/settings" test:
   - Change to assert that Settings link (not Dashboard) is active when pathname is `/dashboard/settings`.
   - The active link should have `href="/dashboard/settings"`, not `/dashboard`.

7. Add new test: "highlights settings link when on /dashboard/settings":
   ```tsx
   it("highlights settings link when pathname is /dashboard/settings", () => {
     mockPathname.mockReturnValue("/dashboard/settings");
     render(<AppSidebar {...defaultProps} />);
     const activeLink = screen.getByRole("link", { current: "page" });
     expect(activeLink).toHaveAttribute("href", "/dashboard/settings");
   });
   ```

8. Add test: "does not highlight dashboard when on settings page":
   ```tsx
   it("does not highlight dashboard when on /dashboard/settings", () => {
     mockPathname.mockReturnValue("/dashboard/settings");
     render(<AppSidebar {...defaultProps} />);
     const dashboardLink = screen.getByRole("link", { name: /dashboard/i });
     expect(dashboardLink).not.toHaveAttribute("aria-current", "page");
   });
   ```

9. Add test: "renders group labels":
   ```tsx
   it("renders sidebar group labels", () => {
     render(<AppSidebar {...defaultProps} />);
     expect(screen.getByText("mainGroup")).toBeInTheDocument();
     expect(screen.getByText("accountGroup")).toBeInTheDocument();
   });
   ```

10. Remove or update the old test "highlights dashboard link when pathname is /dashboard/settings" since Dashboard should NOT be active on that path anymore.

Run `pnpm test:run -- tests/components/layouts/app-sidebar.test.tsx` and then `pnpm lint`.
  </action>
  <verify>
Run `pnpm test:run -- tests/components/layouts/app-sidebar.test.tsx` -- all tests pass. Run `pnpm lint` -- no errors.
  </verify>
  <done>
AppSidebar test suite passes with updated assertions for 4 nav items, group labels, Settings active state on /dashboard/settings, Dashboard NOT active on /dashboard/settings. All existing pin toggle tests still pass.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` completes without errors
2. `pnpm test:run -- tests/components/layouts/app-sidebar.test.tsx` -- all tests pass
3. `pnpm lint` -- no lint errors
4. AppSidebar renders Main group (Dashboard, Habits, Tasks) and Account group (Settings)
5. Dashboard match no longer includes /dashboard/settings
6. Settings nav item is active when pathname is /dashboard/settings
</verification>

<success_criteria>
- Nav items organized into two collapsible groups with visible labels
- Settings has its own nav item with gear icon under Account group
- Dashboard and Settings active states are mutually exclusive
- All existing tests updated and passing
- i18n strings added to all 3 locales
</success_criteria>

<output>
After completion, create `.planning/phases/07-sidebar-enrichment/07-01-SUMMARY.md`
</output>
