---
phase: 07-sidebar-enrichment
plan: 03
type: execute
wave: 3
depends_on: ["07-02"]
files_modified:
  - app/api/sidebar/counts/route.ts
  - lib/hooks/use-sidebar-counts.ts
  - components/layouts/app-sidebar.tsx
  - tests/app/api/sidebar/counts/route.test.ts
  - tests/components/layouts/app-sidebar.test.tsx
autonomous: true
requirements: [SIDE-10]

must_haves:
  truths:
    - "Habits nav item shows count of incomplete habits today when count > 0"
    - "Tasks nav item shows count of tasks due today (including overdue) when count > 0"
    - "Badges are hidden when count is 0"
    - "Badges are hidden in icon (collapsed) mode via built-in SidebarMenuBadge CSS"
    - "Badge counts are capped at 9+ for display"
    - "No excessive API calls -- SWR deduplication with 5-minute refresh interval"
  artifacts:
    - path: "app/api/sidebar/counts/route.ts"
      provides: "Lightweight endpoint returning badge counts"
      exports: ["GET"]
    - path: "lib/hooks/use-sidebar-counts.ts"
      provides: "SWR hook for sidebar badge counts"
      exports: ["useSidebarCounts"]
    - path: "components/layouts/app-sidebar.tsx"
      provides: "Nav items with SidebarMenuBadge showing counts"
      contains: "SidebarMenuBadge"
  key_links:
    - from: "lib/hooks/use-sidebar-counts.ts"
      to: "/api/sidebar/counts"
      via: "SWR fetch with 5-minute refresh"
      pattern: "useSWR.*sidebar/counts"
    - from: "components/layouts/app-sidebar.tsx"
      to: "lib/hooks/use-sidebar-counts.ts"
      via: "useSidebarCounts hook call"
      pattern: "useSidebarCounts"
    - from: "app/api/sidebar/counts/route.ts"
      to: "lib/db"
      via: "HabitsDB and TasksDB queries"
      pattern: "(HabitsDB|TasksDB)"
---

<objective>
Create a lightweight sidebar counts API endpoint, an SWR hook, and add notification badges to the Habits and Tasks nav items in AppSidebar.

Purpose: Gives users at-a-glance awareness of pending work via badge counts on sidebar nav items per SIDE-10.
Output: New API route, SWR hook, badges on nav items, and tests.
</objective>

<execution_context>
@/home/xingdi/.claude/get-shit-done/workflows/execute-plan.md
@/home/xingdi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-sidebar-enrichment/07-RESEARCH.md
@.planning/phases/07-sidebar-enrichment/07-01-SUMMARY.md
@.planning/phases/07-sidebar-enrichment/07-02-SUMMARY.md
@components/layouts/app-sidebar.tsx
@app/api/dashboard/route.ts
@lib/db/habits.ts
@lib/db/tasks.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create sidebar counts API endpoint and SWR hook</name>
  <files>
    app/api/sidebar/counts/route.ts
    lib/hooks/use-sidebar-counts.ts
    tests/app/api/sidebar/counts/route.test.ts
  </files>
  <action>
**Create `app/api/sidebar/counts/route.ts`:**

A lightweight GET endpoint that returns two counts: incomplete habits today and tasks due today (including overdue).

```ts
import { NextRequest, NextResponse } from "next/server";
import { createClient } from "@/lib/supabase/server";
import { HabitsDB, TasksDB } from "@/lib/db";
import { getLocalDateString } from "@/lib/utils";

export async function GET(request: NextRequest) {
  try {
    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();

    if (!user) {
      return NextResponse.json({ error: "Unauthorized" }, { status: 401 });
    }

    const habitsDB = new HabitsDB(supabase);
    const tasksDB = new TasksDB(supabase);

    // Accept date from query param (client sends local date)
    const searchParams = request.nextUrl.searchParams;
    const date = searchParams.get("date") || getLocalDateString();

    // Run both queries in parallel
    const [habitsWithStatus, tasksDueToday] = await Promise.all([
      habitsDB.getHabitsWithTodayStatus(user.id, date),
      tasksDB.getTodayTasks(user.id),
    ]);

    // Count incomplete habits (active habits not completed today)
    const habitsIncomplete = habitsWithStatus.filter(h => !h.completed_today).length;

    // Tasks due = incomplete tasks due today or overdue (getTodayTasks already filters this)
    const tasksDue = tasksDueToday.length;

    return NextResponse.json({ habits_incomplete: habitsIncomplete, tasks_due: tasksDue });
  } catch (error) {
    console.error("GET /api/sidebar/counts error:", error);
    return NextResponse.json({ error: "Failed to fetch sidebar counts" }, { status: 500 });
  }
}
```

**Create `lib/hooks/use-sidebar-counts.ts`:**

```ts
import useSWR from "swr";
import { getLocalDateString } from "@/lib/utils";

interface SidebarCounts {
  habits_incomplete: number;
  tasks_due: number;
}

const fetcher = (url: string) => fetch(url).then(r => r.json());

export function useSidebarCounts() {
  const date = getLocalDateString();
  const { data, error, isLoading, mutate } = useSWR<SidebarCounts>(
    `/api/sidebar/counts?date=${date}`,
    fetcher,
    {
      refreshInterval: 300_000,      // 5 minutes -- badges are informational
      revalidateOnFocus: false,      // Don't refetch on tab switch
      dedupingInterval: 60_000,      // 1 minute dedup window
      keepPreviousData: true,        // Prevent flash when date changes at midnight
    }
  );

  return {
    habitsIncomplete: data?.habits_incomplete ?? 0,
    tasksDue: data?.tasks_due ?? 0,
    isLoading,
    error,
    mutate,
  };
}
```

**Create `tests/app/api/sidebar/counts/route.test.ts`:**

Use the existing API test pattern with `vi.hoisted` + mock DB classes:

```ts
import { describe, it, expect, vi, beforeEach } from "vitest";

const { mockGetUser, mockGetHabitsWithTodayStatus, mockGetTodayTasks } = vi.hoisted(() => ({
  mockGetUser: vi.fn(),
  mockGetHabitsWithTodayStatus: vi.fn(),
  mockGetTodayTasks: vi.fn(),
}));

vi.mock("@/lib/supabase/server", () => ({
  createClient: () => ({
    auth: { getUser: mockGetUser },
  }),
}));

vi.mock("@/lib/db", () => ({
  HabitsDB: class {
    getHabitsWithTodayStatus = mockGetHabitsWithTodayStatus;
  },
  TasksDB: class {
    getTodayTasks = mockGetTodayTasks;
  },
}));
```

Tests:
- "returns 401 when not authenticated": mockGetUser returns `{ data: { user: null } }`. Assert 401 response.
- "returns correct counts": mockGetUser returns valid user, mockGetHabitsWithTodayStatus returns 3 habits (1 completed, 2 not), mockGetTodayTasks returns 2 tasks. Assert `{ habits_incomplete: 2, tasks_due: 2 }`.
- "returns zero counts when all complete": All habits completed, no tasks. Assert `{ habits_incomplete: 0, tasks_due: 0 }`.
- "returns 500 on database error": Mock throws error. Assert 500 response.

Use `NextRequest` construction: `new NextRequest("http://localhost/api/sidebar/counts?date=2026-02-17")`.
  </action>
  <verify>
Run `pnpm test:run -- tests/app/api/sidebar/counts/route.test.ts` -- all tests pass. Run `pnpm build` to verify TypeScript compilation.
  </verify>
  <done>
API endpoint at GET /api/sidebar/counts returns `{ habits_incomplete, tasks_due }`. SWR hook `useSidebarCounts` fetches with 5-minute refresh and 1-minute dedup. API test suite covers auth, counts calculation, zero counts, and error handling.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add notification badges to AppSidebar nav items</name>
  <files>
    components/layouts/app-sidebar.tsx
    tests/components/layouts/app-sidebar.test.tsx
  </files>
  <action>
**Modify `components/layouts/app-sidebar.tsx`:**

1. Import `useSidebarCounts` from `@/lib/hooks/use-sidebar-counts`. Import `SidebarMenuBadge` (should already be imported from 07-01).

2. Call the hook at the top of the component: `const { habitsIncomplete, tasksDue } = useSidebarCounts();`.

3. Create a badge count map keyed by nav item labelKey:
   ```ts
   const badgeCounts: Record<string, number> = {
     habits: habitsIncomplete,
     tasks: tasksDue,
   };
   ```

4. Create a helper for display: `const formatBadge = (count: number) => count > 9 ? "9+" : String(count);`

5. In the nav item render loop for `mainNavItems`, after `</SidebarMenuButton>`, conditionally render the badge:
   ```tsx
   {badgeCounts[item.labelKey] > 0 && (
     <SidebarMenuBadge>{formatBadge(badgeCounts[item.labelKey])}</SidebarMenuBadge>
   )}
   ```

   This renders the badge as a sibling to `SidebarMenuButton` inside `SidebarMenuItem`, which is the correct shadcn pattern. `SidebarMenuBadge` auto-hides in icon mode via built-in CSS class `group-data-[collapsible=icon]:hidden`.

**Modify `tests/components/layouts/app-sidebar.test.tsx`:**

1. Mock `@/lib/hooks/use-sidebar-counts`:
   ```ts
   const mockUseSidebarCounts = vi.fn(() => ({ habitsIncomplete: 0, tasksDue: 0, isLoading: false, error: null, mutate: vi.fn() }));
   vi.mock("@/lib/hooks/use-sidebar-counts", () => ({
     useSidebarCounts: () => mockUseSidebarCounts(),
   }));
   ```

2. Add tests in a new `describe("notification badges")` block:

   - "shows habits badge when habitsIncomplete > 0": Set `mockUseSidebarCounts` to return `{ habitsIncomplete: 3, tasksDue: 0 }`. Render. Find badge with text "3" inside a `[data-testid="sidebar-menu-badge"]`.
   - "shows tasks badge when tasksDue > 0": Return `{ habitsIncomplete: 0, tasksDue: 5 }`. Assert badge with "5".
   - "hides badges when counts are 0": Return `{ habitsIncomplete: 0, tasksDue: 0 }`. Assert no `[data-testid="sidebar-menu-badge"]` elements in the document.
   - "caps badge display at 9+": Return `{ habitsIncomplete: 15, tasksDue: 0 }`. Assert badge shows "9+".
   - "does not show badge for dashboard": Return `{ habitsIncomplete: 3, tasksDue: 5 }`. Assert exactly 2 badges (habits + tasks, not dashboard).

3. Reset `mockUseSidebarCounts` in `beforeEach`.

Run `pnpm test:run -- tests/components/layouts/app-sidebar.test.tsx` and `pnpm lint`.
  </action>
  <verify>
Run `pnpm test:run -- tests/components/layouts/app-sidebar.test.tsx` -- all tests pass (existing + new badge tests). Run `pnpm test:run -- tests/app/api/sidebar/counts/route.test.ts` -- pass. Run `pnpm build` -- success. Run `pnpm lint` -- no errors.
  </verify>
  <done>
Habits and Tasks nav items display SidebarMenuBadge with live counts from useSidebarCounts hook. Badges hidden when count is 0. Display capped at "9+". Dashboard and Settings have no badges. All tests pass including new badge tests and existing nav/pin tests.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` completes without errors
2. `pnpm test:run -- tests/app/api/sidebar/counts/route.test.ts` -- all pass
3. `pnpm test:run -- tests/components/layouts/app-sidebar.test.tsx` -- all pass (including new badge tests)
4. `pnpm lint` -- no errors
5. GET /api/sidebar/counts returns correct counts
6. Habits and Tasks nav items show badges with live counts
7. Badges hidden when count is 0, capped at "9+"
</verification>

<success_criteria>
- Dedicated /api/sidebar/counts endpoint returns habits_incomplete and tasks_due counts
- useSidebarCounts SWR hook fetches with 5-min refresh and 1-min dedup
- Habits and Tasks nav items show numeric badges when count > 0
- Badges capped at "9+" display
- No badge on Dashboard or Settings
- API endpoint test covers auth, correct counts, zero counts, error
- AppSidebar test covers badge visibility, cap, and per-item correctness
</success_criteria>

<output>
After completion, create `.planning/phases/07-sidebar-enrichment/07-03-SUMMARY.md`
</output>
