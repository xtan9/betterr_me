---
phase: 06-dashboard-task-data-flow
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/db/tasks.ts
  - app/api/dashboard/route.ts
  - app/dashboard/page.tsx
  - tests/lib/db/tasks.test.ts
  - tests/app/api/dashboard/route.test.ts
autonomous: true
requirements:
  - TASK-01
  - TASK-02
  - TASK-03

must_haves:
  truths:
    - "getTodayTasks uses the client-sent date parameter, not server-local getLocalDateString()"
    - "getTodayTasks returns both completed and incomplete tasks (no is_completed filter)"
    - "Dashboard stats show correct 'X of Y completed' where Y includes completed tasks for today"
    - "A task due tomorrow does not appear in both today and tomorrow sections"
  artifacts:
    - path: "lib/db/tasks.ts"
      provides: "getTodayTasks with required date parameter"
      contains: "async getTodayTasks(userId: string, date: string)"
    - path: "app/api/dashboard/route.ts"
      provides: "Dashboard route passing client date to getTodayTasks"
      contains: "tasksDB.getTodayTasks(user.id, date)"
    - path: "app/dashboard/page.tsx"
      provides: "SSR page passing server date to getTodayTasks"
      contains: "tasksDB.getTodayTasks(user.id, date)"
    - path: "tests/lib/db/tasks.test.ts"
      provides: "Updated tests for new getTodayTasks signature"
    - path: "tests/app/api/dashboard/route.test.ts"
      provides: "Tests verifying date is passed to getTodayTasks and completed tasks are included"
  key_links:
    - from: "app/api/dashboard/route.ts"
      to: "lib/db/tasks.ts"
      via: "getTodayTasks(userId, date)"
      pattern: "tasksDB\\.getTodayTasks\\(user\\.id,\\s*date\\)"
    - from: "app/dashboard/page.tsx"
      to: "lib/db/tasks.ts"
      via: "getTodayTasks(userId, date)"
      pattern: "tasksDB\\.getTodayTasks\\(user\\.id,\\s*date\\)"
---

<objective>
Fix the three dashboard task display bugs: (1) getTodayTasks uses server-local time instead of client date, (2) completed tasks are excluded from today's task list causing wrong counts, and (3) tasks can duplicate across today/tomorrow sections due to timezone mismatch.

Purpose: Users see accurate task lists and correct "X of Y completed" counts regardless of their timezone relative to the server.
Output: Fixed getTodayTasks method, updated dashboard route and SSR page, updated tests.
</objective>

<execution_context>
@/home/xingdi/.claude/get-shit-done/workflows/execute-plan.md
@/home/xingdi/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@lib/db/tasks.ts
@app/api/dashboard/route.ts
@app/dashboard/page.tsx
@components/dashboard/tasks-today.tsx
@tests/lib/db/tasks.test.ts
@tests/app/api/dashboard/route.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix getTodayTasks to accept client date and return completed tasks</name>
  <files>lib/db/tasks.ts, app/api/dashboard/route.ts, app/dashboard/page.tsx</files>
  <action>
  Three changes to fix all three bugs at once (they share the same root cause):

  **1. lib/db/tasks.ts — getTodayTasks signature and query:**
  - Change `async getTodayTasks(userId: string)` to `async getTodayTasks(userId: string, date: string)`.
  - Remove the internal `const today = getLocalDateString();` call — use the `date` parameter instead.
  - Remove `.eq('is_completed', false)` from the query. The method should return BOTH completed and incomplete tasks for today (due_date <= date). The component already sorts completed tasks to the bottom.
  - The query becomes: `.eq('user_id', userId).lte('due_date', date).not('due_date', 'is', null).order('due_date', { ascending: true })`.
  - Remove the `import { getLocalDateString } from '@/lib/utils';` if no other method in the file uses it. Check: getUpcomingTasks and getOverdueTasks also use it — leave the import.

  **2. app/api/dashboard/route.ts — pass date to getTodayTasks:**
  - Change `tasksDB.getTodayTasks(user.id)` to `tasksDB.getTodayTasks(user.id, date)`.
  - Remove the separate `tasksDB.getTaskCount(user.id, { due_date: date, is_completed: true })` call — we no longer need it because todayTasks now contains both completed and incomplete tasks.
  - Remove the `tasksDB.getTaskCount(user.id)` call (total_tasks) — keep it, this is the global task count unrelated to today.
  - Actually, keep both getTaskCount calls as they are. The `tasks_completed_today` stat is already used by DailySnapshot. But update `tasks_due_today` to use `todayTasks.length` (which now includes completed), and `tasks_completed_today` can be computed from `todayTasks.filter(t => t.is_completed).length` instead of a separate DB call. This eliminates one DB call.
  - Updated Promise.all: remove `tasksCompletedTodayCount` from the parallel queries. Compute it after: `const tasksCompletedToday = todayTasks.filter(t => t.is_completed).length;`.
  - Update stats: `tasks_due_today: todayTasks.length, tasks_completed_today: tasksCompletedToday`.

  **3. app/dashboard/page.tsx — SSR page passes date:**
  - Change `tasksDB.getTodayTasks(user.id)` to `tasksDB.getTodayTasks(user.id, date)`.
  - Remove the `tasksDB.getTaskCount(user.id, { due_date: date, is_completed: true })` call and compute `tasksCompletedTodayCount` from `todayTasks.filter(t => t.is_completed).length` instead, matching the API route pattern.
  - Update the Promise.all to remove the completed count query.
  </action>
  <verify>
  - `pnpm build` succeeds (no type errors from signature change).
  - Grep `getTodayTasks` across the codebase — every call site passes two arguments.
  - Grep for `getLocalDateString` in `lib/db/tasks.ts` — still present (used by getUpcomingTasks/getOverdueTasks).
  - Grep for `is_completed.*false` in `getTodayTasks` method — should NOT be found.
  </verify>
  <done>
  getTodayTasks(userId, date) accepts and uses client date. It returns both completed and incomplete tasks. The dashboard API route and SSR page both pass the date parameter. No duplicate DB call for completed count.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update tests for new getTodayTasks behavior and dashboard route changes</name>
  <files>tests/lib/db/tasks.test.ts, tests/app/api/dashboard/route.test.ts</files>
  <action>
  **1. tests/lib/db/tasks.test.ts — update getTodayTasks tests:**
  - Update the existing `getTodayTasks` test: call `tasksDB.getTodayTasks(mockUserId, '2026-01-31')` (two args).
  - Verify that `mockSupabaseClient.eq` is NOT called with `('is_completed', false)` — since we removed that filter.
  - Verify that `mockSupabaseClient.lte` is called (due_date <= date). The mock chain should show `lte` was called.
  - Add a test: "should use the provided date parameter instead of server time" — call with a specific date string, verify it is passed through to `.lte('due_date', '2026-06-15')` (or similar).
  - Add a test: "should return both completed and incomplete tasks" — set mock response with a mix of completed/incomplete tasks, verify all are returned.

  **2. tests/app/api/dashboard/route.test.ts — update dashboard route tests:**
  - Update `mockTasksDB` — `getTodayTasks` now takes two args. Update all `mockTasksDB.getTodayTasks.mockResolvedValue(...)` calls.
  - Add assertion in the "should accept a date parameter" test: verify `mockTasksDB.getTodayTasks` was called with `('user-123', '2026-02-01')`.
  - The main aggregated test should verify that `tasks_completed_today` is derived from todayTasks (not from a separate getTaskCount call). Update the mock setup: `getTaskCount` is now called once (for total_tasks only), not twice.
  - Add a test: "should pass client date to getTodayTasks" — request with `?date=2026-03-15`, verify `getTodayTasks` called with `('user-123', '2026-03-15')`.
  - Add a test: "should include completed tasks in tasks_today" — mock `getTodayTasks` to return mix of completed/incomplete, verify response `tasks_today` contains both, and `stats.tasks_completed_today` counts only completed ones.
  - Update getTaskCount mock setup in all tests: it is now called once (total_tasks), not twice.

  Run `pnpm test:run` after all changes — all tests must pass. Fix any failures.
  </action>
  <verify>
  `pnpm test:run -- tests/lib/db/tasks.test.ts tests/app/api/dashboard/route.test.ts` — all tests pass, no failures.
  </verify>
  <done>
  All task DB tests and dashboard route tests updated for new getTodayTasks(userId, date) signature. Tests verify: date parameter is passed through, completed tasks are included, stats are correctly derived, no duplicate getTaskCount calls.
  </done>
</task>

</tasks>

<verification>
1. `pnpm test:run` — all tests pass (including the updated task/dashboard tests).
2. `pnpm lint` — no lint errors.
3. `pnpm build` — production build succeeds.
4. Manual verification checklist:
   - `getTodayTasks` in `lib/db/tasks.ts` accepts `(userId, date)` and has NO `is_completed: false` filter.
   - `app/api/dashboard/route.ts` calls `getTodayTasks(user.id, date)` and computes `tasks_completed_today` from the returned array.
   - `app/dashboard/page.tsx` calls `getTodayTasks(user.id, date)`.
   - No call site passes zero or one argument to `getTodayTasks`.
</verification>

<success_criteria>
- getTodayTasks uses client-sent date parameter, not server getLocalDateString()
- getTodayTasks returns both completed and incomplete tasks for today
- Dashboard shows correct "X of Y completed" count including completed tasks
- Tasks due tomorrow do not duplicate into today's list (timezone mismatch eliminated)
- All existing and new tests pass
- No lint errors, build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/06-dashboard-task-data-flow/06-01-SUMMARY.md`
</output>
